<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lifecycle Marketing Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --brand: #818cf8;
            --brand-light: #312e81;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 24px; }
        header h1 { font-size: 18px; font-weight: 700; }
        header p { color: var(--muted); font-size: 13px; margin-top: 2px; }

        nav { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; display: flex; overflow-x: auto; }
        nav button { background: none; border: none; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--muted); border-bottom: 2px solid transparent; transition: all 0.15s; white-space: nowrap; }
        nav button.active { color: var(--brand); border-bottom-color: var(--brand); }
        nav button:hover:not(.active) { color: var(--text); }

        main { padding: 24px; max-width: 1400px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        h2 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 16px; }
        .card-flush { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 0; margin-bottom: 16px; overflow: hidden; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

        .field { margin-bottom: 14px; }
        .field label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.04em; }
        .field input, .field select, .field textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit; outline: none; background: var(--surface); color: var(--text); transition: border-color 0.15s; }
        .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--brand); }
        .field textarea { resize: vertical; min-height: 80px; }

        .btn { padding: 9px 18px; border-radius: 6px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.15s; }
        .btn-primary { background: var(--brand); color: white; }
        .btn-primary:hover { opacity: 0.85; }
        .btn-sm { padding: 6px 12px; font-size: 12px; background: #334155; border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; }

        .alert { padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 14px; }
        .alert-success { background: #064e3b; color: #6ee7b7; }
        .alert-error { background: #7f1d1d; color: #fca5a5; }
        .alert-info { background: var(--brand-light); color: #a5b4fc; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); border-bottom: 1px solid var(--border); background: #0f172a; }
        td { padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background: #263347; }

        .badge { display: inline-block; padding: 2px 9px; border-radius: 999px; font-size: 11px; font-weight: 600; }
        .badge-Launches          { background: #1e3a5f; color: #93c5fd; }
        .badge-Early-lifecycle   { background: #064e3b; color: #6ee7b7; }
        .badge-Usage             { background: #451a03; color: #fcd34d; }
        .badge-Events            { background: #4a1942; color: #f9a8d4; }
        .badge-Acquisition   { background: #0f2d3d; color: #7dd3fc; }
        .badge-Adhoc         { background: #2d1f3d; color: #d8b4fe; }
        .badge-Expansion     { background: #1a3a2a; color: #86efac; }
        .badge-Fin-SA        { background: #3d1515; color: #fca5a5; }
        .badge-Migrations    { background: #2a1f00; color: #fde68a; }
        .badge-Newsletter    { background: #1e2a3d; color: #93c5fd; }
        .badge-Ops           { background: #1e1e2e; color: #94a3b8; }

        .bench-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .bench-cat { margin-bottom: 12px; }
        .bench-metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .bench-metric { text-align: center; }
        .bench-metric .label { font-size: 11px; color: var(--muted); }
        .bench-metric .value { font-size: 22px; font-weight: 700; color: var(--brand); }

        .filters { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input[type="text"] { padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--surface); color: var(--text); }
        .filters span { color: var(--muted); font-size: 13px; }

        .inner-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .inner-tabs button { background: none; border: none; padding: 8px 14px; cursor: pointer; font-size: 13px; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -1px; }
        .inner-tabs button.active { color: var(--brand); border-bottom-color: var(--brand); font-weight: 600; }

        .winner-a { color: var(--success); font-weight: 700; }
        .winner-b { color: var(--brand); font-weight: 700; }

        .prompt-box { background: #0f172a; color: #e2e8f0; border-radius: 8px; padding: 20px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.7; white-space: pre-wrap; margin-top: 12px; max-height: 420px; overflow-y: auto; border: 1px solid var(--border); }
        /* â”€â”€ REPORT OUTPUT â”€â”€ */
        .report-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .report-kpi { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; }
        .report-kpi-val { font-size: 22px; font-weight: 700; margin-bottom: 2px; }
        .report-kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .report-kpi-bench { font-size: 11px; margin-top: 4px; }
        .report-section { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 20px 24px; margin-bottom: 16px; }
        .report-section h3 { font-size: 11px; font-weight: 700; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); }
        .report-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--border); gap: 12px; }
        .report-row:last-child { border-bottom: none; }
        .report-row-metrics { display: flex; gap: 20px; text-align: right; flex-shrink: 0; }
        .report-metric-val { font-size: 13px; font-weight: 600; }
        .report-metric-label { font-size: 11px; color: var(--muted); }
        .bench-up { color: var(--success); }
        .bench-down { color: #fca5a5; }
        .slack-box { background: #1a1d21; border: 1px solid #444; border-radius: 8px; padding: 16px; font-family: monospace; font-size: 13px; white-space: pre-wrap; line-height: 1.7; color: #d1d2d3; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .empty { text-align: center; padding: 48px; color: var(--muted); }
        .empty strong { display: block; margin-bottom: 6px; }

        /* â”€â”€ CAMPAIGN CALENDAR â”€â”€ */
        .cal-nav { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .cal-nav-label { font-size: 14px; font-weight: 600; color: var(--muted); flex: 1; text-align: center; }
        .cal-3month { display: flex; flex-direction: column; gap: 32px; }
        .cal-month-block { width: 100%; }
        .cal-month-title { font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--text); padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; }
        .cal-day-header { background: #0f172a; padding: 10px 8px; text-align: center; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); min-width: 0; }
        .cal-day { background: var(--surface); min-height: 110px; padding: 8px; vertical-align: top; min-width: 0; overflow: hidden; }
        .cal-day.other-month { background: #0b1222; }
        .cal-day.other-month .cal-date { color: #3b4f68; }
        .cal-day.today { background: #1a2744; }
        .cal-date { font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--muted); }
        .cal-date-today { background: var(--brand); color: white; border-radius: 999px; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; }
        .cal-event { font-size: 11px; padding: 3px 7px; border-radius: 4px; margin-bottom: 3px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; line-height: 1.5; display: block; width: 100%; box-sizing: border-box; }
        .cal-event-Launches        { background: #1e3a5f; color: #93c5fd; }
        .cal-event-Earlylifecycle  { background: #064e3b; color: #6ee7b7; }
        .cal-event-Usage           { background: #451a03; color: #fcd34d; }
        .cal-event-Events          { background: #4a1942; color: #f9a8d4; }
        .cal-event-Acquisition  { background: #0f2d3d; color: #7dd3fc; }
        .cal-event-Adhoc        { background: #2d1f3d; color: #d8b4fe; }
        .cal-event-Expansion    { background: #1a3a2a; color: #86efac; }
        .cal-event-FinSA        { background: #3d1515; color: #fca5a5; }
        .cal-event-Migrations   { background: #2a1f00; color: #fde68a; }
        .cal-event-Newsletter   { background: #1e2a3d; color: #93c5fd; }
        .cal-event-Ops          { background: #1e1e2e; color: #94a3b8; }
        .cal-event-default      { background: #334155; color: #e2e8f0; }
        .cal-layout { display: flex; gap: 24px; align-items: flex-start; }
        .cal-main { flex: 1; min-width: 0; }
        .cal-legend { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; padding-top: 4px; position: sticky; top: 16px; align-self: flex-start; }
        .cal-legend > span:first-child { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-bottom: 4px; }
        .cal-legend span { font-size: 12px; color: var(--muted); }

        /* â”€â”€ CALENDAR TOOLTIP â”€â”€ */
        #cal-tooltip { position: fixed; background: #0f172a; color: #e2e8f0; border: 1px solid var(--border); border-radius: 6px; padding: 7px 11px; font-size: 12px; max-width: 300px; pointer-events: none; z-index: 200; line-height: 1.5; box-shadow: 0 8px 24px rgba(0,0,0,0.5); display: none; }

        /* â”€â”€ CAMPAIGN DETAIL MODAL â”€â”€ */
        #cal-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; }
        #cal-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 101; width: 580px; max-width: 94vw; display: none; }
        #cal-modal .card { margin: 0; max-height: 88vh; overflow-y: auto; }
        /* â”€â”€ A/B TEST DETAIL MODAL â”€â”€ */
        #ab-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; }
        #ab-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 101; width: 640px; max-width: 94vw; display: none; }
        #ab-modal .card { margin: 0; max-height: 88vh; overflow-y: auto; }
        /* â”€â”€ LOG CAMPAIGN MODAL â”€â”€ */
        #log-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; }
        #log-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 101; width: 640px; max-width: 94vw; display: none; }
        #log-modal .card { margin: 0; max-height: 88vh; overflow-y: auto; }
        .abt-variant-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
        .abt-winner-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 12px 0; }
        .cm-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 16px; }
        .cm-title { font-size: 16px; font-weight: 700; line-height: 1.45; }
        .cm-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 22px; line-height: 1; flex-shrink: 0; padding: 0; }
        .cm-close:hover { color: var(--text); }
        .cm-row { display: flex; gap: 12px; margin-bottom: 10px; font-size: 13px; align-items: baseline; }
        .cm-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); min-width: 72px; flex-shrink: 0; }
        .cm-value { color: var(--text); line-height: 1.5; }
        .cm-divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
        /* â”€â”€ CLICKABLE TABLE ROWS â”€â”€ */
        tbody tr.clickable { cursor: pointer; }
        tbody tr.clickable:hover td { background: #263347; }

        /* â”€â”€ CSV IMPORT â”€â”€ */
        .csv-toggle { background: none; border: none; color: var(--brand); font-size: 12px; font-weight: 600; cursor: pointer; padding: 0; letter-spacing: 0.01em; }
        .csv-toggle:hover { text-decoration: underline; }
        .csv-import-body { margin-top: 10px; }
        .csv-import-body > p { font-size: 12px; color: var(--muted); margin-bottom: 10px; line-height: 1.5; }
        .drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 22px 16px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--brand); background: rgba(129,140,248,0.06); }
        .drop-zone-icon { font-size: 22px; margin-bottom: 6px; }
        .drop-zone-text { font-size: 13px; color: var(--muted); }
        .drop-zone-text u { color: var(--brand); cursor: pointer; }
        .drop-zone-filename { font-size: 12px; color: var(--success); margin-top: 6px; font-weight: 600; }
        .ab-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-top: 10px; }
        .ab-box-title { font-size: 12px; font-weight: 700; color: var(--brand); margin-bottom: 10px; }
        .ab-variant { padding: 8px 0; border-bottom: 1px solid var(--border); }
        .ab-variant:last-of-type { border-bottom: none; padding-bottom: 0; }
        .ab-variant-name { font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 3px; }
        .ab-variant-stats { font-size: 12px; color: var(--muted); }
        .ab-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; align-items: center; }
        /* â”€â”€ AB METRICS TABLE â”€â”€ */
        .mf-ab-badge { font-size: 11px; font-weight: 700; color: var(--brand); margin-left: 6px; }
        .mf-table-ab .mf-input { width: 85px; }
        .mf-th-a { color: var(--brand) !important; }
        .mf-th-b { color: #86efac !important; }
        .mf-rate-b { font-size: 14px; font-weight: 700; color: #86efac; min-width: 60px; display: inline-block; }

        /* â”€â”€ METRICS FORM â”€â”€ */
        .mf-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .mf-table th { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); padding: 0 8px 8px 0; text-align: left; }
        .mf-table th:last-child { text-align: right; }
        .mf-table td { padding: 4px 8px 4px 0; vertical-align: middle; }
        .mf-table td:last-child { text-align: right; }
        .mf-row-label { font-size: 12px; font-weight: 600; color: var(--muted); white-space: nowrap; }
        .mf-input { width: 110px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; text-align: right; }
        .mf-input:focus { outline: none; border-color: var(--brand); }
        .mf-rate { font-size: 14px; font-weight: 700; color: var(--brand); min-width: 60px; display: inline-block; }
        .mf-sub { font-size: 11px; color: var(--muted); margin-top: 1px; }

        /* â”€â”€ CODA SYNC â”€â”€ */
        .sync-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px; }
        .sync-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; gap: 12px; }
        .sync-row:last-child { border-bottom: none; }
        .sync-row-name { flex: 1; font-weight: 600; }
        .sync-row-meta { color: var(--muted); font-size: 12px; display: flex; gap: 12px; }
        .sync-skip { color: #475569; font-size: 11px; font-style: italic; }

        /* â”€â”€ INSPIRATION BOARD â”€â”€ */
        .insp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
        .insp-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: border-color 0.15s; }
        .insp-card:hover { border-color: var(--brand); }
        .insp-card-img { width: 100%; height: 200px; object-fit: cover; object-position: top; background: var(--bg); display: block; cursor: zoom-in; }
        .insp-card-body { padding: 12px; }
        .insp-card-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .insp-card-source { font-weight: 700; font-size: 13px; }
        .insp-card-notes { font-size: 12px; color: var(--muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .insp-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border); }
        .insp-upload-area { border: 2px dashed var(--border); border-radius: 8px; padding: 48px 24px; text-align: center; cursor: pointer; transition: border-color 0.15s, background 0.15s; color: var(--muted); }
        .insp-upload-area:hover, .insp-upload-area.drag-over { border-color: var(--brand); background: rgba(129,140,248,0.05); color: var(--text); }
        .insp-preview { width: 100%; max-height: 220px; object-fit: cover; object-position: top; border-radius: 6px; margin-top: 12px; display: none; }
        #insp-lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 300; display: none; align-items: center; justify-content: center; cursor: zoom-out; }
        #insp-lightbox.open { display: flex; }
        #insp-lightbox img { max-width: 92vw; max-height: 90vh; border-radius: 6px; box-shadow: 0 8px 40px rgba(0,0,0,0.6); }

        /* â”€â”€ EXPERIMENT BACKLOG â”€â”€ */
        .ai-suggest-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; margin-top: 12px; }
        .ai-suggest-card { background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--brand); border-radius: 8px; padding: 14px; display: flex; flex-direction: column; }
        .ai-suggest-rationale { font-size: 11px; color: var(--muted); line-height: 1.55; margin-top: 6px; flex: 1; }
        .backlog-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: start; }
        .backlog-col { background: #0b1222; border-radius: 8px; padding: 12px; }
        .backlog-col-header { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .backlog-col-header .count { background: #1e293b; border: 1px solid var(--border); border-radius: 999px; padding: 1px 8px; font-size: 11px; }
        .backlog-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .backlog-hypothesis { font-size: 13px; line-height: 1.5; margin-bottom: 8px; }
        .backlog-meta { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-top: 6px; }
        .backlog-element { font-size: 11px; color: var(--muted); background: #334155; padding: 2px 7px; border-radius: 4px; }
        .backlog-context { font-size: 11px; color: var(--muted); font-style: italic; }
        .backlog-move-btn { font-size: 11px; color: var(--brand); background: none; border: none; cursor: pointer; padding: 0; margin-top: 8px; display: block; }
        .backlog-move-btn:hover { text-decoration: underline; }
        .priority-High   { background: #7f1d1d; color: #fca5a5; padding: 2px 7px; border-radius: 999px; font-size: 11px; font-weight: 600; }
        .priority-Medium { background: #451a03; color: #fcd34d; padding: 2px 7px; border-radius: 999px; font-size: 11px; font-weight: 600; }
        .priority-Low    { background: #1e3a5f; color: #93c5fd; padding: 2px 7px; border-radius: 999px; font-size: 11px; font-weight: 600; }

        /* â”€â”€ CAMPAIGN LIBRARY ENHANCEMENTS â”€â”€ */
        .lib-summary { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 14px; }
        .lib-kpis { display: flex; flex-wrap: wrap; gap: 0; margin-bottom: 12px; }
        .lib-kpi { flex: 1; padding: 4px 16px; border-right: 1px solid var(--border); text-align: center; }
        .lib-kpi:first-child { padding-left: 0; text-align: left; }
        .lib-kpi:last-child { border-right: none; }
        .lib-kpi-val { font-size: 20px; font-weight: 700; }
        .lib-kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1px; }
        .lib-cat-row { display: flex; flex-wrap: wrap; gap: 6px; padding-top: 12px; border-top: 1px solid var(--border); }
        .cell-hot  { color: #4ade80 !important; font-weight: 600; }
        .cell-cold { color: #fca5a5 !important; }
        th.sortable { cursor: pointer; user-select: none; white-space: nowrap; }
        th.sortable:hover { color: var(--text); }
        th.sort-asc::after  { content: ' â†‘'; color: var(--brand); }
        th.sort-desc::after { content: ' â†“'; color: var(--brand); }

        @media (max-width: 1000px) { .backlog-board { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .backlog-board { grid-template-columns: 1fr; }
        }
        /* â”€â”€ DASHBOARD UPGRADE â”€â”€ */
        .dash-kpi-strip { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
        .dash-kpi { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:16px 18px; }
        .dash-kpi .kpi-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); margin-bottom:8px; }
        .dash-kpi .kpi-value { font-size:26px; font-weight:800; color:var(--text); line-height:1.1; }
        .dash-kpi .kpi-sub { font-size:12px; margin-top:6px; }
        .kpi-up { color:#4ade80; } .kpi-down { color:#fca5a5; } .kpi-flat { color:var(--muted); }
        .dash-grid-2 { display:grid; grid-template-columns:3fr 2fr; gap:16px; }
        .dash-section-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); margin-bottom:10px; margin-top:4px; }
        .dash-stat-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:16px; }
        .dash-stat-row { display:grid; gap:8px; margin-bottom:10px; }
        .dash-stat { text-align:center; }
        .dash-stat .sv { font-size:22px; font-weight:800; color:var(--text); line-height:1.1; }
        .dash-stat .sl { font-size:11px; color:var(--muted); margin-top:3px; }
        .launch-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:10px; }
        .launch-card-d { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:12px 14px; cursor:pointer; transition:border-color 0.15s; }
        .launch-card-d:hover { border-color:var(--brand); }
        .launch-card-d .lc-name { font-weight:600; font-size:13px; margin-bottom:8px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .launch-card-d .lc-dates { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
        .lc-date-chip { font-size:11px; background:rgba(255,255,255,0.05); border-radius:4px; padding:2px 8px; color:var(--muted); }
        .lc-date-chip span { color:var(--text); font-weight:600; }

        /* â”€â”€ PRODUCT UPDATES â”€â”€ */
        .pu-type { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:700; white-space:nowrap; }
        .pu-type-new       { background:#1e3a5f; color:#93c5fd; }
        .pu-type-existing  { background:#1a2f1a; color:#86efac; }
        .pu-type-pricing   { background:#3b1f5e; color:#c4b5fd; }
        .pu-type-billing   { background:#3b2a0f; color:#fcd34d; }
        .pu-type-other     { background:#1e293b; color:#94a3b8; }
        .pu-stage { display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap; }
        .pu-stage-ga     { background:#064e3b; color:#6ee7b7; }
        .pu-stage-beta   { background:#1e3a5f; color:#93c5fd; }
        .pu-stage-build  { background:#2d1b00; color:#fbbf24; }
        .pu-stage-early  { background:#3b1f5e; color:#c4b5fd; }
        .pu-stage-other  { background:#1e293b; color:#94a3b8; }
        .pu-ui-full    { color:#fca5a5; font-size:12px; font-weight:600; }
        .pu-ui-partial { color:#fcd34d; font-size:12px; font-weight:600; }
        .pu-ui-none    { color:#94a3b8; font-size:12px; }
        .pu-detail-row { display:flex; gap:8px; flex-wrap:wrap; }
        .pu-detail-item { flex:1; min-width:140px; background:var(--surface); border-radius:6px; padding:10px 12px; }
        .pu-detail-item .label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); margin-bottom:4px; }
        .pu-detail-item .value { font-size:13px; color:var(--text); }
        .pu-description { background:var(--surface); border-radius:6px; padding:12px; font-size:13px; line-height:1.6; color:var(--text); white-space:pre-wrap; }
        .pu-recent-header { display:grid; grid-template-columns:16px 2fr 120px 110px 140px 90px 90px 90px 90px; gap:10px; align-items:center; padding:4px 14px 6px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); }
        .pu-recent-card { display:grid; grid-template-columns:16px 2fr 120px 110px 140px 90px 90px 90px 90px; gap:10px; align-items:center; background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:10px 14px; cursor:pointer; transition:border-color 0.15s; }
        .pu-recent-card:hover { border-color:var(--brand); }
        .pu-recent-card.is-new { border-left:3px solid var(--brand); }
        .pu-recent-name { font-weight:600; font-size:13px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .pu-recent-meta { font-size:12px; color:var(--muted); white-space:nowrap; }
        .pu-new-pill { font-size:10px; font-weight:700; background:var(--brand); color:#fff; border-radius:4px; padding:1px 5px; width:16px; text-align:center; }
    </style>
</head>
<body>

<header>
    <h1>Lifecycle Marketing Hub</h1>
    <p>Email campaigns &middot; A/B tests &middot; Reporting</p>
</header>

<nav>
    <button class="active" data-tab="dashboard">Dashboard</button>
    <button data-tab="library">Campaign Library</button>
    <button data-tab="calendar">Calendar</button>
    <button data-tab="swipe">Email Inspo</button>
    <button data-tab="backlog">Experiment Backlog</button>
    <button data-tab="abtests">A/B Tests</button>
    <button data-tab="reports">Generate Report</button>
    <button data-tab="productupdates">Product Updates</button>
    <button data-tab="seriesreplies">Series Replies</button>
</nav>

<main>

    <!-- DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">

        <!-- KPI Strip -->
        <div class="dash-kpi-strip">
            <div class="dash-kpi">
                <div class="kpi-label">Emails Sent Q1</div>
                <div class="kpi-value" id="kpi-sent">â€”</div>
                <div class="kpi-sub" id="kpi-sent-delta"></div>
            </div>
            <div class="dash-kpi">
                <div class="kpi-label">Avg Open Rate Q1</div>
                <div class="kpi-value" id="kpi-open">â€”</div>
                <div class="kpi-sub" id="kpi-open-delta"></div>
            </div>
            <div class="dash-kpi">
                <div class="kpi-label">Avg Click Rate Q1</div>
                <div class="kpi-value" id="kpi-click">â€”</div>
                <div class="kpi-sub" id="kpi-click-delta"></div>
            </div>
            <div class="dash-kpi">
                <div class="kpi-label">Avg CTOR Q1</div>
                <div class="kpi-value" id="kpi-ctor">â€”</div>
                <div class="kpi-sub" id="kpi-ctor-delta"></div>
            </div>
        </div>

        <!-- Benchmarks by Category -->
        <div class="dash-section-label">Benchmarks by Category</div>
        <div id="bench-grid" class="grid-3" style="margin-bottom:20px;"></div>

        <!-- Two-column: Top Performers + Side cards -->
        <div class="dash-grid-2" style="margin-bottom:20px;">
            <div>
                <div class="dash-section-label">Top Performers This Quarter</div>
                <div class="card-flush">
                    <table>
                        <thead><tr><th>Campaign</th><th>Category</th><th>Sent</th><th>Open %</th><th>Click %</th><th>CTOR %</th></tr></thead>
                        <tbody id="dash-top-body"><tr><td colspan="6" class="empty">Loadingâ€¦</td></tr></tbody>
                    </table>
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:14px;">
                <div>
                    <div class="dash-section-label">A/B Tests Q1</div>
                    <div id="dash-ab-card" class="dash-stat-card"><div class="empty" style="padding:16px;">Loadingâ€¦</div></div>
                </div>
                <div>
                    <div class="dash-section-label">Experiment Pipeline</div>
                    <div id="dash-backlog-card" class="dash-stat-card"><div class="empty" style="padding:16px;">Loadingâ€¦</div></div>
                </div>
            </div>
        </div>

        <!-- Upcoming Product Launches -->
        <div style="margin-bottom:20px;">
            <div class="dash-section-label">Upcoming Product Launches â€” Next 30 Days</div>
            <div id="dash-upcoming"><div style="color:var(--muted);font-size:13px;">Loadingâ€¦</div></div>
        </div>

    </div>

    <!-- LOG CAMPAIGN -->
    <!-- CAMPAIGN LIBRARY -->
    <div id="tab-library" class="tab-content">
        <div class="section-header"><h2>Campaign Library</h2><button class="btn btn-primary" onclick="openLogModal()">+ Log Campaign</button></div>
        <div class="filters">
            <select id="filter-cat" onchange="loadLibrary()">
                <option value="">All Categories</option>
                <option>Product Launch</option><option>Onboarding</option><option>Nurture</option>
                <option>Event</option><option>Acquisition</option><option>Adhoc</option>
                <option>Expansion</option><option>Fin SA</option><option>Migrations</option>
                <option>Newsletter</option><option>Ops</option>
            </select>
            <input type="text" id="lib-search" placeholder="Search campaignsâ€¦" oninput="renderLibrary()" style="min-width:200px;">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);">
                From
                <input type="date" id="filter-from" value="2026-02-01" onchange="loadLibrary()" style="padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:13px;background:var(--surface);color:var(--text);">
                <button onclick="resetLibraryDate()" style="font-size:11px;color:var(--brand);background:none;border:none;cursor:pointer;padding:0;text-decoration:underline;white-space:nowrap;">â†º Q1</button>
            </label>
            <span id="library-count" style="color:var(--muted);font-size:12px;"></span>
        </div>
        <div id="lib-summary" class="lib-summary" style="display:none;"></div>
        <div class="card-flush">
            <table>
                <thead><tr>
                    <th>Campaign</th>
                    <th>Category</th>
                    <th class="sortable" data-col="send_date" onclick="sortLibrary('send_date')">Date</th>
                    <th class="sortable" data-col="emails_sent" onclick="sortLibrary('emails_sent')">Sent</th>
                    <th class="sortable" data-col="open_rate" onclick="sortLibrary('open_rate')">Open %</th>
                    <th class="sortable" data-col="click_rate" onclick="sortLibrary('click_rate')">Click %</th>
                    <th class="sortable" data-col="click_to_open_rate" onclick="sortLibrary('click_to_open_rate')">CTOR %</th>
                    <th>Unsub %</th>
                </tr></thead>
                <tbody id="library-body"><tr><td colspan="8" class="empty">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- CAMPAIGN CALENDAR -->
    <div id="tab-calendar" class="tab-content">
        <div class="section-header" style="margin-bottom:16px;">
            <h2>Campaign Calendar</h2>
            <button class="btn btn-primary" onclick="syncFromCoda()">&#8595; Sync from Coda</button>
        </div>
        <div id="coda-sync-panel" style="display:none;"></div>
        <div class="cal-layout">
            <div class="cal-legend">
                <span>Legend</span>
                <span class="cal-event cal-event-Launches">Launches</span>
                <span class="cal-event cal-event-Earlylifecycle">Early lifecycle</span>
                <span class="cal-event cal-event-Usage">Usage</span>
                <span class="cal-event cal-event-Events">Events</span>
                <span class="cal-event cal-event-Acquisition">Acquisition</span>
                <span class="cal-event cal-event-Adhoc">Adhoc</span>
                <span class="cal-event cal-event-Expansion">Expansion</span>
                <span class="cal-event cal-event-FinSA">Fin SA</span>
                <span class="cal-event cal-event-Migrations">Migrations</span>
                <span class="cal-event cal-event-Newsletter">Newsletter</span>
                <span class="cal-event cal-event-Ops">Ops</span>
            </div>
            <div class="cal-main">
                <div class="cal-nav">
                    <button class="btn-sm" onclick="changeMonth(-1)">&#8592; Prev</button>
                    <button class="btn-sm" onclick="changeMonth(0)">Today</button>
                    <span class="cal-nav-label" id="cal-nav-label"></span>
                    <button class="btn-sm" onclick="changeMonth(1)">Next &#8594;</button>
                </div>
                <div class="cal-3month" id="cal-container"></div>
            </div>
        </div>
    </div>

    <!-- INSPIRATION BOARD -->
    <div id="tab-swipe" class="tab-content">
        <div class="section-header">
            <h2>Email Inspo</h2>
            <button class="btn btn-primary" onclick="toggleInspForm()">+ Add screenshot</button>
        </div>

        <!-- Add form -->
        <div id="insp-form" style="display:none;margin-bottom:20px;">
            <div class="card">
                <div class="grid-2">
                    <div>
                        <div class="field"><label>Screenshot *</label>
                            <div class="insp-upload-area" id="insp-drop-zone" onclick="document.getElementById('insp-file-input').click()">
                                <div style="font-size:28px;margin-bottom:8px;">ðŸ“·</div>
                                <div style="font-weight:600;margin-bottom:4px;">Click to upload or drag & drop</div>
                                <div style="font-size:12px;">PNG, JPG, WEBP â€” max 8MB</div>
                            </div>
                            <input type="file" id="insp-file-input" accept="image/*" style="display:none;" onchange="previewInspImage(this)">
                            <img id="insp-preview" class="insp-preview" alt="preview">
                        </div>
                        <div class="field"><label>Brand / Source *</label><input id="insp-source" type="text" placeholder="e.g. Notion, Linear, Stripe, Competitor X"></div>
                    </div>
                    <div>
                        <div class="field"><label>Email Type</label>
                            <select id="insp-type">
                                <option value="">Select...</option>
                                <option>Onboarding</option><option>Promotional</option><option>Newsletter</option>
                                <option>Re-engagement</option><option>Transactional</option><option>Event</option>
                                <option>Upsell</option><option>Product Update</option><option>Other</option>
                            </select>
                        </div>
                        <div class="field"><label>Lifecycle Category</label>
                            <select id="insp-category">
                                <option value="">Select...</option>
                                <option>Launches</option><option>Early lifecycle</option><option>Usage</option>
                                <option>Events</option><option>Acquisition</option><option>Adhoc</option>
                                <option>Expansion</option><option>Fin SA</option><option>Migrations</option>
                                <option>Newsletter</option>
                            </select>
                        </div>
                        <div class="field"><label>What do you like about it?</label>
                            <textarea id="insp-notes" placeholder="e.g. Great subject line curiosity gap, clean single-CTA layout, strong social proof..." style="min-height:100px;"></textarea>
                        </div>
                        <div id="insp-alert"></div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <button class="btn btn-primary" onclick="saveInspiration()">Save</button>
                            <button class="btn-sm" onclick="toggleInspForm()">Cancel</button>
                            <span id="insp-save-msg" style="font-size:12px;color:var(--success);"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <select id="insp-filter-type" onchange="loadInspiration()">
                <option value="">All types</option>
                <option>Onboarding</option><option>Promotional</option><option>Newsletter</option>
                <option>Re-engagement</option><option>Transactional</option><option>Event</option>
                <option>Upsell</option><option>Product Update</option><option>Other</option>
            </select>
            <input type="text" id="insp-search" placeholder="Search source or notes..." oninput="loadInspiration()" style="min-width:200px;">
            <span id="insp-count" style="color:var(--muted);font-size:13px;"></span>
        </div>

        <div id="insp-grid" class="insp-grid"></div>
    </div>

    <!-- Lightbox -->
    <div id="insp-lightbox" onclick="closeInspLightbox()">
        <img id="insp-lightbox-img" src="" alt="">
    </div>

    <!-- EXPERIMENT BACKLOG -->
    <div id="tab-backlog" class="tab-content">
        <div class="section-header">
            <h2>Experiment Backlog</h2>
            <button class="btn btn-primary" onclick="toggleBacklogForm()">+ New Idea</button>
        </div>
        <div id="backlog-alert"></div>

        <div id="backlog-add-form" style="display:none; margin-bottom:20px;">
            <div class="card">
                <div class="grid-2">
                    <div>
                        <div class="field"><label>Hypothesis *</label><textarea id="bl-hyp" placeholder="e.g. A curiosity-gap subject line will lift opens vs a benefit-led one for re-engagement emails"></textarea></div>
                        <div class="field"><label>Element to Test</label>
                            <select id="bl-element">
                                <option>Subject Line</option><option>Preview Text</option><option>Send Time</option>
                                <option>CTA</option><option>Email Content</option><option>Sender Name</option>
                                <option>Offer</option><option>Segmentation</option>
                            </select>
                        </div>
                        <div class="field"><label>Campaign Context</label><input id="bl-context" type="text" placeholder="e.g. Re-engagement â€” churned Pro users, 60+ days inactive"></div>
                    </div>
                    <div>
                        <div class="field"><label>Priority</label>
                            <select id="bl-priority">
                                <option>High</option><option selected>Medium</option><option>Low</option>
                            </select>
                        </div>
                        <div class="field"><label>Status</label>
                            <select id="bl-status">
                                <option>Idea</option><option>Planned</option><option>Running</option><option>Complete</option>
                            </select>
                        </div>
                        <div class="field"><label>Notes</label><textarea id="bl-notes" placeholder="Expected outcome, dependencies, or anything else useful"></textarea></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="saveBacklogItem()">Save Idea</button>
                    <button class="btn-sm" onclick="toggleBacklogForm()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- AI Suggested Experiments -->
        <div style="margin-bottom:28px;">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:4px;">
                <div>
                    <span style="font-size:13px;font-weight:700;">âœ¨ AI-Suggested Experiments</span>
                    <span style="font-size:12px;color:var(--muted);margin-left:10px;">Based on your campaign data + lifecycle marketing best practices</span>
                </div>
                <button class="btn" onclick="loadAISuggestions()" id="ai-suggest-btn">Generate Ideas</button>
            </div>
            <div id="ai-suggestions" style="color:var(--muted);font-size:13px;padding:6px 0;">Hit "Generate Ideas" to get 5 data-informed experiment suggestions.</div>
        </div>

        <div class="backlog-board" id="backlog-board"></div>
    </div>

    <!-- A/B TESTS -->
    <div id="tab-abtests" class="tab-content">
        <h2>A/B Test Tracker</h2>
        <div class="inner-tabs">
            <button class="active" onclick="showABInner('ab-view', this)">Test Log</button>
            <button onclick="showABInner('ab-form', this)">Log New Test</button>
        </div>

        <div id="ab-view">
            <div class="card-flush">
                <table>
                    <thead><tr><th>Test</th><th>Element</th><th>Variant A</th><th>A Open %</th><th>A Click %</th><th>Variant B</th><th>B Open %</th><th>B Click %</th><th>Winner</th><th>Stat Sig</th><th>Insight</th><th>Date</th></tr></thead>
                    <tbody id="ab-body"><tr><td colspan="12" class="empty">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="ab-form" style="display:none;">
            <div id="ab-alert"></div>
            <div class="card">
                <div class="grid-2">
                    <div>
                        <div class="field"><label>Test Name *</label><input id="ab-name" type="text" placeholder="e.g. Subject line test â€” Nov launch"></div>
                        <div class="field"><label>Element Tested</label>
                            <select id="ab-element">
                                <option>Subject Line</option><option>Preview Text</option><option>CTA</option>
                                <option>Send Time</option><option>Email Content</option><option>Sender Name</option><option>Offer</option>
                            </select>
                        </div>
                        <div class="field"><label>Hypothesis</label><textarea id="ab-hyp" placeholder="e.g. A curiosity-gap subject will outperform a benefit-led one for this segment"></textarea></div>
                        <div class="field"><label>Test Date</label><input id="ab-date" type="date"></div>
                        <div class="field"><label>Winner</label>
                            <select id="ab-winner"><option value="A">A</option><option value="B">B</option><option value="N">No clear winner</option></select>
                        </div>
                        <div class="field"><label>What did you learn?</label><textarea id="ab-insight" placeholder="e.g. Curiosity-gap outperformed by 4pp on opens â€” will apply to future launches"></textarea></div>
                    </div>
                    <div>
                        <p style="font-weight:700;margin-bottom:12px;">Variant A</p>
                        <div class="field"><label>Describe Variant A</label><input id="ab-a-name" type="text" placeholder="e.g. Benefit-led"></div>
                        <div class="field"><label>Variant A Content</label><textarea id="ab-a-content" placeholder="e.g. The subject line, CTA copy, or other content used in Variant A"></textarea></div>
                        <div class="field"><label>A Open Rate (%)</label><input id="ab-a-open" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                        <div class="field"><label>A Click Rate (%)</label><input id="ab-a-click" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                        <p style="font-weight:700;margin:16px 0 12px;">Variant B</p>
                        <div class="field"><label>Describe Variant B</label><input id="ab-b-name" type="text" placeholder="e.g. Curiosity-gap"></div>
                        <div class="field"><label>Variant B Content</label><textarea id="ab-b-content" placeholder="e.g. The subject line, CTA copy, or other content used in Variant B"></textarea></div>
                        <div class="field"><label>B Open Rate (%)</label><input id="ab-b-open" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                        <div class="field"><label>B Click Rate (%)</label><input id="ab-b-click" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveABTest()">Save Test</button>
            </div>
        </div>
    </div>

    <!-- REPORT GENERATOR -->
    <div id="tab-reports" class="tab-content">
        <h2>Generate Report</h2>
        <div class="card">
            <div class="inner-tabs" style="margin-bottom:20px;">
                <button class="active" onclick="switchReportMode('period', this)">Date Range</button>
                <button onclick="switchReportMode('single', this)">Single Campaign</button>
            </div>
            <div id="r-mode-period">
                <div class="grid-2">
                    <div class="field"><label>From</label><input type="date" id="r-from"></div>
                    <div class="field"><label>To</label><input type="date" id="r-to"></div>
                </div>
            </div>
            <div id="r-mode-single" style="display:none;">
                <div class="field"><label>Campaign</label><select id="r-campaign"><option value="">Loading...</option></select></div>
            </div>
            <div class="field"><label>Report Type</label>
                <select id="r-type">
                    <option value="stakeholder">Stakeholder update</option>
                    <option value="postmortem">Post-mortem / retrospective</option>
                    <option value="exec">Executive summary</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
        </div>
        <div id="report-out" style="display:none;margin-top:24px;"></div>
    </div>

    <!-- PRODUCT UPDATES -->
    <div id="tab-productupdates" class="tab-content">
        <div class="section-header">
            <h2>Product Updates</h2>
            <button class="btn" onclick="loadProductUpdates()" id="pu-refresh-btn">â†» Refresh</button>
        </div>
        <div class="filters">
            <select id="pu-filter-type" onchange="renderProductUpdates()">
                <option value="">All Update Types</option>
                <option>New Feature</option>
                <option>Existing Feature Improvement</option>
                <option>Pricing</option>
                <option>Billing</option>
            </select>
            <select id="pu-filter-stage" onchange="renderProductUpdates()">
                <option value="">All Stages</option>
                <option>In Build</option>
                <option>Closed Beta</option>
                <option>General Availability</option>
                <option>Early Access</option>
            </select>
            <span id="pu-meta" style="color:var(--muted);font-size:12px;"></span>
        </div>

        <!-- Recent submissions strip -->
        <div style="margin-bottom:20px;">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:10px;">Latest 10 Submissions</div>
            <div class="pu-recent-header">
                <span></span>
                <span>Feature / Product</span>
                <span>Type</span>
                <span>Stage</span>
                <span>Team</span>
                <span>Beta Start</span>
                <span>GA Date</span>
                <span>UI Change</span>
                <span>Submitted</span>
            </div>
            <div id="pu-recent" style="display:flex;flex-direction:column;gap:6px;"></div>
        </div>

        <!-- Full table -->
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:10px;">All Submissions</div>
        <div class="card-flush">
            <table id="pu-table">
                <thead><tr>
                    <th>Feature / Product</th>
                    <th>Type</th>
                    <th>Stage</th>
                    <th>Team</th>
                    <th>Beta Start</th>
                    <th>GA Date</th>
                    <th>UI Change</th>
                    <th>Submitted</th>
                </tr></thead>
                <tbody id="pu-body"><tr><td colspan="8" class="empty">Loadingâ€¦</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- SERIES REPLIES -->
    <div id="tab-seriesreplies" class="tab-content">
        <h2>Series Replies</h2>
        <p style="color:var(--muted);font-size:13px;margin-bottom:20px;">Search for an automated email by subject line, then explore customer replies and ask Claude about themes, sentiment, or concerns.</p>

        <!-- Search bar -->
        <div class="card" style="padding:16px;">
            <div style="display:flex;gap:10px;align-items:center;">
                <input id="sr-query" type="text" placeholder="Search by subject or sender nameâ€¦" style="flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-size:13px;font-family:inherit;outline:none;" onkeydown="if(event.key==='Enter') searchSeries()" />
                <select id="sr-recency" style="padding:9px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-size:13px;font-family:inherit;outline:none;cursor:pointer;">
                    <option value="">Any time</option>
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="60">Last 60 days</option>
                    <option value="90">Last 90 days</option>
                </select>
                <button class="btn btn-primary" onclick="searchSeries()" id="sr-search-btn">Search</button>
            </div>
            <div id="sr-search-status" style="margin-top:8px;font-size:12px;color:var(--muted);min-height:18px;"></div>
        </div>

        <!-- Source message results -->
        <div id="sr-sources" style="display:none;margin-bottom:20px;">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:10px;">Matching Messages â€” click one to load replies</div>
            <div id="sr-sources-list"></div>
        </div>

        <!-- Replies panel -->
        <div id="sr-replies-panel" style="display:none;">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
                <div>
                    <div id="sr-selected-subject" style="font-size:14px;font-weight:700;"></div>
                    <div id="sr-selected-meta" style="font-size:12px;color:var(--muted);margin-top:2px;"></div>
                </div>
                <button class="btn" style="font-size:12px;" onclick="closeSRPanel()">â† Back to results</button>
            </div>

            <!-- Replies list -->
            <div class="card-flush" style="margin-bottom:20px;">
                <table>
                    <thead><tr>
                        <th>Customer</th>
                        <th>Reply</th>
                        <th>Date</th>
                    </tr></thead>
                    <tbody id="sr-replies-body"><tr><td colspan="3" style="padding:20px;text-align:center;color:var(--muted);">Loading repliesâ€¦</td></tr></tbody>
                </table>
            </div>

            <!-- Claude analysis -->
            <div class="card">
                <div style="font-size:13px;font-weight:700;margin-bottom:10px;">âœ¨ Ask Claude about these replies</div>
                <div class="field" style="margin-bottom:10px;">
                    <textarea id="sr-question" rows="2" style="resize:vertical;" placeholder="e.g. What are the main themes? Any concerning replies? What are customers asking for?"></textarea>
                </div>
                <button class="btn btn-primary" onclick="analyseSeriesReplies()" id="sr-analyse-btn" style="font-size:13px;">Analyse Replies</button>
                <div id="sr-analysis-out" style="margin-top:16px;display:none;"></div>
            </div>
        </div>
    </div>

</main>

<!-- SERIES REPLY TOOLTIP -->
<div id="sr-tooltip" style="display:none;position:fixed;z-index:200;background:#1e293b;border:1px solid #334155;border-radius:8px;padding:12px 16px;max-width:420px;font-size:13px;line-height:1.65;color:#e2e8f0;box-shadow:0 4px 24px rgba(0,0,0,0.5);pointer-events:none;white-space:pre-wrap;word-break:break-word;"></div>

<!-- CALENDAR TOOLTIP -->
<div id="cal-tooltip"></div>

<!-- PRODUCT UPDATE DETAIL MODAL -->
<div id="pu-modal-overlay" onclick="closePUModal()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;"></div>
<div id="pu-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:560px;max-width:95vw;max-height:88vh;overflow-y:auto;z-index:101;">
    <div class="card">
        <div class="cm-header">
            <span class="cm-title" id="pu-modal-title"></span>
            <button class="cm-close" onclick="closePUModal()">&#x2715;</button>
        </div>
        <div id="pu-modal-body" style="display:flex;flex-direction:column;gap:12px;"></div>
    </div>
</div>

<!-- CAMPAIGN DETAIL MODAL -->
<div id="cal-modal-overlay" onclick="closeCampaignModal()"></div>
<div id="cal-modal">
    <div class="card">
        <div id="cal-modal-content"></div>
    </div>
</div>

<!-- A/B TEST DETAIL MODAL -->
<div id="ab-modal-overlay" onclick="closeABTestModal()"></div>
<div id="ab-modal">
    <div class="card">
        <div id="ab-modal-content"></div>
    </div>
</div>

<!-- LOG CAMPAIGN MODAL -->
<div id="log-modal-overlay" onclick="closeLogModal()"></div>
<div id="log-modal">
    <div class="card">
        <div class="cm-header">
            <span class="cm-title">Log a Campaign</span>
            <button class="cm-close" onclick="closeLogModal()">&#x2715;</button>
        </div>
        <div id="log-modal-alert"></div>
        <div class="grid-2">
            <div>
                <div class="field"><label>Campaign Name *</label><input id="f-name" type="text" placeholder="e.g. Fin AI Launch â€” Wave 1"></div>
                <div class="field"><label>Category *</label>
                    <select id="f-category">
                        <option value="">Select...</option>
                        <option>Launches</option><option>Early lifecycle</option><option>Usage</option>
                        <option>Events</option><option>Acquisition</option><option>Adhoc</option>
                        <option>Expansion</option><option>Fin SA</option><option>Migrations</option>
                        <option>Newsletter</option><option>Ops</option>
                    </select>
                </div>
                <div class="field"><label>Send Date</label><input id="f-date" type="date"></div>
                <div class="field"><label>Audience Segment</label><input id="f-segment" type="text" placeholder="e.g. Pro plan, 30+ days active"></div>
                <div class="field"><label>Subject Line</label><input id="f-subject" type="text" placeholder="e.g. Meet your new AI teammate"></div>
                <div class="field"><label>Your Name</label><input id="f-author" type="text" placeholder="e.g. Shane"></div>
            </div>
            <div>
                <div class="field"><label>Emails Sent</label><input id="f-sent" type="number" placeholder="0" min="0"></div>
                <div class="field"><label>Open Rate (%)</label><input id="f-open" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                <div class="field"><label>Click Rate (%)</label><input id="f-click" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                <div class="field"><label>Click-to-Open Rate (%)</label><input id="f-ctor" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                <div class="field"><label>Unsubscribe Rate (%)</label><input id="f-unsub" type="number" placeholder="0.00" step="0.01" min="0" max="100"></div>
                <div class="field"><label>Conversion Rate (%)</label><input id="f-conv" type="number" placeholder="0.0" step="0.1" min="0" max="100"></div>
                <div class="field"><label>Revenue ($)</label><input id="f-revenue" type="number" placeholder="0" min="0"></div>
            </div>
        </div>
        <div class="field"><label>Notes / Context</label><textarea id="f-notes" placeholder="What was the goal? Anything unusual about this send?"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:4px;">
            <button class="btn" onclick="closeLogModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCampaign()">Save Campaign</button>
        </div>
    </div>
</div>

<script>
/*
  NEW SUPABASE TABLES REQUIRED
  Run these in your Supabase SQL editor:

  create table lifecycle_swipe_file (
    id uuid default gen_random_uuid() primary key,
    type text,
    content text,
    category text,
    campaign_name text,
    open_rate float,
    click_rate float,
    notes text,
    created_at timestamptz default now()
  );

  create table lifecycle_experiment_backlog (
    id uuid default gen_random_uuid() primary key,
    hypothesis text,
    element_to_test text,
    priority text default 'Medium',
    status text default 'Idea',
    campaign_context text,
    notes text,
    created_at timestamptz default now()
  );

  -- NEW COLUMNS FOR PERFORMANCE METRICS (run once in SQL editor):
  alter table lifecycle_campaigns
    add column if not exists emails_opened   integer,
    add column if not exists emails_clicked  integer,
    add column if not exists replies         integer,
    add column if not exists reply_rate      float,
    add column if not exists unsubscribed    integer,
    add column if not exists bounced         integer,
    add column if not exists bounce_rate     float;

  -- A/B TEST VARIANT COLUMNS (run once to enable saving both variant counts):
  alter table lifecycle_campaigns
    add column if not exists emails_sent_b    integer,
    add column if not exists emails_opened_b  integer,
    add column if not exists emails_clicked_b integer;

  -- A/B TEST SAMPLE SIZE COLUMNS (run once to enable statistical significance):
  alter table lifecycle_ab_tests
    add column if not exists sent_a integer,
    add column if not exists sent_b integer;

  -- PARENT CAMPAIGN (run once to enable Coda sub-row hierarchy in library):
  alter table lifecycle_campaigns
    add column if not exists parent_campaign text;

  -- INSPIRATION BOARD (run once to add image support to swipe file):
  alter table lifecycle_swipe_file
    add column if not exists image_url text;
*/

const { createClient } = supabase;
const db = createClient(
    'https://uasecpkhdkonpwomaeze.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhc2VjcGtoZGtvbnB3b21hZXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjkzMzMsImV4cCI6MjA4NzEwNTMzM30.jmCTT5ta7u3f8FIwlkYKQ1amLJ6Qn-MVxBv4S3ToQaw'
);

const PU_CODA_KEY   = 'd879d85b-ce77-4089-8bdc-256bda621e35';
const PU_CODA_DOC   = '-bP_Aj0QDV';
const PU_CODA_TABLE = 'grid-7jeigIB__W';

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('nav button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        if (btn.dataset.tab === 'dashboard') loadDashboard();
        if (btn.dataset.tab === 'library')   loadLibrary();
        if (btn.dataset.tab === 'calendar')  { loadCalendar(); silentSyncFromCoda(); }
        if (btn.dataset.tab === 'swipe')     loadInspiration();
        if (btn.dataset.tab === 'backlog')   loadBacklog();
        if (btn.dataset.tab === 'abtests')   loadABTests();
        if (btn.dataset.tab === 'reports')        loadCampaignsForReport();
        if (btn.dataset.tab === 'productupdates') loadProductUpdates();
    });
});

function showABInner(id, btn) {
    ['ab-view','ab-form'].forEach(i => document.getElementById(i).style.display = 'none');
    btn.closest('.inner-tabs').querySelectorAll('button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    btn.classList.add('active');
}

function showSwipeInner(id, btn) {
    ['swipe-view','swipe-form'].forEach(i => document.getElementById(i).style.display = 'none');
    btn.closest('.inner-tabs').querySelectorAll('button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    btn.classList.add('active');
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pct = v => v != null ? (v * 100).toFixed(1) + '%' : 'â€”';
const num = v => v != null ? Number(v).toLocaleString() : 'â€”';

function badge(cat) {
    const cls = (cat || '').replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
    return `<span class="badge badge-${cls}">${cat}</span>`;
}

function showAlert(elId, msg, type = 'success') {
    document.getElementById(elId).innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(() => document.getElementById(elId).innerHTML = '', 4000);
}

function toRate(id) { const v = parseFloat(document.getElementById(id).value); return isNaN(v) ? null : v / 100; }
function toInt(id)  { const v = parseInt(document.getElementById(id).value);   return isNaN(v) ? null : v; }
function toFlt(id)  { const v = parseFloat(document.getElementById(id).value); return isNaN(v) ? null : v; }
function val(id)    { return document.getElementById(id).value.trim() || null; }

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
    const [{ data: q1Data }, { data: q4Data }, { data: allData }, { data: abData }, { data: backlogData }] = await Promise.all([
        db.from('lifecycle_campaigns').select('*').order('send_date', { ascending: false }).gte('send_date', '2026-02-01'),
        db.from('lifecycle_campaigns').select('emails_sent,emails_sent_b,open_rate,click_rate,click_to_open_rate,parent_campaign').gte('send_date', '2025-11-01').lt('send_date', '2026-02-01'),
        db.from('lifecycle_campaigns').select('category,open_rate,click_rate,click_to_open_rate,emails_sent'),
        db.from('lifecycle_ab_tests').select('test_id,test_name,winner,test_date,variant_a_name,variant_b_name').gte('test_date', '2026-02-01').order('test_date', { ascending: false }),
        db.from('lifecycle_experiment_backlog').select('id,status'),
    ]);

    const q1  = q1Data  || [];
    const q4  = q4Data  || [];
    const all = allData || [];

    renderDashKPIs(q1, q4);
    renderTopPerformers(q1);
    renderABSummary(abData || []);
    renderBacklogSnapshot(backlogData || []);
    renderBenchmarkGrid(q1, all);
    renderUpcomingLaunches();
}

function renderDashKPIs(q1, q4) {
    const avgF = (rows, field) => {
        const vals = rows.filter(r => r[field] != null && !r.parent_campaign).map(r => r[field]);
        return vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : null;
    };
    const sentTotal = rows => rows.filter(r => !r.parent_campaign).reduce((s, r) => s + (r.emails_sent || 0) + (r.emails_sent_b || 0), 0);

    const q1Sent  = sentTotal(q1);
    const q4Sent  = sentTotal(q4);
    const q1Open  = avgF(q1, 'open_rate');
    const q1Click = avgF(q1, 'click_rate');
    const q1CTOR  = avgF(q1, 'click_to_open_rate');
    const q4Open  = avgF(q4, 'open_rate');
    const q4Click = avgF(q4, 'click_rate');
    const q4CTOR  = avgF(q4, 'click_to_open_rate');

    const hasQ4 = q4.length > 0;

    // pp delta for rates
    const rateDelta = (q1val, q4val) => {
        if (q1val == null) return '';
        if (!hasQ4 || q4val == null) return `<span class="kpi-flat">no Q4 data yet</span>`;
        const d = (q1val - q4val) * 100;
        const sign = d > 0 ? '+' : '';
        const cls  = d > 0 ? 'kpi-up' : d < 0 ? 'kpi-down' : 'kpi-flat';
        return `<span class="${cls}">${sign}${d.toFixed(1)}pp vs Q4</span>`;
    };

    // % change for volume
    const sentDelta = (q1val, q4val) => {
        if (!hasQ4 || !q4val) return `<span class="kpi-flat">no Q4 data yet</span>`;
        const pct = ((q1val - q4val) / q4val) * 100;
        const sign = pct > 0 ? '+' : '';
        const cls  = pct > 0 ? 'kpi-up' : pct < 0 ? 'kpi-down' : 'kpi-flat';
        return `<span class="${cls}">${sign}${pct.toFixed(0)}% vs Q4 (${q4val.toLocaleString()})</span>`;
    };

    const fmt = v => v == null ? 'â€”' : (v * 100).toFixed(1) + '%';

    document.getElementById('kpi-sent').textContent        = q1Sent > 0 ? q1Sent.toLocaleString() : 'â€”';
    document.getElementById('kpi-open').textContent        = fmt(q1Open);
    document.getElementById('kpi-click').textContent       = fmt(q1Click);
    document.getElementById('kpi-ctor').textContent        = fmt(q1CTOR);
    document.getElementById('kpi-sent-delta').innerHTML    = sentDelta(q1Sent, q4Sent);
    document.getElementById('kpi-open-delta').innerHTML    = rateDelta(q1Open,  q4Open);
    document.getElementById('kpi-click-delta').innerHTML   = rateDelta(q1Click, q4Click);
    document.getElementById('kpi-ctor-delta').innerHTML    = rateDelta(q1CTOR,  q4CTOR);
}

function renderTopPerformers(q1) {
    const withData = q1.filter(c => c.open_rate != null && !c.parent_campaign)
        .sort((a, b) => b.open_rate - a.open_rate)
        .slice(0, 5);
    if (!withData.length) {
        document.getElementById('dash-top-body').innerHTML = `<tr><td colspan="6" class="empty">No campaigns with performance data yet this quarter</td></tr>`;
        return;
    }
    document.getElementById('dash-top-body').innerHTML = withData.map(c => `
        <tr class="clickable" onclick="openCampaignById('${c.campaign_id}')">
            <td><strong>${c.campaign_name}</strong></td>
            <td>${badge(c.category)}</td>
            <td style="color:var(--muted);font-size:12px;">${c.emails_sent ? c.emails_sent.toLocaleString() : 'â€”'}</td>
            <td>${pct(c.open_rate)}</td>
            <td>${pct(c.click_rate)}</td>
            <td>${pct(c.click_to_open_rate)}</td>
        </tr>`).join('');
}

function renderABSummary(tests) {
    const total      = tests.length;
    const withWinner = tests.filter(t => t.winner && t.winner !== 'N').length;
    const winRate    = total > 0 ? Math.round(withWinner / total * 100) : null;
    const latest     = tests[0];
    document.getElementById('dash-ab-card').innerHTML = `
        <div class="dash-stat-row" style="grid-template-columns:repeat(3,1fr);">
            <div class="dash-stat"><div class="sv">${total}</div><div class="sl">Tests Run</div></div>
            <div class="dash-stat"><div class="sv">${withWinner}</div><div class="sl">Winners Found</div></div>
            <div class="dash-stat"><div class="sv">${winRate != null ? winRate + '%' : 'â€”'}</div><div class="sl">Win Rate</div></div>
        </div>
        ${total === 0 ? `<div style="font-size:12px;color:var(--muted);">No A/B tests logged this quarter yet.</div>` :
          latest ? `<div style="font-size:12px;color:var(--muted);border-top:1px solid var(--border);padding-top:10px;">
            Latest: <span style="color:var(--text);font-weight:600;">${latest.test_name}</span>
            ${latest.winner && latest.winner !== 'N' ? `<span style="color:#4ade80;margin-left:6px;">âœ“ Variant ${latest.winner} won</span>` : '<span style="color:var(--muted);margin-left:6px;">No winner yet</span>'}
          </div>` : ''}`;
}

function renderBacklogSnapshot(items) {
    const statuses = ['Idea', 'Planned', 'Running', 'Complete'];
    const counts   = Object.fromEntries(statuses.map(s => [s, 0]));
    items.forEach(i => { if (counts[i.status] != null) counts[i.status]++; });
    document.getElementById('dash-backlog-card').innerHTML = `
        <div class="dash-stat-row" style="grid-template-columns:repeat(4,1fr);">
            ${statuses.map(s => `<div class="dash-stat"><div class="sv">${counts[s]}</div><div class="sl">${s}</div></div>`).join('')}
        </div>
        <div style="font-size:12px;color:var(--muted);border-top:1px solid var(--border);padding-top:10px;">${items.length} experiment${items.length !== 1 ? 's' : ''} in pipeline</div>`;
}

async function renderUpcomingLaunches() {
    const el = document.getElementById('dash-upcoming');
    try {
        let rows = _puAllRows;
        if (!rows.length) {
            const url = `https://coda.io/apis/v1/docs/${PU_CODA_DOC}/tables/${PU_CODA_TABLE}/rows?valueFormat=simpleWithArrays&limit=100`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${PU_CODA_KEY}` } });
            if (res.ok) rows = (await res.json()).items || [];
        }
        const today  = new Date(); today.setHours(0, 0, 0, 0);
        const in30   = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
        const inRange = d => { if (!d) return false; const dt = new Date(d); dt.setHours(0,0,0,0); return dt >= today && dt <= in30; };

        const upcoming = rows
            .filter(r => inRange(r.values['c-NVAGx6DJ8x']) || inRange(r.values['c-CrBT48ejwj']))
            .sort((a, b) => {
                const da = new Date(a.values['c-CrBT48ejwj'] || a.values['c-NVAGx6DJ8x'] || 0);
                const db = new Date(b.values['c-CrBT48ejwj'] || b.values['c-NVAGx6DJ8x'] || 0);
                return da - db;
            });

        if (!upcoming.length) {
            el.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:4px 0;">No product launches scheduled in the next 30 days.</div>`;
            return;
        }
        el.innerHTML = `<div class="launch-grid">${upcoming.map(row => {
            const v = row.values;
            return `<div class="launch-card-d" onclick="switchToProductUpdates()">
                <div class="lc-name">${v['c-6jbOLJ-JMT'] || 'â€”'}</div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;">${puTypeBadge(v['c-Oy8GigRO4V'])}${puStageBadge(v['c-m_L22ZVzvr'])}</div>
                <div class="lc-dates">
                    ${v['c-NVAGx6DJ8x'] ? `<div class="lc-date-chip">Beta <span>${puFmtDate(v['c-NVAGx6DJ8x'])}</span></div>` : ''}
                    ${v['c-CrBT48ejwj'] ? `<div class="lc-date-chip">GA <span>${puFmtDate(v['c-CrBT48ejwj'])}</span></div>` : ''}
                </div>
            </div>`;
        }).join('')}</div>`;
    } catch (e) {
        el.innerHTML = `<div style="color:var(--muted);font-size:13px;">Could not load upcoming launches.</div>`;
    }
}

function switchToProductUpdates() {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector('nav button[data-tab="productupdates"]').classList.add('active');
    document.getElementById('tab-productupdates').classList.add('active');
    loadProductUpdates();
}

function renderBenchmarkGrid(q1, all) {
    const VALID_CATS = new Set(['Launches','Early lifecycle','Usage','Events','Acquisition','Adhoc','Expansion','Fin SA','Migrations','Newsletter']);
    const CAT_REMAP  = { 'product launch':'Launches','onboarding':'Early lifecycle','event':'Events','re-engagement':'Usage','reengagement':'Usage','nurture':'Usage','promotional':'Adhoc','retention':'Usage','conversion':'Usage','upsell':'Expansion','winback':'Usage' };
    const group = (rows) => {
        const g = {};
        rows.forEach(c => {
            let cat = c.category;
            if (!VALID_CATS.has(cat)) cat = CAT_REMAP[(cat||'').toLowerCase().trim()] || null;
            if (!cat) return;
            if (!g[cat]) g[cat] = [];
            g[cat].push(c);
        });
        return g;
    };
    const q1G  = group(q1);
    const allG = group(all);
    const avg  = (rows, field) => {
        const vals = rows.filter(r => r[field] != null).map(r => r[field]);
        return vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length * 100).toFixed(1) : 'â€”';
    };
    const benchEl = document.getElementById('bench-grid');
    if (!Object.keys(q1G).length) {
        benchEl.innerHTML = `<div class="empty" style="grid-column:1/-1;"><strong>No campaigns yet</strong> â€” use "Log Campaign" to add your first one.</div>`;
        return;
    }
    benchEl.innerHTML = Object.entries(q1G).map(([cat, q1Rows]) => {
        const allRows = allG[cat] || q1Rows;
        return `<div class="bench-card">
            <div class="bench-cat">${badge(cat)} <span style="color:var(--muted);font-size:12px;margin-left:6px;">${q1Rows.length} campaign${q1Rows.length > 1 ? 's' : ''}</span></div>
            <div class="bench-metrics">
                <div class="bench-metric"><div class="label">Avg Open</div><div class="value">${avg(allRows,'open_rate')}%</div></div>
                <div class="bench-metric"><div class="label">Avg Click</div><div class="value">${avg(allRows,'click_rate')}%</div></div>
                <div class="bench-metric"><div class="label">Avg CTOR</div><div class="value">${avg(allRows,'click_to_open_rate')}%</div></div>
            </div>
        </div>`;
    }).join('');
}

function resetLibraryDate() {
    document.getElementById('filter-from').value = '2026-02-01';
    loadLibrary();
}

// â”€â”€ LOG CAMPAIGN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLogModal() {
    document.getElementById('log-modal-overlay').style.display = 'block';
    document.getElementById('log-modal').style.display = 'block';
}

function closeLogModal() {
    document.getElementById('log-modal-overlay').style.display = 'none';
    document.getElementById('log-modal').style.display = 'none';
    document.getElementById('log-modal-alert').innerHTML = '';
}

async function saveCampaign() {
    const name = val('f-name');
    const category = val('f-category');
    if (!name || !category) { showAlert('log-modal-alert', 'Campaign name and category are required.', 'error'); return; }

    const { error } = await db.from('lifecycle_campaigns').insert({
        campaign_name: name, category,
        channel: 'Email', audience_segment: val('f-segment'),
        send_date: val('f-date'), subject_line: val('f-subject'),
        emails_sent: toInt('f-sent'), open_rate: toRate('f-open'),
        click_rate: toRate('f-click'), click_to_open_rate: toRate('f-ctor'),
        unsubscribe_rate: toRate('f-unsub'), conversion_rate: toRate('f-conv'),
        revenue: toFlt('f-revenue'), notes: val('f-notes'), created_by: val('f-author'),
    });

    if (error) { showAlert('log-modal-alert', 'Error: ' + error.message, 'error'); return; }
    document.querySelectorAll('#log-modal input, #log-modal textarea, #log-modal select').forEach(el => el.value = '');
    closeLogModal();
    loadLibrary();
}

// â”€â”€ LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _libData    = [];
let _libAllData = [];
let _libSort    = { col: 'send_date', dir: 'desc' };

async function loadLibrary() {
    const fromDate = document.getElementById('filter-from')?.value || '2026-02-01';
    let q = db.from('lifecycle_campaigns').select('*').gte('send_date', fromDate);
    const cat = document.getElementById('filter-cat').value;
    if (cat) q = q.eq('category', cat);

    const [{ data }, { data: allData }] = await Promise.all([
        q,
        db.from('lifecycle_campaigns').select('category,open_rate,click_rate,click_to_open_rate').not('send_date', 'is', null),
    ]);

    _libData    = data    || [];
    _libAllData = allData || [];
    renderLibrary();
}

function sortLibrary(col) {
    _libSort.dir = (_libSort.col === col && _libSort.dir === 'desc') ? 'asc' : 'desc';
    _libSort.col = col;
    renderLibrary();
}

function renderLibrary() {
    // â”€â”€ Build category benchmarks from all-time data â”€â”€
    const bm = {};
    _libAllData.forEach(c => {
        if (!c.category) return;
        if (!bm[c.category]) bm[c.category] = { opens: [], clicks: [], ctors: [] };
        if (c.open_rate          != null) bm[c.category].opens.push(c.open_rate);
        if (c.click_rate         != null) bm[c.category].clicks.push(c.click_rate);
        if (c.click_to_open_rate != null) bm[c.category].ctors.push(c.click_to_open_rate);
    });
    const _avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
    const bmAvg = {};
    Object.entries(bm).forEach(([cat, d]) => {
        bmAvg[cat] = { open: _avg(d.opens), click: _avg(d.clicks), ctor: _avg(d.ctors) };
    });

    // Heat class: compare value vs category all-time avg (threshold: 1pp)
    const heat = (val, catName, metric) => {
        const a = bmAvg[catName]?.[metric];
        if (val == null || a == null) return '';
        const diff = val - a;
        if (diff >  0.01) return 'cell-hot';
        if (diff < -0.01) return 'cell-cold';
        return '';
    };

    // â”€â”€ Apply search filter â”€â”€
    const search = (document.getElementById('lib-search')?.value || '').toLowerCase().trim();
    const filtered = _libData.filter(c => !search || (c.campaign_name || '').toLowerCase().includes(search));

    // â”€â”€ Summary strip â”€â”€
    const withOpen  = filtered.filter(c => c.open_rate          != null);
    const withClick = filtered.filter(c => c.click_rate         != null);
    const withCTOR  = filtered.filter(c => c.click_to_open_rate != null);
    const fAvgOpen  = _avg(withOpen.map(c => c.open_rate));
    const fAvgClick = _avg(withClick.map(c => c.click_rate));
    const fAvgCTOR  = _avg(withCTOR.map(c => c.click_to_open_rate));

    const catCounts = {};
    filtered.forEach(c => { if (c.category) catCounts[c.category] = (catCounts[c.category] || 0) + 1; });
    const catPills = Object.entries(catCounts)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, n]) => `<span class="badge badge-${cat.replace(/\s+/g,'-').replace(/[^a-zA-Z0-9-]/g,'')}">${cat} <strong>${n}</strong></span>`)
        .join('');

    const summaryEl = document.getElementById('lib-summary');
    if (summaryEl) {
        summaryEl.style.display = filtered.length ? '' : 'none';
        summaryEl.innerHTML = `
            <div class="lib-kpis">
                <div class="lib-kpi"><div class="lib-kpi-val">${filtered.length}</div><div class="lib-kpi-label">Campaigns</div></div>
                <div class="lib-kpi"><div class="lib-kpi-val">${pct(fAvgOpen)}</div><div class="lib-kpi-label">Avg Open</div></div>
                <div class="lib-kpi"><div class="lib-kpi-val">${pct(fAvgClick)}</div><div class="lib-kpi-label">Avg Click</div></div>
                <div class="lib-kpi"><div class="lib-kpi-val">${pct(fAvgCTOR)}</div><div class="lib-kpi-label">Avg CTOR</div></div>
            </div>
            ${catPills ? `<div class="lib-cat-row">${catPills}</div>` : ''}`;
    }

    // â”€â”€ Update sort indicators on column headers â”€â”€
    document.querySelectorAll('th[data-col]').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.col === _libSort.col) th.classList.add(_libSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
    });

    document.getElementById('library-count').textContent = filtered.length ? `${filtered.length} campaign${filtered.length !== 1 ? 's' : ''}` : '';

    if (!filtered.length) {
        document.getElementById('library-body').innerHTML = `<tr><td colspan="8" class="empty">No campaigns found.</td></tr>`;
        return;
    }

    // â”€â”€ Group parents + children â”€â”€
    const campaignNames = new Set(filtered.map(c => c.campaign_name));
    const parents  = filtered.filter(c => !c.parent_campaign);
    const children = filtered.filter(c =>  c.parent_campaign);
    const childMap = {};
    children.forEach(c => {
        if (!childMap[c.parent_campaign]) childMap[c.parent_campaign] = [];
        childMap[c.parent_campaign].push(c);
    });
    const orphans = children.filter(c => !campaignNames.has(c.parent_campaign));

    function calcAgg(kids) {
        const sum = f => kids.reduce((a, k) => a + (k[f] || 0), 0);
        // Include variant B counts if a child is itself a single-row A/B test
        const sent    = sum('emails_sent')    + sum('emails_sent_b');
        const opened  = sum('emails_opened')  + sum('emails_opened_b');
        const clicked = sum('emails_clicked') + sum('emails_clicked_b');
        const unsub = sum('unsubscribed'), bounced = sum('bounced');
        if (!sent) return null;
        return {
            emails_sent: sent,
            open_rate:          opened  ? opened  / sent   : null,
            click_rate:         clicked ? clicked / sent   : null,
            click_to_open_rate: (opened && clicked) ? clicked / opened : null,
            unsubscribe_rate:   unsub   ? unsub   / sent   : null,
        };
    }

    // Write aggregated metrics back to parent rows (fire and forget)
    parents.forEach(c => {
        const kids = childMap[c.campaign_name];
        if (!kids?.length) return;
        const agg = calcAgg(kids);
        if (agg) db.from('lifecycle_campaigns').update(agg).eq('campaign_id', c.campaign_id);
    });

    // â”€â”€ Sort parent groups â”€â”€
    parents.sort((a, b) => {
        const aggA = childMap[a.campaign_name]?.length ? calcAgg(childMap[a.campaign_name]) : null;
        const aggB = childMap[b.campaign_name]?.length ? calcAgg(childMap[b.campaign_name]) : null;
        const col  = _libSort.col;
        let va = (aggA?.[col] ?? a[col]) ?? null;
        let vb = (aggB?.[col] ?? b[col]) ?? null;
        if (va == null && vb == null) return 0;
        if (va == null) return 1;
        if (vb == null) return -1;
        if (typeof va === 'string') return _libSort.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
        return _libSort.dir === 'asc' ? va - vb : vb - va;
    });

    // â”€â”€ Row builders â”€â”€
    const rowHTML = (c, agg) => {
        let d = agg || c;
        // For single-row A/B tests: combine variant A + B into accurate totals
        if (!agg && c.emails_sent_b) {
            const sA = c.emails_sent || 0,    sB = c.emails_sent_b || 0;
            const oA = c.emails_opened || 0,  oB = c.emails_opened_b || 0;
            const cA = c.emails_clicked || 0, cB = c.emails_clicked_b || 0;
            const totalSent    = sA + sB;
            const totalOpened  = oA + oB;
            const totalClicked = cA + cB;
            d = {
                ...c,
                emails_sent:        totalSent,
                open_rate:          (totalOpened  && totalSent)    ? totalOpened  / totalSent    : c.open_rate,
                click_rate:         (totalClicked && totalSent)    ? totalClicked / totalSent    : c.click_rate,
                click_to_open_rate: (totalClicked && totalOpened)  ? totalClicked / totalOpened  : c.click_to_open_rate,
            };
        }
        const cat = c.category || '';
        const isABRow = !agg && !!c.emails_sent_b;
        // Variant breakdown label for A/B rows: "A: 40k / B: 40k"
        const abBreakdown = isABRow
            ? `<div style="font-size:10px;color:var(--muted);margin-top:1px;">A: ${num(c.emails_sent)} / B: ${num(c.emails_sent_b)}</div>`
            : '';
        return `<tr class="clickable" onclick="openCampaignById('${c.campaign_id}')">
            <td><strong>${c.campaign_name}</strong>${(agg && d.emails_sent) || isABRow ? `<span style="font-size:10px;color:var(--muted);font-weight:400;margin-left:6px;">Î£ combined</span>` : ''}${c.subject_line ? `<br><span style="color:var(--muted);font-size:12px;">${c.subject_line}</span>` : ''}</td>
            <td>${badge(cat)}</td>
            <td>${c.send_date || 'â€”'}</td>
            <td>${num(d.emails_sent)}${abBreakdown}</td>
            <td class="${heat(d.open_rate, cat, 'open')}">${pct(d.open_rate)}</td>
            <td class="${heat(d.click_rate, cat, 'click')}">${pct(d.click_rate)}</td>
            <td class="${heat(d.click_to_open_rate, cat, 'ctor')}">${pct(d.click_to_open_rate)}</td>
            <td>${pct(d.unsubscribe_rate)}</td>
        </tr>`;
    };

    const subRowHTML = c => {
        const cat = c.category || '';
        let d = c;
        if (c.emails_sent_b) {
            const sA = c.emails_sent || 0, sB = c.emails_sent_b || 0;
            const oA = c.emails_opened || 0, oB = c.emails_opened_b || 0;
            const cA = c.emails_clicked || 0, cB = c.emails_clicked_b || 0;
            const totalSent = sA + sB, totalOpened = oA + oB, totalClicked = cA + cB;
            d = {
                ...c,
                emails_sent: totalSent,
                open_rate:          (totalOpened  && totalSent)   ? totalOpened  / totalSent   : c.open_rate,
                click_rate:         (totalClicked && totalSent)   ? totalClicked / totalSent   : c.click_rate,
                click_to_open_rate: (totalClicked && totalOpened) ? totalClicked / totalOpened : c.click_to_open_rate,
            };
        }
        const abBreakdown = c.emails_sent_b
            ? `<div style="font-size:10px;color:var(--muted);margin-top:1px;">A: ${num(c.emails_sent)} / B: ${num(c.emails_sent_b)}</div>`
            : '';
        return `<tr class="clickable" onclick="openCampaignById('${c.campaign_id}')">
            <td style="padding-left:28px;"><span style="color:var(--muted);margin-right:6px;">â†³</span>${c.campaign_name}${c.subject_line ? `<br><span style="color:var(--muted);font-size:12px;padding-left:18px;">${c.subject_line}</span>` : ''}</td>
            <td>${badge(cat)}</td>
            <td>${c.send_date || 'â€”'}</td>
            <td>${num(d.emails_sent)}${abBreakdown}</td>
            <td class="${heat(d.open_rate, cat, 'open')}">${pct(d.open_rate)}</td>
            <td class="${heat(d.click_rate, cat, 'click')}">${pct(d.click_rate)}</td>
            <td class="${heat(d.click_to_open_rate, cat, 'ctor')}">${pct(d.click_to_open_rate)}</td>
            <td>${pct(d.unsubscribe_rate)}</td>
        </tr>`;
    };

    const rows = [];
    parents.forEach(c => {
        const kids = childMap[c.campaign_name] || [];
        rows.push(rowHTML(c, kids.length ? calcAgg(kids) : null));
        kids.forEach(child => rows.push(subRowHTML(child)));
    });

    // Orphaned children (parent outside current date range)
    if (orphans.length) {
        const orphanGroups = {};
        orphans.forEach(c => {
            if (!orphanGroups[c.parent_campaign]) orphanGroups[c.parent_campaign] = [];
            orphanGroups[c.parent_campaign].push(c);
        });
        Object.entries(orphanGroups).forEach(([parentName, kids]) => {
            rows.push(`<tr><td colspan="8" style="padding:8px 14px 4px;background:var(--bg);border-bottom:none;">
                <span style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;">${parentName}</span>
                <span style="font-size:11px;color:var(--muted);margin-left:6px;">(parent not in current view)</span>
            </td></tr>`);
            kids.forEach(c => rows.push(subRowHTML(c)));
        });
    }

    document.getElementById('library-body').innerHTML = rows.join('');
}

// â”€â”€ CAMPAIGN CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calData  = [];

const CAL_MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const CAL_DAYS   = ['Su','Mo','Tu','We','Th','Fr','Sa'];

function changeMonth(dir) {
    if (dir === 0) {
        calYear  = new Date().getFullYear();
        calMonth = new Date().getMonth();
    } else {
        calMonth += dir;
        if (calMonth > 11) { calMonth = 0; calYear++; }
        if (calMonth < 0)  { calMonth = 11; calYear--; }
    }
    renderCalendar();
}

async function loadCalendar() {
    const { data } = await db.from('lifecycle_campaigns')
        .select('*')
        .not('send_date', 'is', null);
    calData = data || [];
    renderCalendar();
}

function renderCalendar() {
    let m2 = calMonth + 2, y2 = calYear;
    if (m2 > 11) { m2 -= 12; y2++; }
    const label = calYear === y2
        ? `${CAL_MONTHS[calMonth]} â€“ ${CAL_MONTHS[m2]} ${calYear}`
        : `${CAL_MONTHS[calMonth]} ${calYear} â€“ ${CAL_MONTHS[m2]} ${y2}`;
    document.getElementById('cal-nav-label').textContent = label;

    let html = '';
    for (let i = 0; i < 3; i++) {
        let m = calMonth + i, y = calYear;
        if (m > 11) { m -= 12; y++; }
        html += buildMonthGrid(y, m);
    }
    document.getElementById('cal-container').innerHTML = html;
}

function buildMonthGrid(year, month) {
    const firstDay    = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrev  = new Date(year, month, 0).getDate();
    const today       = new Date();
    const isCurrent   = today.getFullYear() === year && today.getMonth() === month;

    let g = CAL_DAYS.map(d => `<div class="cal-day-header">${d}</div>`).join('');

    for (let i = firstDay - 1; i >= 0; i--) {
        g += `<div class="cal-day other-month"><div class="cal-date">${daysInPrev - i}</div></div>`;
    }

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = isCurrent && today.getDate() === d;
        const events  = calData.filter(c => c.send_date === dateStr);
        const dateEl  = isToday
            ? `<div class="cal-date"><span class="cal-date-today">${d}</span></div>`
            : `<div class="cal-date">${d}</div>`;
        const evts = events.map(c => {
            const cls  = (c.category || '').replace(/[\s-]/g, '').replace(/[^a-zA-Z]/g, '');
            const key  = encodeURIComponent(c.campaign_name + '|' + dateStr);
            const name = c.campaign_name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            return `<div class="cal-event cal-event-${cls}" data-key="${key}" data-name="${name}">${c.campaign_name}</div>`;
        }).join('');
        g += `<div class="cal-day${isToday ? ' today' : ''}">${dateEl}${evts}</div>`;
    }

    const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
    for (let i = 1; i <= totalCells - firstDay - daysInMonth; i++) {
        g += `<div class="cal-day other-month"><div class="cal-date">${i}</div></div>`;
    }

    return `<div class="cal-month-block">
        <div class="cal-month-title">${CAL_MONTHS[month]} ${year}</div>
        <div class="cal-grid">${g}</div>
    </div>`;
}

// â”€â”€ CALENDAR TOOLTIP & MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const calTooltip = document.getElementById('cal-tooltip');

document.addEventListener('mousemove', e => {
    const ev = e.target.closest('.cal-event');
    if (!ev) return;
    calTooltip.style.display = 'block';
    calTooltip.textContent   = ev.getAttribute('data-name') || '';
    const x = e.clientX + 14, y = e.clientY + 14;
    calTooltip.style.left = (x + calTooltip.offsetWidth > window.innerWidth ? x - calTooltip.offsetWidth - 20 : x) + 'px';
    calTooltip.style.top  = (y + calTooltip.offsetHeight > window.innerHeight ? y - calTooltip.offsetHeight - 20 : y) + 'px';
});

document.addEventListener('mouseout', e => {
    if (!e.target.closest('.cal-event')) return;
    calTooltip.style.display = 'none';
});

document.addEventListener('click', e => {
    const ev = e.target.closest('.cal-event');
    if (!ev) return;
    calTooltip.style.display = 'none';
    const key      = decodeURIComponent(ev.getAttribute('data-key') || '');
    const [name, date] = key.split('|');
    const campaign = calData.find(c => c.campaign_name === name && c.send_date === date);
    if (campaign) showCampaignModal(campaign);
});

let _modalCampaignId     = null;
let _modalParentCampaign = null;
let _modalCampaignData   = null;

function showCampaignModal(c) {
    _modalCampaignId     = c.campaign_id;
    _modalParentCampaign = c.parent_campaign || null;
    _modalCampaignData   = c;

    // Parse notes: stored as "P1 Â· Q1FY27 Â· In progress"
    const noteParts = (c.notes || '').split(' Â· ').filter(Boolean);
    const priority  = noteParts.find(p => /^P\d/.test(p)) || '';
    const quarter   = noteParts.find(p => /Q\d/.test(p))  || '';
    const status    = noteParts.find(p => !(/^P\d/.test(p)) && !(/Q\d/.test(p))) || '';

    document.getElementById('cal-modal-content').innerHTML = `
        <div class="cm-header">
            <div class="cm-title">${c.campaign_name}</div>
            <button class="cm-close" onclick="closeCampaignModal()">&#215;</button>
        </div>
        <div class="cm-row"><span class="cm-label">GO LIVE</span>    <span class="cm-value">${c.send_date || 'â€”'}</span></div>
        <div class="cm-row"><span class="cm-label">Category</span>   <span class="cm-value">${badge(c.category)}</span></div>
        ${c.created_by ? `<div class="cm-row"><span class="cm-label">Owner</span>      <span class="cm-value">${c.created_by}</span></div>` : ''}
        ${priority     ? `<div class="cm-row"><span class="cm-label">Priority</span>   <span class="cm-value">${priority}</span></div>` : ''}
        ${quarter      ? `<div class="cm-row"><span class="cm-label">Quarter</span>    <span class="cm-value">${quarter}</span></div>` : ''}
        ${status       ? `<div class="cm-row"><span class="cm-label">Status</span>     <span class="cm-value">${status}</span></div>` : ''}
        <hr class="cm-divider">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <strong style="font-size:13px;">Performance Metrics</strong>
            <button id="mf-save-btn" class="btn-sm" onclick="saveMetrics()">Save Metrics</button>
        </div>
        <div id="mf-metrics-container">${(c.emails_sent_b || c.emails_opened_b || c.emails_clicked_b)
            ? buildABTableHTML(
                { sent: c.emails_sent, opened: c.emails_opened, clicked: c.emails_clicked, unsub: c.unsubscribed, bounced: c.bounced },
                { sent: c.emails_sent_b, opened: c.emails_opened_b, clicked: c.emails_clicked_b, unsub: null, bounced: null }
              )
            : buildSingleTableHTML(c)}</div>
        <div id="mf-ab-link-area"></div>
        <hr class="cm-divider">
        <button class="csv-toggle" onclick="toggleCSVImport()">â†“ Fill from Intercom CSV export</button>
        <div id="mf-csv-body" class="csv-import-body" style="display:none;">
            <p>In Intercom: <strong>Outbound</strong> â†’ open your campaign â†’ <strong>Export</strong>. Drop the file below. A/B variants are detected automatically.</p>
            <div id="mf-drop-zone" class="drop-zone" onclick="document.getElementById('mf-file-input').click()">
                <input type="file" id="mf-file-input" accept=".csv,text/csv" style="display:none;" onchange="handleCSVFile(this.files[0])">
                <div class="drop-zone-icon">&#8613;</div>
                <div class="drop-zone-text">Drop CSV here or <u>click to upload</u></div>
                <div id="mf-file-name" class="drop-zone-filename"></div>
            </div>
            <div id="mf-csv-result" style="margin-top:8px;"></div>
        </div>
    `;
    document.getElementById('cal-modal-overlay').style.display = 'block';
    document.getElementById('cal-modal').style.display = 'block';
    recalcMetrics();
    if (c.emails_sent_b || c.emails_opened_b || c.emails_clicked_b) loadABTestLink(c.campaign_name);
}

function buildSingleTableHTML(c) {
    const sent    = Number(c.emails_sent)    || 0;
    const opened  = Number(c.emails_opened)  || 0;
    const clicked = Number(c.emails_clicked) || 0;
    const repld   = Number(c.replies)        || 0;
    const unsub   = Number(c.unsubscribed)   || 0;
    const bncd    = Number(c.bounced)        || 0;
    const ir = (count, denom, dec, fallback) => {
        if (count > 0 && denom > 0) return (count / denom * 100).toFixed(dec) + '%';
        if (fallback != null)       return (fallback * 100).toFixed(dec) + '%';
        return 'â€”';
    };
    const sentB = Number(c.emails_sent_b) || 0;
    return `<table class="mf-table">
        <thead><tr><th>Metric</th><th>Count</th><th>Rate</th></tr></thead>
        <tbody>
            <tr>
                <td class="mf-row-label">Sent (Variant A)</td>
                <td><input class="mf-input" id="mf-sent" type="number" placeholder="0" value="${sent || ''}" oninput="recalcMetrics()"></td>
                <td></td>
            </tr>
            <tr>
                <td class="mf-row-label" style="color:var(--muted);font-size:11px;">Sent (Variant B)</td>
                <td><input class="mf-input" id="mf-sent-b-extra" type="number" placeholder="0 if no A/B" value="${sentB || ''}" oninput="recalcMetrics()"></td>
                <td style="font-size:11px;color:var(--brand);" id="mf-ab-combined"></td>
            </tr>
            <tr>
                <td class="mf-row-label">Opened</td>
                <td><input class="mf-input" id="mf-opened" type="number" placeholder="0" value="${opened || ''}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-open-rate">${ir(opened,sent,1,c.open_rate)}</span></td>
            </tr>
            <tr>
                <td class="mf-row-label">Clicked</td>
                <td><input class="mf-input" id="mf-clicked" type="number" placeholder="0" value="${clicked || ''}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-click-rate">${ir(clicked,sent,1,c.click_rate)}</span><div class="mf-sub">CTOR: <span id="mf-ctor-rate">${ir(clicked,opened,1,c.click_to_open_rate)}</span></div></td>
            </tr>
            <tr>
                <td class="mf-row-label">Replied</td>
                <td><input class="mf-input" id="mf-replied" type="number" placeholder="0" value="${repld || ''}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-reply-rate">${ir(repld,sent,1,c.reply_rate)}</span></td>
            </tr>
            <tr>
                <td class="mf-row-label">Unsubscribed</td>
                <td><input class="mf-input" id="mf-unsub" type="number" placeholder="0" value="${unsub || ''}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-unsub-rate">${ir(unsub,sent,2,c.unsubscribe_rate)}</span></td>
            </tr>
            <tr>
                <td class="mf-row-label">Bounced</td>
                <td><input class="mf-input" id="mf-bounced" type="number" placeholder="0" value="${bncd || ''}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-bounce-rate">${ir(bncd,sent,2,c.bounce_rate)}</span></td>
            </tr>
        </tbody>
    </table>
`;
}

function buildABTableHTML(dA, dB, nameA, nameB) {
    const v = x => (x != null ? x : '');
    const labelA = nameA || 'Variant A';
    const labelB = nameB || 'Variant B';
    return `<div id="mf-ab-winner" style="margin-bottom:8px;font-size:12px;font-weight:600;min-height:18px;"></div>
    <table class="mf-table mf-table-ab">
        <thead>
            <tr>
                <th>Metric</th>
                <th class="mf-th-a" colspan="2" title="${labelA}">${labelA.length > 22 ? labelA.slice(0,20)+'â€¦' : labelA}</th>
                <th class="mf-th-b" colspan="2" title="${labelB}">${labelB.length > 22 ? labelB.slice(0,20)+'â€¦' : labelB}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="mf-row-label">Total Sent</td>
                <td><input class="mf-input" id="mf-sent-a" type="number" placeholder="0" value="${v(dA.sent)}" oninput="recalcMetrics()"></td>
                <td></td>
                <td><input class="mf-input" id="mf-sent-b" type="number" placeholder="0" value="${v(dB.sent)}" oninput="recalcMetrics()"></td>
                <td></td>
            </tr>
            <tr>
                <td class="mf-row-label">Opened</td>
                <td><input class="mf-input" id="mf-opened-a" type="number" placeholder="0" value="${v(dA.opened)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-open-rate-a">â€”</span></td>
                <td><input class="mf-input" id="mf-opened-b" type="number" placeholder="0" value="${v(dB.opened)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate-b" id="mf-open-rate-b">â€”</span></td>
            </tr>
            <tr>
                <td class="mf-row-label">Clicked</td>
                <td><input class="mf-input" id="mf-clicked-a" type="number" placeholder="0" value="${v(dA.clicked)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-click-rate-a">â€”</span><div class="mf-sub">CTOR: <span id="mf-ctor-rate-a">â€”</span></div></td>
                <td><input class="mf-input" id="mf-clicked-b" type="number" placeholder="0" value="${v(dB.clicked)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate-b" id="mf-click-rate-b">â€”</span><div class="mf-sub">CTOR: <span id="mf-ctor-rate-b">â€”</span></div></td>
            </tr>
            <tr>
                <td class="mf-row-label">Unsubscribed</td>
                <td><input class="mf-input" id="mf-unsub-a" type="number" placeholder="0" value="${v(dA.unsub)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-unsub-rate-a">â€”</span></td>
                <td><input class="mf-input" id="mf-unsub-b" type="number" placeholder="0" value="${v(dB.unsub)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate-b" id="mf-unsub-rate-b">â€”</span></td>
            </tr>
            <tr>
                <td class="mf-row-label">Bounced</td>
                <td><input class="mf-input" id="mf-bounced-a" type="number" placeholder="0" value="${v(dA.bounced)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate" id="mf-bounce-rate-a">â€”</span></td>
                <td><input class="mf-input" id="mf-bounced-b" type="number" placeholder="0" value="${v(dB.bounced)}" oninput="recalcMetrics()"></td>
                <td><span class="mf-rate-b" id="mf-bounce-rate-b">â€”</span></td>
            </tr>
        </tbody>
    </table>`;
}

function switchMetricsToAB(dA, dB, nameA, nameB) {
    document.getElementById('mf-metrics-container').innerHTML = buildABTableHTML(dA, dB, nameA, nameB);
    recalcMetrics();
}

let _metricsWereSaved = false;

function closeCampaignModal() {
    document.getElementById('cal-modal-overlay').style.display = 'none';
    document.getElementById('cal-modal').style.display = 'none';
    if (_metricsWereSaved) {
        _metricsWereSaved = false;
        if (document.getElementById('tab-library').classList.contains('active'))   loadLibrary();
        if (document.getElementById('tab-dashboard').classList.contains('active')) loadDashboard();
    }
}

async function loadABTestLink(campaignName) {
    const area = document.getElementById('mf-ab-link-area');
    if (!area) return;
    const { data } = await db.from('lifecycle_ab_tests').select('test_id,winner,element_tested,winner_notes').eq('test_name', campaignName).limit(1);
    if (!area) return; // modal may have closed
    if (data && data.length > 0) {
        const t = data[0];
        const winnerLabel = t.winner && t.winner !== 'N' ? `Variant ${t.winner} won` : '';
        const hasInsights = !!(t.element_tested || t.winner_notes);
        area.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0 4px;">
            <span style="font-size:12px;color:var(--muted);">A/B test logged${winnerLabel ? ` Â· <span style="color:var(--success);font-weight:600;">âœ“ ${winnerLabel}</span>` : ''}${hasInsights ? ' Â· insights added' : ' Â· no insights yet'}</span>
            <button class="btn-sm" onclick="openABTestFromCampaign('${t.test_id}')">${hasInsights ? 'â†’ View A/B insights' : '+ Add insights'}</button>
        </div>`;
    } else {
        area.innerHTML = `<div style="padding:10px 0 4px;">
            <button class="btn-sm" onclick="createAndOpenABTest()" style="color:var(--brand);border-color:var(--brand);">+ Log this as an A/B test â†’</button>
        </div>`;
    }
}

async function openABTestFromCampaign(testId) {
    const { data } = await db.from('lifecycle_ab_tests').select('*').eq('test_id', testId).limit(1);
    if (data && data.length > 0) showABTestModal(data[0]);
}

async function createAndOpenABTest() {
    const c = _modalCampaignData;
    if (!c) return;
    const rate = (n, d) => (n && d) ? n / d : null;
    const row = {
        test_name:            c.campaign_name,
        test_date:            c.send_date || null,
        variant_a_open_rate:  c.open_rate,
        variant_a_click_rate: c.click_rate,
        variant_b_open_rate:  c.emails_opened_b && c.emails_sent_b ? c.emails_opened_b / c.emails_sent_b : null,
        variant_b_click_rate: c.emails_clicked_b && c.emails_sent_b ? c.emails_clicked_b / c.emails_sent_b : null,
        sent_a:               c.emails_sent || null,
        sent_b:               c.emails_sent_b || null,
    };
    const aw = autoDetectWinner(row);
    if (aw.pick !== 'N') row.winner = aw.pick;
    const { data, error } = await db.from('lifecycle_ab_tests').insert(row).select().single();
    if (error || !data) { alert('Error creating A/B test record: ' + (error?.message || 'unknown')); return; }
    // Update the link area to reflect it now exists
    loadABTestLink(c.campaign_name);
    showABTestModal(data);
}

function recalcMetrics() {
    const fmt = (n, d, dec = 1) => d > 0 ? (n / d * 100).toFixed(dec) + '%' : 'â€”';
    const gi  = id => parseInt(document.getElementById(id)?.value) || 0;

    if (document.getElementById('mf-sent-a')) {
        // AB mode
        const sA = gi('mf-sent-a'), oA = gi('mf-opened-a'), cA = gi('mf-clicked-a'), uA = gi('mf-unsub-a'), bA = gi('mf-bounced-a');
        const sB = gi('mf-sent-b'), oB = gi('mf-opened-b'), cB = gi('mf-clicked-b'), uB = gi('mf-unsub-b'), bB = gi('mf-bounced-b');
        document.getElementById('mf-open-rate-a').textContent   = fmt(oA, sA);
        document.getElementById('mf-click-rate-a').textContent  = fmt(cA, sA);
        document.getElementById('mf-ctor-rate-a').textContent   = fmt(cA, oA);
        document.getElementById('mf-unsub-rate-a').textContent  = fmt(uA, sA, 2);
        document.getElementById('mf-bounce-rate-a').textContent = fmt(bA, sA, 2);
        document.getElementById('mf-open-rate-b').textContent   = fmt(oB, sB);
        document.getElementById('mf-click-rate-b').textContent  = fmt(cB, sB);
        document.getElementById('mf-ctor-rate-b').textContent   = fmt(cB, oB);
        document.getElementById('mf-unsub-rate-b').textContent  = fmt(uB, sB, 2);
        document.getElementById('mf-bounce-rate-b').textContent = fmt(bB, sB, 2);
        // Winner callout
        const winnerEl = document.getElementById('mf-ab-winner');
        if (winnerEl && sA && sB) {
            const crA = sA ? cA / sA : 0, crB = sB ? cB / sB : 0;
            const orA = sA ? oA / sA : 0, orB = sB ? oB / sB : 0;
            const useClick = cA > 0 || cB > 0;
            const rA = useClick ? crA : orA, rB = useClick ? crB : orB;
            const metric = useClick ? 'click rate' : 'open rate';
            const thA = document.querySelector('.mf-th-a')?.textContent || 'Variant A';
            const thB = document.querySelector('.mf-th-b')?.textContent || 'Variant B';
            if (rA > 0 || rB > 0) {
                if (Math.abs(rA - rB) < 0.001) {
                    winnerEl.innerHTML = `<span style="color:var(--muted);">âš–ï¸ Too close to call on ${metric}</span>`;
                } else if (rA > rB) {
                    winnerEl.innerHTML = `<span style="color:var(--success);">ðŸ† ${thA} winning on ${metric} (${(rA*100).toFixed(1)}% vs ${(rB*100).toFixed(1)}%)</span>`;
                } else {
                    winnerEl.innerHTML = `<span style="color:var(--brand);">ðŸ† ${thB} winning on ${metric} (${(rB*100).toFixed(1)}% vs ${(rA*100).toFixed(1)}%)</span>`;
                }
            } else { winnerEl.innerHTML = ''; }
        }
    } else {
        // Single mode
        const sent = gi('mf-sent'), opened = gi('mf-opened'), clicked = gi('mf-clicked');
        const repld = gi('mf-replied'), unsub = gi('mf-unsub'), bncd = gi('mf-bounced');
        document.getElementById('mf-open-rate').textContent   = fmt(opened,  sent);
        document.getElementById('mf-click-rate').textContent  = fmt(clicked, sent);
        document.getElementById('mf-ctor-rate').textContent   = fmt(clicked, opened);
        document.getElementById('mf-reply-rate').textContent  = fmt(repld,   sent);
        document.getElementById('mf-unsub-rate').textContent  = fmt(unsub,   sent, 2);
        document.getElementById('mf-bounce-rate').textContent = fmt(bncd,    sent, 2);
        const sentB = gi('mf-sent-b-extra');
        const combined = document.getElementById('mf-ab-combined');
        if (combined) combined.textContent = (sentB > 0 && sent > 0) ? `Total: ${(sent + sentB).toLocaleString()}` : '';
    }
}

async function saveMetrics() {
    if (!_modalCampaignId) return;
    const gi  = id => parseInt(document.getElementById(id)?.value) || null;
    const isAB = !!document.getElementById('mf-sent-a');
    let update;

    if (isAB) {
        const sA = gi('mf-sent-a'), oA = gi('mf-opened-a'), cA = gi('mf-clicked-a');
        const uA = gi('mf-unsub-a'), bA = gi('mf-bounced-a');
        const sB = gi('mf-sent-b'), oB = gi('mf-opened-b'), cB = gi('mf-clicked-b');
        // Save variant A as primary rates for benchmarks; save all raw counts
        update = {
            emails_sent:        sA,
            emails_opened:      oA,
            emails_clicked:     cA,
            unsubscribed:       uA,
            bounced:            bA,
            open_rate:          (sA && oA) ? oA / sA : null,
            click_rate:         (sA && cA) ? cA / sA : null,
            click_to_open_rate: (oA && cA) ? cA / oA : null,
            unsubscribe_rate:   (sA && uA) ? uA / sA : null,
            bounce_rate:        (sA && bA) ? bA / sA : null,
            // Store variant B sent/opened/clicked if columns exist (run migration SQL below)
            emails_sent_b:    sB,
            emails_opened_b:  oB,
            emails_clicked_b: cB,
        };
    } else {
        const sent = gi('mf-sent'), opened = gi('mf-opened'), clicked = gi('mf-clicked');
        const repld = gi('mf-replied'), unsub = gi('mf-unsub'), bncd = gi('mf-bounced');
        const sentB = gi('mf-sent-b-extra');
        update = {
            emails_sent:        sent,
            emails_opened:      opened,
            emails_clicked:     clicked,
            replies:            repld,
            unsubscribed:       unsub,
            bounced:            bncd,
            emails_sent_b:      sentB || null,
            open_rate:          (sent && opened)   ? opened  / sent   : null,
            click_rate:         (sent && clicked)  ? clicked / sent   : null,
            click_to_open_rate: (opened && clicked)? clicked / opened : null,
            reply_rate:         (sent && repld)    ? repld   / sent   : null,
            unsubscribe_rate:   (sent && unsub)    ? unsub   / sent   : null,
            bounce_rate:        (sent && bncd)     ? bncd    / sent   : null,
        };
    }

    const btn = document.getElementById('mf-save-btn');
    btn.textContent = 'Saving...';

    const { error } = await db.from('lifecycle_campaigns').update(update).eq('campaign_id', _modalCampaignId);

    if (error) {
        // If AB columns don't exist yet, retry without them
        if (isAB && error.message && error.message.includes('emails_sent_b')) {
            delete update.emails_sent_b; delete update.emails_opened_b; delete update.emails_clicked_b;
            const { error: e2 } = await db.from('lifecycle_campaigns').update(update).eq('campaign_id', _modalCampaignId);
            if (e2) { btn.textContent = 'Error!'; btn.style.color = '#fca5a5'; setTimeout(() => { btn.textContent = 'Save Metrics'; btn.style.color = ''; }, 3000); return; }
        } else {
            btn.textContent = 'Error saving!';
            btn.style.color = '#fca5a5';
            setTimeout(() => { btn.textContent = 'Save Metrics'; btn.style.color = ''; }, 3000);
            return;
        }
    }

    // Update in-memory calData so reopening the modal shows latest values
    const idx = calData.findIndex(c => c.campaign_id === _modalCampaignId);
    if (idx >= 0) Object.assign(calData[idx], update);

    btn.textContent = 'âœ“ Saved!';
    btn.style.color = 'var(--success)';
    setTimeout(() => { btn.textContent = 'Save Metrics'; btn.style.color = ''; }, 2500);

    _metricsWereSaved = true;

    // If this is a sub-row, roll metrics up to the parent campaign
    if (_modalParentCampaign) await aggregateToParent(_modalParentCampaign);

    // Refresh whichever tab is currently visible
    if (document.getElementById('tab-dashboard').classList.contains('active')) loadDashboard();
    if (document.getElementById('tab-library').classList.contains('active'))   loadLibrary();
}

async function aggregateToParent(parentName) {
    // Sum metrics across all sub-rows belonging to this parent
    const { data: siblings } = await db.from('lifecycle_campaigns')
        .select('emails_sent, emails_opened, emails_clicked, unsubscribed, bounced')
        .eq('parent_campaign', parentName);
    if (!siblings || !siblings.length) return;

    const sum = field => siblings.reduce((acc, c) => acc + (c[field] || 0), 0);
    const sent    = sum('emails_sent');
    const opened  = sum('emails_opened');
    const clicked = sum('emails_clicked');
    const unsub   = sum('unsubscribed');
    const bounced = sum('bounced');

    const parentUpdate = {
        emails_sent:        sent    || null,
        emails_opened:      opened  || null,
        emails_clicked:     clicked || null,
        unsubscribed:       unsub   || null,
        bounced:            bounced || null,
        open_rate:          (sent && opened)   ? opened  / sent   : null,
        click_rate:         (sent && clicked)  ? clicked / sent   : null,
        click_to_open_rate: (opened && clicked)? clicked / opened : null,
        unsubscribe_rate:   (sent && unsub)    ? unsub   / sent   : null,
        bounce_rate:        (sent && bounced)  ? bounced / sent   : null,
    };

    // Find the parent row by name and update it
    const { data: parents } = await db.from('lifecycle_campaigns')
        .select('campaign_id')
        .eq('campaign_name', parentName)
        .is('parent_campaign', null);
    if (parents && parents.length) {
        await db.from('lifecycle_campaigns').update(parentUpdate).eq('campaign_id', parents[0].campaign_id);
    }
}

// â”€â”€ OPEN CAMPAIGN BY ID (Library / Dashboard) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openCampaignById(id) {
    let campaign = calData.find(c => c.campaign_id === id);
    if (!campaign) {
        const { data } = await db.from('lifecycle_campaigns').select('*').eq('campaign_id', id).single();
        campaign = data;
    }
    if (campaign) showCampaignModal(campaign);
}

// â”€â”€ CSV IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCSVImport() {
    const body = document.getElementById('mf-csv-body');
    const btn  = document.querySelector('.csv-toggle');
    const open = body.style.display === 'none';
    body.style.display = open ? 'block' : 'none';
    btn.textContent    = open ? 'â†‘ Hide CSV import' : 'â†“ Fill from Intercom CSV export';
    if (open) initDropZone();
}

function initDropZone() {
    const zone = document.getElementById('mf-drop-zone');
    if (!zone || zone._init) return;
    zone._init = true;
    zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', e => { if (!zone.contains(e.relatedTarget)) zone.classList.remove('drag-over'); });
    zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) handleCSVFile(file);
    });
}

let _lastCSVText = null;

function handleCSVFile(file) {
    if (!file) return;
    document.getElementById('mf-file-name').textContent = 'ðŸ“„ ' + file.name;
    const reader = new FileReader();
    reader.onload = e => { _lastCSVText = e.target.result; processCSVText(e.target.result); };
    reader.readAsText(file);
}

function normalizeStr(s) {
    return (s || '').toLowerCase().replace(/[^a-z0-9 ]/g, ' ').replace(/\s+/g, ' ').trim();
}

function extractCSVNames(csvText) {
    const lines = csvText.trim().split('\n').filter(l => l.trim());
    if (lines.length < 2) return [];
    const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
    const nameIdx = ['name','title','campaign','message','subject'].reduce((found, n) => {
        if (found >= 0) return found;
        const i = headers.findIndex(h => h.includes(n)); return i >= 0 ? i : -1;
    }, -1);
    if (nameIdx < 0) return [];
    return lines.slice(1).map(l => parseCSVLine(l)[nameIdx]).filter(Boolean);
}

function processCSVText(csvText) {
    const campaignName = document.querySelector('#cal-modal-content .cm-title')?.textContent || '';
    const resultDiv    = document.getElementById('mf-csv-result');
    const result       = parseIntercomCSV(csvText, campaignName);

    if (!result) {
        const allNames = extractCSVNames(csvText);
        window._csvAllNames = allNames;
        resultDiv.innerHTML = `
            <p style="color:#fca5a5;font-size:12px;margin-bottom:8px;">No automatic match for "<strong>${campaignName}</strong>".</p>
            ${allNames.length ? `
            <p style="font-size:12px;color:var(--muted);margin-bottom:6px;">Click one email to use it, or check multiple to combine into overall campaign totals:</p>
            <div style="display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto;" id="csv-name-list">
                ${allNames.map((n, i) => `
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" class="csv-row-check" data-idx="${i}" onchange="updateCombineBtn()" style="cursor:pointer;accent-color:var(--brand);flex-shrink:0;">
                    <button class="btn-sm" style="text-align:left;white-space:normal;height:auto;padding:5px 10px;flex:1;" onclick="manualCSVMatch(${i})">${n}</button>
                </div>`).join('')}
            </div>
            <button class="btn btn-primary" id="csv-combine-btn" style="display:none;margin-top:8px;font-size:12px;padding:6px 14px;" onclick="combineCSVMatches()">Combine selected</button>
            ` : '<p style="font-size:12px;color:var(--muted);">No campaign names found in the CSV â€” check the file format.</p>'}
        `;
        return;
    }
    if (result.type === 'single') {
        fillMetricInputs(result.data);
        recalcMetrics();
        resultDiv.innerHTML = `<p style="color:var(--success);font-size:12px;">âœ“ Metrics filled â€” review above and hit Save Metrics.</p>`;
    } else {
        showABDetected(result, resultDiv);
    }
}

function manualCSVMatch(idx) {
    const name = (window._csvAllNames || [])[idx];
    if (!name || !_lastCSVText) return;
    const resultDiv = document.getElementById('mf-csv-result');
    const result    = parseIntercomCSV(_lastCSVText, name);
    if (!result) { resultDiv.innerHTML = `<p style="color:#fca5a5;font-size:12px;">Could not parse data for "${name}".</p>`; return; }
    if (result.type === 'single') {
        fillMetricInputs(result.data);
        recalcMetrics();
        resultDiv.innerHTML = `<p style="color:var(--success);font-size:12px;">âœ“ Matched to "<strong>${name}</strong>" â€” review metrics above and hit Save Metrics.</p>`;
    } else {
        showABDetected(result, resultDiv);
    }
}

function updateCombineBtn() {
    const checked = document.querySelectorAll('.csv-row-check:checked');
    const btn = document.getElementById('csv-combine-btn');
    if (!btn) return;
    if (checked.length >= 2) {
        btn.style.display = 'block';
        btn.textContent = `Combine ${checked.length} emails into overall totals`;
    } else {
        btn.style.display = 'none';
    }
}

function combineCSVMatches() {
    if (!_lastCSVText) return;
    const checked = [...document.querySelectorAll('.csv-row-check:checked')];
    if (checked.length < 2) return;
    const resultDiv = document.getElementById('mf-csv-result');

    // If exactly 2 selected, check if they're A/B variants of the same campaign
    if (checked.length === 2) {
        const abRe = s => (s || '').match(/\s*[-â€“â€”(]?\s*(variant|version|test|v)?\s*([ab])\s*\)?$/i);
        const names = checked.map(cb => (window._csvAllNames || [])[parseInt(cb.dataset.idx)] || '');
        const nameA = names.find(n => { const m = abRe(n); return m && m[2].toLowerCase() === 'a'; });
        const nameB = names.find(n => { const m = abRe(n); return m && m[2].toLowerCase() === 'b'; });
        if (nameA && nameB) {
            const rA = parseIntercomCSV(_lastCSVText, nameA);
            const rB = parseIntercomCSV(_lastCSVText, nameB);
            const dA = rA ? (rA.type === 'single' ? rA.data : rA.variantA?.data) : null;
            const dB = rB ? (rB.type === 'single' ? rB.data : rB.variantB?.data) : null;
            if (dA && dB) {
                showABDetected({ type: 'ab', variantA: { name: nameA, data: dA }, variantB: { name: nameB, data: dB } }, resultDiv);
                return;
            }
        }
    }

    const combined = { sent: null, opened: null, clicked: null, replied: null, unsub: null, bounced: null };
    const usedNames = [];

    for (const cb of checked) {
        const idx  = parseInt(cb.dataset.idx);
        const name = (window._csvAllNames || [])[idx];
        if (!name) continue;
        const result = parseIntercomCSV(_lastCSVText, name);
        if (!result) continue;
        let d;
        if (result.type === 'single') {
            d = result.data;
        } else if (result.type === 'ab') {
            // A/B row â€” sum both variants into combined totals
            const dA = result.variantA.data, dB = result.variantB.data;
            d = {
                sent:    ((dA.sent    || 0) + (dB.sent    || 0)) || null,
                opened:  ((dA.opened  || 0) + (dB.opened  || 0)) || null,
                clicked: ((dA.clicked || 0) + (dB.clicked || 0)) || null,
                replied: ((dA.replied || 0) + (dB.replied || 0)) || null,
                unsub:   ((dA.unsub   || 0) + (dB.unsub   || 0)) || null,
                bounced: ((dA.bounced || 0) + (dB.bounced || 0)) || null,
            };
        } else { continue; }
        usedNames.push(name);
        if (d.sent    != null) combined.sent    = (combined.sent    ?? 0) + d.sent;
        if (d.opened  != null) combined.opened  = (combined.opened  ?? 0) + d.opened;
        if (d.clicked != null) combined.clicked = (combined.clicked ?? 0) + d.clicked;
        if (d.replied != null) combined.replied = (combined.replied ?? 0) + d.replied;
        if (d.unsub   != null) combined.unsub   = (combined.unsub   ?? 0) + d.unsub;
        if (d.bounced != null) combined.bounced = (combined.bounced ?? 0) + d.bounced;
    }

    if (combined.sent === null) {
        const csvHeaders = (_lastCSVText || '').trim().split('\n')[0] || '';
        resultDiv.innerHTML = `<p style="color:#fca5a5;font-size:12px;margin-bottom:6px;">Could not read a sent count from these rows.</p>
            <p style="font-size:11px;color:var(--muted);">CSV columns detected: <code style="background:#1e293b;padding:2px 5px;border-radius:3px;font-size:10px;">${csvHeaders.substring(0, 300)}</code></p>
            <p style="font-size:11px;color:var(--muted);margin-top:4px;">Expected a column containing: receipts, sent, delivered, or recipients.</p>`;
        return;
    }

    fillMetricInputs(combined);
    recalcMetrics();
    resultDiv.innerHTML = `<p style="color:var(--success);font-size:12px;">âœ“ Combined totals from ${usedNames.length} email${usedNames.length !== 1 ? 's' : ''} â€” review metrics above and hit Save Metrics.</p>`;
}

function fillMetricInputs(d) {
    if (d.sent    !== null) document.getElementById('mf-sent').value    = d.sent;
    if (d.opened  !== null) document.getElementById('mf-opened').value  = d.opened;
    if (d.clicked !== null) document.getElementById('mf-clicked').value = d.clicked;
    if (d.replied !== null) document.getElementById('mf-replied').value = d.replied;
    if (d.unsub   !== null) document.getElementById('mf-unsub').value   = d.unsub;
    if (d.bounced !== null) document.getElementById('mf-bounced').value = d.bounced;
}

function showABDetected(result, container) {
    window._abCSVData = { ...result, campaignName: document.querySelector('#cal-modal-content .cm-title')?.textContent || '' };
    // Auto-switch the metrics table to side-by-side AB view, passing actual variant names
    switchMetricsToAB(result.variantA.data, result.variantB.data, result.variantA.name, result.variantB.name);
    const preA = result.variantA.data?.subject || '';
    const preB = result.variantB.data?.subject || '';
    container.innerHTML = `
        <div class="ab-box" style="padding:10px 14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <span style="font-size:12px;font-weight:700;color:var(--brand);">âš¡ A/B test detected â€” both variants filled above</span>
                <button class="btn btn-primary" style="font-size:12px;padding:6px 14px;" onclick="saveAsABTest()">Save to A/B Tests &#8594;</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
                <div>
                    <div style="font-size:10px;font-weight:700;color:var(--brand);margin-bottom:3px;">VARIANT A SUBJECT LINE</div>
                    <input id="ab-subject-a" type="text" placeholder="e.g. Your CX Score is ready" value="${preA}" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-size:12px;color:var(--text);">
                </div>
                <div>
                    <div style="font-size:10px;font-weight:700;color:#86efac;margin-bottom:3px;">VARIANT B SUBJECT LINE</div>
                    <input id="ab-subject-b" type="text" placeholder="e.g. Here's how customers rate us" value="${preB}" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-size:12px;color:var(--text);">
                </div>
            </div>
            <div id="ab-save-msg" style="font-size:12px;margin-top:6px;"></div>
        </div>`;
}


async function saveAsABTest() {
    const d = window._abCSVData; if (!d) return;
    const a = d.variantA, b = d.variantB;
    const rate = (count, sent) => (count && sent) ? count / sent : null;
    // Grab send date from modal
    const dateEl = document.querySelector('#cal-modal-content .cm-row .cm-value');
    const sendDate = dateEl && dateEl.textContent !== 'â€”' ? dateEl.textContent : null;

    const msg = document.getElementById('ab-save-msg');

    // Check for existing record with same name to avoid duplicates
    const { data: existing } = await db.from('lifecycle_ab_tests').select('test_id').eq('test_name', d.campaignName).limit(1);
    if (existing && existing.length > 0) {
        msg.style.color = 'var(--muted)';
        msg.textContent = 'âœ“ Already saved to A/B Tests tab.';
        return;
    }

    const subjectA = document.getElementById('ab-subject-a')?.value.trim() || a.data.subject || null;
    const subjectB = document.getElementById('ab-subject-b')?.value.trim() || b.data.subject || null;
    const row = {
        test_name:            d.campaignName,
        test_date:            sendDate,
        variant_a_name:       a.name,
        variant_a_open_rate:  rate(a.data.opened,  a.data.sent),
        variant_a_click_rate: rate(a.data.clicked, a.data.sent),
        variant_a_content:    subjectA,
        variant_b_name:       b.name,
        variant_b_open_rate:  rate(b.data.opened,  b.data.sent),
        variant_b_click_rate: rate(b.data.clicked, b.data.sent),
        variant_b_content:    subjectB,
        sent_a:               a.data.sent || null,
        sent_b:               b.data.sent || null,
    };
    // Auto-detect winner
    const aw = autoDetectWinner({ variant_a_click_rate: row.variant_a_click_rate, variant_b_click_rate: row.variant_b_click_rate, variant_a_open_rate: row.variant_a_open_rate, variant_b_open_rate: row.variant_b_open_rate });
    if (aw.pick !== 'N') row.winner = aw.pick;

    const { error } = await db.from('lifecycle_ab_tests').insert(row);
    if (error) { msg.style.color = '#fca5a5'; msg.textContent = 'Error: ' + error.message; return; }
    msg.style.color = 'var(--success)';
    msg.textContent = 'âœ“ Saved to A/B Tests tab â€” click the row to add element tested, hypothesis & notes.';
}

function parseCSVLine(line) {
    const result = []; let current = ''; let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') { inQuotes = !inQuotes; }
        else if (line[i] === ',' && !inQuotes) { result.push(current.trim().replace(/^"|"$/g, '')); current = ''; }
        else { current += line[i]; }
    }
    result.push(current.trim().replace(/^"|"$/g, ''));
    return result;
}

function parseIntercomCSV(csvText, campaignName) {
    const lines = csvText.trim().split('\n').filter(l => l.trim());
    if (lines.length < 2) return null;

    const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
    const col = (...names) => { for (const n of names) { const i = headers.findIndex(h => h.includes(n)); if (i >= 0) return i; } return -1; };

    const nameIdx    = col('name', 'title', 'campaign', 'message', 'subject');
    const subjectIdx = (() => {
        // Find a subject line column that's distinct from the name column
        const idx = col('subject_line', 'email subject', 'subject');
        return idx !== nameIdx ? idx : -1;
    })();
    const sentIdx  = col('receipt_total', 'receipts', 'total sent', 'sent', 'delivered', 'recipient', 'delivery');
    const openIdx  = col('open_total', 'total open', 'unique open', 'opens', 'opened');
    const clickIdx = col('click_total', 'total click', 'unique click', 'link click', 'clicks', 'clicked');
    const replyIdx = col('reply_total', 'total repl', 'replies', 'replied');
    const unsubIdx = col('unsubscribe_total', 'unsubscribes', 'unsubscribed', 'unsub');
    const hbIdx    = col('hard_bounce', 'hard bounce');
    const sbIdx    = col('soft_bounce', 'soft bounce');
    const bounceIdx= col('bounce_total', 'bounces', 'total bounce');

    // Parse a cell â€” handles both plain values and "valueA / valueB" inline A/B format
    const parseCell = (idx, cells) => {
        if (idx < 0 || !cells[idx]) return { val: null };
        const raw = cells[idx].trim();
        const slashMatch = raw.match(/^([0-9,.\s]+%?)\s*\/\s*([0-9,.\s]+%?)$/);
        if (slashMatch) {
            const toInt = s => { const n = parseInt(s.replace(/[^0-9]/g, '')); return isNaN(n) ? null : n; };
            return { a: toInt(slashMatch[1]), b: toInt(slashMatch[2]), isAB: true };
        }
        const n = parseInt(raw.replace(/[^0-9]/g, ''));
        return { val: isNaN(n) ? null : n };
    };

    const getRowData = cells => {
        const sent  = parseCell(sentIdx,  cells);
        const open  = parseCell(openIdx,  cells);
        const click = parseCell(clickIdx, cells);
        const reply = parseCell(replyIdx, cells);
        const unsub = parseCell(unsubIdx, cells);
        const hb    = parseCell(hbIdx,    cells);
        const sb    = parseCell(sbIdx,    cells);
        const bc    = parseCell(bounceIdx,cells);
        const subject = subjectIdx >= 0 ? (cells[subjectIdx] || '').trim() || null : null;

        const hasAB = [sent, open, click, reply, unsub, hb, sb, bc].some(c => c.isAB);

        const bounceFor = side => {
            const bv  = bc.isAB  ? bc[side]  : bc.val;
            const hbv = hb.isAB  ? hb[side]  : hb.val;
            const sbv = sb.isAB  ? sb[side]  : sb.val;
            return bv !== null ? bv : (hbv !== null || sbv !== null ? (hbv||0)+(sbv||0) : null);
        };
        const get = (cell, side) => cell.isAB ? cell[side] : cell.val;

        if (hasAB) {
            return {
                isAB: true,
                a: { sent: get(sent,'a'), opened: get(open,'a'), clicked: get(click,'a'), replied: get(reply,'a'), unsub: get(unsub,'a'), bounced: bounceFor('a'), subject },
                b: { sent: get(sent,'b'), opened: get(open,'b'), clicked: get(click,'b'), replied: get(reply,'b'), unsub: get(unsub,'b'), bounced: bounceFor('b'), subject },
            };
        }
        const bv = bc.val, hbv = hb.val, sbv = sb.val;
        return { isAB: false, sent: sent.val, opened: open.val, clicked: click.val, replied: reply.val, unsub: unsub.val, bounced: bv !== null ? bv : (hbv !== null || sbv !== null ? (hbv||0)+(sbv||0) : null), subject };
    };

    const nameLower = (campaignName || '').toLowerCase().trim();
    const nameNorm  = normalizeStr(campaignName);
    // Strip common A/B suffixes to get base name for comparison
    const stripAB = s => s.replace(/\s*[-â€“â€”(]?\s*(variant|version|test|v)?\s*[ab]\s*\)?$/i, '').trim();
    const matches = [];

    for (let i = 1; i < lines.length; i++) {
        const cells   = parseCSVLine(lines[i]);
        const rowName = (nameIdx >= 0 ? cells[nameIdx] || '' : '').toLowerCase().trim();
        if (!rowName) continue;
        const rowBase = stripAB(rowName);
        const rowNorm = normalizeStr(rowName);
        const baseNorm= normalizeStr(rowBase);
        // Match on raw lowercase OR normalized (strips punctuation differences)
        if (rowName === nameLower || rowName.includes(nameLower) || nameLower.includes(rowBase) || rowBase === nameLower ||
            rowNorm === nameNorm  || rowNorm.includes(nameNorm)  || nameNorm.includes(baseNorm) || baseNorm === nameNorm) {
            matches.push({ name: nameIdx >= 0 ? cells[nameIdx] : rowName, rowName, data: getRowData(cells) });
        }
    }

    if (!matches.length) return null;

    // Case 1: single row with inline "valueA / valueB" format in cells
    const best = matches.find(m => m.rowName === nameLower) || matches[0];
    if (best.data.isAB) {
        return { type: 'ab', variantA: { name: 'Variant A', data: best.data.a }, variantB: { name: 'Variant B', data: best.data.b } };
    }

    // Case 2: two separate rows each with an A/B suffix
    if (matches.length === 2) {
        const abRe = s => s.match(/\s*[-â€“â€”(]?\s*(variant|version|test|v)?\s*([ab])\s*\)?$/i);
        const mA = matches.find(m => { const r = abRe(m.rowName); return r && r[2].toLowerCase() === 'a'; });
        const mB = matches.find(m => { const r = abRe(m.rowName); return r && r[2].toLowerCase() === 'b'; });
        if (mA && mB) return { type: 'ab', variantA: mA, variantB: mB };
    }

    // Single match
    return { type: 'single', data: best.data };
}

// â”€â”€ CODA SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSyncToast(msg) {
    let toast = document.getElementById('sync-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'sync-toast';
        toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:#064e3b;color:#6ee7b7;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;z-index:300;box-shadow:0 4px 12px rgba(0,0,0,0.4);opacity:0;transition:opacity 0.4s;';
        document.body.appendChild(toast);
    }
    toast.textContent = msg;
    toast.style.opacity = '1';
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => { toast.style.opacity = '0'; }, 3500);
}

async function silentSyncFromCoda() {
    let rows;
    try { rows = await fetchAllCodaRows(); } catch(e) { return; }

    const withDate = rows.filter(r => r.values['c-qZ5pWze-qr']);
    if (!withDate.length) return;

    const { data: existing } = await db.from('lifecycle_campaigns').select('campaign_name, send_date');
    const existingKeys = new Set((existing || []).map(c => `${c.campaign_name}|${c.send_date}`));

    const allParsed = withDate.map(r => {
        const v        = r.values;
        const name     = v['c-Uv4zbhft7s'] || '';
        const goLive   = v['c-qZ5pWze-qr'] ? v['c-qZ5pWze-qr'].substring(0, 10) : null;
        const category = mapCategory(v['c-koILJsOuMY']);
        const status   = v['c-OrOut2KsHe'] || '';
        const priority = v['c-wP0h7clHiB'] || '';
        const owners   = Array.isArray(v['c-z1Wau-qigr']) ? v['c-z1Wau-qigr'].join(', ') : (v['c-z1Wau-qigr'] || '');
        const quarter  = v['c-IWAEuAT3lX'] || '';
        const parent   = (v['c-qIJvrFxXkv'] && v['c-qIJvrFxXkv'] !== '') ? v['c-qIJvrFxXkv'] : null;
        return { name, goLive, category, status, priority, owners, quarter, parent };
    }).filter(r => r.name && r.goLive);

    // Deduplicate within Coda results then filter to genuinely new
    const _seen = new Set();
    const allDeduped = allParsed.filter(r => {
        const k = `${r.name}|${r.goLive}`;
        if (_seen.has(k)) return false;
        _seen.add(k);
        return true;
    });
    const newOnes = allDeduped.filter(r => !existingKeys.has(`${r.name}|${r.goLive}`));

    // Insert new rows
    if (newOnes.length) {
        const insertRows = newOnes.map(r => ({
            campaign_name:    r.name,
            category:         r.category,
            channel:          'Email',
            send_date:        r.goLive,
            created_by:       r.owners || null,
            notes:            [r.priority, r.quarter, r.status].filter(Boolean).join(' Â· ') || null,
            parent_campaign:  r.parent || null,
        }));
        const { error } = await db.from('lifecycle_campaigns').insert(insertRows);
        if (error) return;
        showSyncToast(`â†“ Synced ${newOnes.length} new campaign${newOnes.length > 1 ? 's' : ''} from Coda`);
    }

    // Always backfill parent_campaign on existing records from Coda data
    const withParent = allDeduped.filter(r => r.parent && r.name);
    await Promise.all(withParent.map(r =>
        db.from('lifecycle_campaigns').update({ parent_campaign: r.parent }).eq('campaign_name', r.name)
    ));

    await loadCalendar();
}

const CODA_TOKEN  = '26173d1f-8559-40b2-bbce-816dc69b748d';
const CODA_DOC    = 'rBVmIdYxXi';
const CODA_TABLE  = 'grid-aOeRahcrzU'; // FY27 Roadmap

const LIFECYCLE_MAP = {
    'launches': 'Launches', 'launch': 'Launches',
    'early lifecycle': 'Early lifecycle', 'early stage': 'Early lifecycle', 'activation': 'Early lifecycle', 'onboarding': 'Early lifecycle',
    'usage': 'Usage', 'nurture': 'Usage',
    'events': 'Events', 'event': 'Events', 'csm webinar': 'Events', 'webinar': 'Events', 'community': 'Events',
    'acquisition': 'Acquisition',
    'adhoc': 'Adhoc',
    'expansion': 'Expansion',
    'fin sa': 'Fin SA',
    'migrations': 'Migrations',
    'newsletter': 'Newsletter',
    'ops': 'Ops',
};

function mapCategory(lifecycle) {
    if (!lifecycle) return 'Nurture';
    const arr = Array.isArray(lifecycle) ? lifecycle : [lifecycle];
    for (const l of arr) {
        const mapped = LIFECYCLE_MAP[(l || '').toLowerCase().trim()];
        if (mapped) return mapped;
    }
    return arr[0] || 'Nurture';
}

async function fetchAllCodaRows() {
    let rows = [], pageToken = null;
    do {
        const url = `https://coda.io/apis/v1/docs/${CODA_DOC}/tables/${CODA_TABLE}/rows?limit=500&valueFormat=simpleWithArrays${pageToken ? '&pageToken=' + pageToken : ''}`;
        const res = await fetch(url, { headers: { Authorization: `Bearer ${CODA_TOKEN}` } });
        const data = await res.json();
        rows = rows.concat(data.items || []);
        pageToken = data.nextPageToken || null;
    } while (pageToken);
    return rows;
}

async function syncFromCoda() {
    const panel = document.getElementById('coda-sync-panel');
    panel.style.display = 'block';
    panel.innerHTML = `<div class="sync-panel"><p style="color:var(--muted);font-size:13px;">Fetching from Coda FY27 Roadmap...</p></div>`;

    let rows;
    try {
        rows = await fetchAllCodaRows();
    } catch(e) {
        panel.innerHTML = `<div class="sync-panel"><div class="alert alert-error">Failed to connect to Coda: ${e.message}</div></div>`;
        return;
    }

    // Filter to rows with a GO LIVE date
    const withDate = rows.filter(r => r.values['c-qZ5pWze-qr']);

    if (!withDate.length) {
        panel.innerHTML = `<div class="sync-panel"><p style="color:var(--muted);font-size:13px;">No campaigns with a GO LIVE date found in the FY27 Roadmap.</p></div>`;
        return;
    }

    // Fetch existing campaigns from Supabase to check for duplicates
    const { data: existing } = await db.from('lifecycle_campaigns').select('campaign_name, send_date');
    const existingKeys = new Set((existing || []).map(c => `${c.campaign_name}|${c.send_date}`));

    const toImport = withDate.map(r => {
        const v = r.values;
        const name     = v['c-Uv4zbhft7s'] || '';
        const goLive   = v['c-qZ5pWze-qr'] ? v['c-qZ5pWze-qr'].substring(0, 10) : null;
        const category = mapCategory(v['c-koILJsOuMY']);
        const status   = v['c-OrOut2KsHe'] || '';
        const priority = v['c-wP0h7clHiB'] || '';
        const owners   = Array.isArray(v['c-z1Wau-qigr']) ? v['c-z1Wau-qigr'].join(', ') : (v['c-z1Wau-qigr'] || '');
        const quarter  = v['c-IWAEuAT3lX'] || '';
        const already  = existingKeys.has(`${name}|${goLive}`);
        const parent   = (v['c-qIJvrFxXkv'] && v['c-qIJvrFxXkv'] !== '') ? v['c-qIJvrFxXkv'] : null;
        return { name, goLive, category, status, priority, owners, quarter, already, parent };
    }).filter(r => r.name);

    // Deduplicate within the Coda results themselves (same name+date appearing twice in Coda)
    const seenKeys = new Set();
    const deduped  = toImport.filter(r => {
        const k = `${r.name}|${r.goLive}`;
        if (seenKeys.has(k)) return false;
        seenKeys.add(k);
        return true;
    });
    const newOnes  = deduped.filter(r => !r.already);
    const skipOnes = deduped.filter(r => r.already);

    panel.innerHTML = `
        <div class="sync-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <strong style="font-size:14px;">Coda FY27 Roadmap â€” ${toImport.length} campaigns with GO LIVE dates</strong>
                <div style="display:flex;gap:8px;">
                    ${newOnes.length ? `<button class="btn btn-primary" onclick="confirmCodaSync()">Import ${newOnes.length} new campaign${newOnes.length > 1 ? 's' : ''}</button>` : '<span style="color:var(--success);font-size:13px;">âœ“ All up to date</span>'}
                    <button class="btn-sm" onclick="document.getElementById('coda-sync-panel').style.display='none'">Dismiss</button>
                </div>
            </div>
            ${newOnes.map(r => `
                <div class="sync-row">
                    <span class="sync-row-name">${r.name}</span>
                    <span class="sync-row-meta">
                        ${badge(r.category)}
                        <span>${r.goLive}</span>
                        ${r.quarter ? `<span>${r.quarter}</span>` : ''}
                        ${r.owners ? `<span>${r.owners}</span>` : ''}
                    </span>
                </div>`).join('')}
            ${skipOnes.length ? `<p style="margin-top:10px;font-size:12px;color:var(--muted);">${skipOnes.length} already imported, skipping.</p>` : ''}
        </div>`;

    // Store for confirm step â€” queue = new rows to insert, all = every row for parent backfill
    window._codaSyncQueue = newOnes;
    window._codaSyncAll   = toImport;
}

async function confirmCodaSync() {
    const queue = window._codaSyncQueue || [];
    const all   = window._codaSyncAll   || [];

    const panel = document.getElementById('coda-sync-panel');
    panel.innerHTML = `<div class="sync-panel"><p style="color:var(--muted);font-size:13px;">Importing and updating parent info...</p></div>`;

    // Insert new rows
    if (queue.length) {
        const rows = queue.map(r => ({
            campaign_name:   r.name,
            category:        r.category,
            channel:         'Email',
            send_date:       r.goLive,
            created_by:      r.owners || null,
            notes:           [r.priority, r.quarter, r.status].filter(Boolean).join(' Â· ') || null,
            parent_campaign: r.parent || null,
        }));
        const { error } = await db.from('lifecycle_campaigns').insert(rows);
        if (error) {
            panel.innerHTML = `<div class="sync-panel"><div class="alert alert-error">Import failed: ${error.message}</div></div>`;
            return;
        }
    }

    // Backfill parent_campaign on ALL existing records using the Coda parent map
    const withParent = all.filter(r => r.parent && r.name);
    await Promise.all(withParent.map(r =>
        db.from('lifecycle_campaigns').update({ parent_campaign: r.parent }).eq('campaign_name', r.name)
    ));

    const msg = queue.length
        ? `âœ“ ${queue.length} campaign${queue.length > 1 ? 's' : ''} imported and parent info updated.`
        : `âœ“ Parent info updated for all campaigns.`;
    panel.innerHTML = `<div class="sync-panel"><div class="alert alert-success">${msg} Refreshing...</div></div>`;
    window._codaSyncQueue = [];
    window._codaSyncAll   = [];
    await loadCalendar();
    setTimeout(() => { panel.style.display = 'none'; }, 3000);
}

// â”€â”€ INSPIRATION BOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleInspForm() {
    const f = document.getElementById('insp-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

function previewInspImage(input) {
    const file = input.files[0];
    if (!file) return;
    const prev = document.getElementById('insp-preview');
    prev.src = URL.createObjectURL(file);
    prev.style.display = 'block';
    document.getElementById('insp-drop-zone').style.display = 'none';
}

// Drag and drop
document.addEventListener('DOMContentLoaded', () => {
    const zone = document.getElementById('insp-drop-zone');
    if (!zone) return;
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const dt = new DataTransfer(); dt.items.add(file);
            document.getElementById('insp-file-input').files = dt.files;
            previewInspImage(document.getElementById('insp-file-input'));
        }
    });
});

async function saveInspiration() {
    const source = val('insp-source');
    const file   = document.getElementById('insp-file-input').files[0];
    const msg    = document.getElementById('insp-save-msg');
    if (!source) { msg.style.color = '#fca5a5'; msg.textContent = 'Brand/source is required.'; return; }
    if (!file)   { msg.style.color = '#fca5a5'; msg.textContent = 'Please select a screenshot.'; return; }

    msg.style.color = 'var(--muted)'; msg.textContent = 'Uploading...';

    const ext  = file.name.split('.').pop();
    const path = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
    const { error: upErr } = await db.storage.from('Email Inspo').upload(path, file, { contentType: file.type });
    if (upErr) { msg.style.color = '#fca5a5'; msg.textContent = 'Upload error: ' + upErr.message; return; }

    const { data: { publicUrl } } = db.storage.from('Email Inspo').getPublicUrl(path);

    const { error } = await db.from('lifecycle_swipe_file').insert({
        image_url:    publicUrl,
        campaign_name: source,
        type:          val('insp-type')     || null,
        category:      val('insp-category') || null,
        notes:         val('insp-notes')    || null,
    });
    if (error) { msg.style.color = '#fca5a5'; msg.textContent = 'Save error: ' + error.message; return; }

    msg.style.color = 'var(--success)'; msg.textContent = 'âœ“ Saved!';
    document.getElementById('insp-file-input').value = '';
    document.getElementById('insp-preview').style.display = 'none';
    document.getElementById('insp-drop-zone').style.display = 'block';
    ['insp-source','insp-type','insp-category','insp-notes'].forEach(id => document.getElementById(id).value = '');
    setTimeout(() => { msg.textContent = ''; toggleInspForm(); loadInspiration(); }, 1200);
}

async function loadInspiration() {
    const type   = document.getElementById('insp-filter-type').value;
    const search = document.getElementById('insp-search').value.toLowerCase();

    let q = db.from('lifecycle_swipe_file').select('*').not('image_url', 'is', null).order('created_at', { ascending: false });
    if (type) q = q.eq('type', type);

    const { data, error } = await q;
    const grid = document.getElementById('insp-grid');

    if (error || !data) { grid.innerHTML = `<div class="empty"><strong>Storage not set up yet</strong>Create a public bucket named <code>inspiration</code> in Supabase Storage.</div>`; return; }

    const filtered = data.filter(r =>
        !search ||
        (r.campaign_name||'').toLowerCase().includes(search) ||
        (r.notes||'').toLowerCase().includes(search) ||
        (r.type||'').toLowerCase().includes(search)
    );

    document.getElementById('insp-count').textContent = `${filtered.length} screenshot${filtered.length !== 1 ? 's' : ''}`;

    if (!filtered.length) {
        grid.innerHTML = `<div class="empty" style="grid-column:1/-1;"><strong>No screenshots yet</strong>Click "+ Add screenshot" to start your inspiration board.</div>`;
        return;
    }

    grid.innerHTML = filtered.map(r => `
        <div class="insp-card">
            <img class="insp-card-img" src="${r.image_url}" alt="${r.campaign_name||''}" loading="lazy"
                onclick="openInspLightbox('${r.image_url}')">
            <div class="insp-card-body">
                <div class="insp-card-meta">
                    <span class="insp-card-source">${r.campaign_name||'Unknown'}</span>
                    ${r.type ? `<span class="badge" style="background:#1e293b;color:var(--muted);font-size:10px;">${r.type}</span>` : ''}
                    ${r.category ? badge(r.category) : ''}
                </div>
                ${r.notes ? `<div class="insp-card-notes">${r.notes}</div>` : ''}
                <div class="insp-card-footer">
                    <span style="font-size:11px;color:var(--muted);">${r.created_at ? new Date(r.created_at).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : ''}</span>
                    <button class="btn-sm" style="color:#fca5a5;border-color:#7f1d1d;font-size:11px;" onclick="deleteInspiration('${r.id}', '${r.image_url}')">Delete</button>
                </div>
            </div>
        </div>`).join('');
}

async function deleteInspiration(id, imageUrl) {
    if (!confirm('Delete this screenshot?')) return;
    await db.from('lifecycle_swipe_file').delete().eq('id', id);
    // Also remove from storage
    const path = imageUrl.split('/inspiration/')[1];
    if (path) await db.storage.from('Email Inspo').remove([path]);
    loadInspiration();
}

function openInspLightbox(url) {
    document.getElementById('insp-lightbox-img').src = url;
    document.getElementById('insp-lightbox').classList.add('open');
}
function closeInspLightbox() {
    document.getElementById('insp-lightbox').classList.remove('open');
}

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeCampaignModal(); closeABTestModal(); closeInspLightbox(); closeLogModal(); closePUModal(); }
});

// â”€â”€ EXPERIMENT BACKLOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleBacklogForm() {
    const f = document.getElementById('backlog-add-form');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}

async function loadBacklog() {
    const { data, error } = await db.from('lifecycle_experiment_backlog')
        .select('*').order('created_at', { ascending: false });

    if (error) {
        document.getElementById('backlog-board').innerHTML = `<div style="grid-column:1/-1" class="empty"><strong>Table not set up yet</strong>Run the SQL in the page source to create the <code>lifecycle_experiment_backlog</code> table.</div>`;
        return;
    }

    const items    = data || [];
    const statuses = ['Idea', 'Planned', 'Running', 'Complete'];
    const nextMap  = { Idea: 'Planned', Planned: 'Running', Running: 'Complete' };

    document.getElementById('backlog-board').innerHTML = statuses.map(status => {
        const col   = items.filter(i => i.status === status);
        const cards = col.length
            ? col.map(i => {
                const next     = nextMap[status];
                const moveBtn  = next ? `<button class="backlog-move-btn" onclick="moveBacklogItem('${i.id}','${next}')">Move to ${next} &rarr;</button>` : '';
                const priCls   = `priority-${i.priority || 'Medium'}`;
                return `
                    <div class="backlog-card">
                        <div class="backlog-hypothesis">${i.hypothesis || 'â€”'}</div>
                        <div class="backlog-meta">
                            <span class="${priCls}">${i.priority || 'Medium'}</span>
                            ${i.element_to_test ? `<span class="backlog-element">${i.element_to_test}</span>` : ''}
                            ${i.campaign_context ? `<span class="backlog-context">${i.campaign_context}</span>` : ''}
                        </div>
                        ${moveBtn}
                    </div>`;
            }).join('')
            : `<div style="color:var(--muted);font-size:12px;text-align:center;padding:16px 8px;">No ideas here</div>`;

        return `
            <div class="backlog-col">
                <div class="backlog-col-header">${status} <span class="count">${col.length}</span></div>
                ${cards}
            </div>`;
    }).join('');
}

async function moveBacklogItem(id, newStatus) {
    await db.from('lifecycle_experiment_backlog').update({ status: newStatus }).eq('id', id);
    loadBacklog();
}

async function saveBacklogItem() {
    const hyp = val('bl-hyp');
    if (!hyp) { showAlert('backlog-alert', 'A hypothesis is required.', 'error'); return; }

    const { error } = await db.from('lifecycle_experiment_backlog').insert({
        hypothesis:      hyp,
        element_to_test: val('bl-element'),
        campaign_context: val('bl-context'),
        priority:        document.getElementById('bl-priority').value,
        status:          document.getElementById('bl-status').value,
        notes:           val('bl-notes'),
    });

    if (error) { showAlert('backlog-alert', 'Error: ' + error.message, 'error'); return; }
    showAlert('backlog-alert', 'Idea saved!');
    document.getElementById('backlog-add-form').style.display = 'none';
    document.querySelectorAll('#backlog-add-form input, #backlog-add-form textarea, #backlog-add-form select').forEach(el => el.value = '');
    loadBacklog();
}

async function loadAISuggestions() {
    const btn = document.getElementById('ai-suggest-btn');
    const out = document.getElementById('ai-suggestions');
    btn.textContent = 'Thinkingâ€¦'; btn.disabled = true;
    out.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:8px 0;">Analysing your campaigns and applying best practicesâ€¦</div>';

    const [{ data: camps }, { data: tests }, { data: backlog }] = await Promise.all([
        db.from('lifecycle_campaigns').select('category,open_rate,click_rate,emails_sent').not('send_date', 'is', null),
        db.from('lifecycle_ab_tests').select('test_name,element_tested,winner').order('test_date', { ascending: false }).limit(30),
        db.from('lifecycle_experiment_backlog').select('hypothesis,element_to_test').limit(30),
    ]);

    const catMap = {};
    (camps || []).forEach(c => {
        if (!c.category) return;
        if (!catMap[c.category]) catMap[c.category] = { opens: [], clicks: [], count: 0 };
        catMap[c.category].count++;
        if (c.open_rate  != null) catMap[c.category].opens.push(c.open_rate);
        if (c.click_rate != null) catMap[c.category].clicks.push(c.click_rate);
    });
    const categorySummary = Object.entries(catMap).map(([cat, d]) => ({
        category: cat,
        campaigns: d.count,
        avgOpen:  d.opens.length  ? d.opens.reduce((a, b) => a + b, 0)  / d.opens.length  : null,
        avgClick: d.clicks.length ? d.clicks.reduce((a, b) => a + b, 0) / d.clicks.length : null,
    }));

    try {
        const r = await fetch('/api/claude-experiments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                categorySummary,
                existingTests:   (tests   || []).map(t => ({ name: t.test_name, element: t.element_tested, winner: t.winner })),
                existingBacklog: (backlog || []).map(b => b.hypothesis),
            }),
        });
        const { suggestions, error } = await r.json();
        if (!suggestions?.length) throw new Error(error || 'No suggestions returned');

        window._aiSuggestions = suggestions;
        out.innerHTML = `<div class="ai-suggest-grid">${suggestions.map((s, i) => `
            <div class="ai-suggest-card">
                <div class="backlog-hypothesis">${s.hypothesis}</div>
                <div class="backlog-meta">
                    <span class="priority-${s.priority || 'Medium'}">${s.priority || 'Medium'}</span>
                    ${s.element   ? `<span class="backlog-element">${s.element}</span>` : ''}
                    ${s.category  ? `<span class="backlog-element" style="background:#1e3a5f;color:#93c5fd;">${s.category}</span>` : ''}
                </div>
                ${s.rationale ? `<div class="ai-suggest-rationale">${s.rationale}</div>` : ''}
                <button class="backlog-move-btn" style="margin-top:10px;" onclick="addSuggestionToBacklog(${i})">+ Add to backlog</button>
            </div>`).join('')}</div>`;

        btn.textContent = 'â†» Regenerate';
        btn.disabled = false;
    } catch (e) {
        out.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:8px 0;">Could not generate suggestions: ${e.message}</div>`;
        btn.textContent = 'Generate Ideas';
        btn.disabled = false;
    }
}

function addSuggestionToBacklog(idx) {
    const s = window._aiSuggestions?.[idx];
    if (!s) return;
    document.getElementById('backlog-add-form').style.display = 'block';
    document.getElementById('bl-hyp').value      = s.hypothesis || '';
    document.getElementById('bl-context').value  = s.context    || '';
    document.getElementById('bl-notes').value    = s.rationale  ? `AI suggestion rationale: ${s.rationale}` : '';
    document.getElementById('bl-priority').value = ['High','Medium','Low'].includes(s.priority) ? s.priority : 'Medium';
    const elSel  = document.getElementById('bl-element');
    const match  = [...elSel.options].findIndex(o => o.value.toLowerCase() === (s.element || '').toLowerCase());
    if (match >= 0) elSel.selectedIndex = match;
    document.getElementById('backlog-add-form').scrollIntoView({ behavior: 'smooth' });
}

// â”€â”€ A/B TESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _abModalTests = [];
let _abModalTestId = null;

async function loadABTests() {
    const { data } = await db.from('lifecycle_ab_tests').select('*').order('test_date', { ascending: false });
    _abModalTests = data || [];
    if (!data || data.length === 0) {
        document.getElementById('ab-body').innerHTML = `<tr><td colspan="11" class="empty"><strong>No tests logged yet</strong>Use "Log New Test" to add one.</td></tr>`;
        return;
    }
    document.getElementById('ab-body').innerHTML = data.map(t => {
        const aw = autoDetectWinner(t);
        // Use stored winner if explicitly set by user; fall back to auto-detect
        const displayWinner = (t.winner && t.winner !== 'N') ? t.winner : aw.pick;
        const ss = calcStatSig(t);
        const ssCell = ss
            ? (ss.significant
                ? `<span style="color:var(--success);font-weight:600;">Yes</span>`
                : `<span style="color:#fcd34d;font-weight:600;">No</span>`)
            : `<span style="color:var(--muted);">â€”</span>`;
        return `
        <tr class="clickable" onclick="openABTestModal('${t.test_id}')">
            <td><strong>${t.test_name}</strong></td>
            <td>${t.element_tested||'â€”'}</td>
            <td style="max-width:200px;"><div style="font-weight:600;font-size:12px;">${t.variant_a_name||'â€”'}</div>${t.variant_a_content?`<div style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:190px;">${t.variant_a_content}</div>`:''}</td>
            <td>${pct(t.variant_a_open_rate)}</td>
            <td>${pct(t.variant_a_click_rate)}</td>
            <td style="max-width:200px;"><div style="font-weight:600;font-size:12px;">${t.variant_b_name||'â€”'}</div>${t.variant_b_content?`<div style="font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:190px;">${t.variant_b_content}</div>`:''}</td>
            <td>${pct(t.variant_b_open_rate)}</td>
            <td>${pct(t.variant_b_click_rate)}</td>
            <td class="${displayWinner==='A'?'winner-a':displayWinner==='B'?'winner-b':''}">${displayWinner==='N'||!displayWinner?'â€”':displayWinner}</td>
            <td>${ssCell}</td>
            <td style="max-width:180px;font-size:12px;">${t.winner_notes||'â€”'}</td>
            <td>${t.test_date||'â€”'}</td>
        </tr>`;
    }).join('');
}

function openABTestModal(id) {
    const t = _abModalTests.find(x => x.test_id === id);
    if (t) showABTestModal(t);
}

// Elements that determine winner via open rate; everything else uses click rate
const OPEN_RATE_ELEMENTS = new Set(['Subject Line', 'Preview Text', 'Sender Name', 'Send Time']);

function primaryMetric(element) {
    return OPEN_RATE_ELEMENTS.has(element) ? 'open' : 'click';
}

function autoDetectWinner(t) {
    const useOpen = primaryMetric(t.element_tested) === 'open';
    const aC = t.variant_a_click_rate, bC = t.variant_b_click_rate;
    const aO = t.variant_a_open_rate,  bO = t.variant_b_open_rate;

    // Try preferred metric first, fall back to the other if preferred is unavailable
    const pairs = useOpen
        ? [{ a: aO, b: bO, metric: 'open rate' }, { a: aC, b: bC, metric: 'click rate' }]
        : [{ a: aC, b: bC, metric: 'click rate' }, { a: aO, b: bO, metric: 'open rate' }];

    for (const { a, b, metric } of pairs) {
        if (a != null && b != null) {
            const diff = a - b;
            if (diff === 0) return { pick: 'N', metric, diff: 0 };
            return { pick: diff > 0 ? 'A' : 'B', metric, diff: Math.abs(diff) };
        }
    }
    return { pick: 'N', metric: null, diff: 0 };
}

function calcStatSig(t) {
    if (!t.sent_a || !t.sent_b) return null;
    const useOpen = primaryMetric(t.element_tested) === 'open';
    // Use the same metric logic as autoDetectWinner
    const rA = useOpen
        ? (t.variant_a_open_rate  ?? t.variant_a_click_rate)
        : (t.variant_a_click_rate ?? t.variant_a_open_rate);
    const rB = useOpen
        ? (t.variant_b_open_rate  ?? t.variant_b_click_rate)
        : (t.variant_b_click_rate ?? t.variant_b_open_rate);
    if (rA == null || rB == null) return null;
    const metric = useOpen ? 'open rate' : 'click rate';
    const p  = (rA * t.sent_a + rB * t.sent_b) / (t.sent_a + t.sent_b);
    const se = Math.sqrt(p * (1 - p) * (1 / t.sent_a + 1 / t.sent_b));
    if (se === 0) return null;
    const z  = Math.abs(rA - rB) / se;
    const pv = 2 * (1 - normalCDF(z));
    return { z, pValue: pv, significant: pv < 0.05, metric };
}

function normalCDF(z) {
    const sign = z < 0 ? -1 : 1;
    z = Math.abs(z) / Math.sqrt(2);
    const t = 1 / (1 + 0.3275911 * z);
    const y = 1 - (((((1.061405429 * t - 1.453152027) * t + 1.421413741) * t - 0.284496736) * t + 0.254829592) * t * Math.exp(-z * z));
    return 0.5 * (1 + sign * y);
}

function showABTestModal(t) {
    _abModalTestId = t.test_id;
    const aw = autoDetectWinner(t);
    const ss = calcStatSig(t);
    const wColor = p => p === 'A' ? 'var(--brand)' : p === 'B' ? '#86efac' : 'var(--muted)';
    const wLabel = p => p === 'A' ? 'Variant A' : p === 'B' ? 'Variant B' : 'No clear winner';
    const optSel = (stored, opt) => (stored || aw.pick) === opt ? 'selected' : '';

    const ssHTML = ss
        ? `<div style="font-size:12px;margin-top:5px;color:${ss.significant ? 'var(--success)' : '#fcd34d'};">Statistically significant: <strong>${ss.significant ? 'Yes' : 'No'}</strong> <span style="color:var(--muted);font-weight:400;">(based on ${ss.metric})</span></div>`
        : `<div style="font-size:11px;color:var(--muted);margin-top:5px;">Statistically significant: <strong>â€”</strong> (enter sent counts above to calculate)</div>`;

    document.getElementById('ab-modal-content').innerHTML = `
        <div class="cm-header">
            <div class="cm-title">${t.test_name}</div>
            <button class="cm-close" onclick="closeABTestModal()">&#215;</button>
        </div>
        ${t.test_date ? `<div class="cm-row"><span class="cm-label">Date</span><span class="cm-value">${t.test_date}</span></div>` : ''}
        <div class="abt-winner-box">
            <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">Auto-detected Result</div>
            <div style="font-size:16px;font-weight:700;color:${wColor(aw.pick)};">${wLabel(aw.pick)}</div>
            ${aw.metric && aw.pick !== 'N' ? `<div style="font-size:12px;color:var(--muted);margin-top:3px;">+${(aw.diff*100).toFixed(2)}pp on ${aw.metric}</div>` : aw.metric ? `<div style="font-size:12px;color:var(--muted);margin-top:3px;">${(aw.diff*100).toFixed(2)}pp difference on ${aw.metric} â€” too small to call</div>` : ''}
            ${ssHTML}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
            <div class="abt-variant-card">
                <div style="font-size:11px;font-weight:700;color:var(--brand);margin-bottom:6px;">VARIANT A</div>
                <div style="font-size:13px;font-weight:600;margin-bottom:4px;">${t.variant_a_name||'Variant A'}</div>
                ${t.variant_a_content ? `<div style="font-size:12px;color:var(--text);margin-bottom:6px;line-height:1.5;white-space:pre-wrap;">${t.variant_a_content}</div>` : ''}
                <div style="font-size:12px;color:var(--muted);">Open: ${pct(t.variant_a_open_rate)}</div>
                <div style="font-size:12px;color:var(--muted);">Click: ${pct(t.variant_a_click_rate)}</div>
                ${t.sent_a ? `<div style="font-size:12px;color:var(--muted);">Sent: ${Number(t.sent_a).toLocaleString()}</div>` : ''}
            </div>
            <div class="abt-variant-card">
                <div style="font-size:11px;font-weight:700;color:#86efac;margin-bottom:6px;">VARIANT B</div>
                <div style="font-size:13px;font-weight:600;margin-bottom:4px;">${t.variant_b_name||'Variant B'}</div>
                ${t.variant_b_content ? `<div style="font-size:12px;color:var(--text);margin-bottom:6px;line-height:1.5;white-space:pre-wrap;">${t.variant_b_content}</div>` : ''}
                <div style="font-size:12px;color:var(--muted);">Open: ${pct(t.variant_b_open_rate)}</div>
                <div style="font-size:12px;color:var(--muted);">Click: ${pct(t.variant_b_click_rate)}</div>
                ${t.sent_b ? `<div style="font-size:12px;color:var(--muted);">Sent: ${Number(t.sent_b).toLocaleString()}</div>` : ''}
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
            <div class="field" style="margin:0;"><label>Emails Sent â€” Variant A</label>
                <input type="number" id="abt-sent-a" placeholder="e.g. 5000" value="${t.sent_a||''}">
            </div>
            <div class="field" style="margin:0;"><label>Emails Sent â€” Variant B</label>
                <input type="number" id="abt-sent-b" placeholder="e.g. 5000" value="${t.sent_b||''}">
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
            <div class="field" style="margin:0;"><label>Variant A Content</label>
                <textarea id="abt-a-content" placeholder="e.g. subject line or CTA copy">${t.variant_a_content||''}</textarea>
            </div>
            <div class="field" style="margin:0;"><label>Variant B Content</label>
                <textarea id="abt-b-content" placeholder="e.g. subject line or CTA copy">${t.variant_b_content||''}</textarea>
            </div>
        </div>
        <hr class="cm-divider">
        <div class="field"><label>Element Tested</label>
            <select id="abt-element">
                <option value="">Select...</option>
                ${['Subject Line','Preview Text','CTA','Send Time','Email Content','Sender Name','Offer','Segmentation'].map(o => `<option ${t.element_tested===o?'selected':''}>${o}</option>`).join('')}
            </select>
        </div>
        <div class="field"><label>Hypothesis</label>
            <textarea id="abt-hypothesis" placeholder="What were you testing and why?">${t.hypothesis||''}</textarea>
        </div>
        <div class="field"><label>Winner</label>
            <select id="abt-winner">
                <option value="A" ${optSel(t.winner,'A')}>Variant A</option>
                <option value="B" ${optSel(t.winner,'B')}>Variant B</option>
                <option value="N" ${optSel(t.winner,'N')}>No clear winner</option>
            </select>
        </div>
        <div class="field"><label>What did you learn?</label>
            <textarea id="abt-insight" placeholder="Key takeaway from this test...">${t.winner_notes||''}</textarea>
        </div>
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:10px;align-items:center;">
                <button class="btn btn-primary" onclick="saveABTestEdits()">Save Changes</button>
                <span id="abt-save-msg" style="font-size:12px;"></span>
            </div>
            <button class="btn-sm" style="color:#fca5a5;border-color:#7f1d1d;" onclick="deleteABTest()">Delete test</button>
        </div>
    `;
    document.getElementById('ab-modal-overlay').style.display = 'block';
    document.getElementById('ab-modal').style.display = 'block';
}

function closeABTestModal() {
    document.getElementById('ab-modal-overlay').style.display = 'none';
    document.getElementById('ab-modal').style.display = 'none';
}

async function saveABTestEdits() {
    if (!_abModalTestId) return;
    const sentA = parseInt(document.getElementById('abt-sent-a').value) || null;
    const sentB = parseInt(document.getElementById('abt-sent-b').value) || null;
    const update = {
        element_tested:    document.getElementById('abt-element').value || null,
        hypothesis:        document.getElementById('abt-hypothesis').value.trim() || null,
        winner:            document.getElementById('abt-winner').value || null,
        winner_notes:      document.getElementById('abt-insight').value.trim() || null,
        sent_a:            sentA,
        sent_b:            sentB,
        variant_a_content: document.getElementById('abt-a-content').value.trim() || null,
        variant_b_content: document.getElementById('abt-b-content').value.trim() || null,
    };
    const msg = document.getElementById('abt-save-msg');
    const { error } = await db.from('lifecycle_ab_tests').update(update).eq('test_id', _abModalTestId);
    if (error) { msg.style.color = '#fca5a5'; msg.textContent = 'Error: ' + error.message; return; }
    // Update local cache
    const idx = _abModalTests.findIndex(x => x.test_id === _abModalTestId);
    if (idx >= 0) Object.assign(_abModalTests[idx], update);
    msg.style.color = 'var(--success)'; msg.textContent = 'âœ“ Saved!';
    loadABTests();
    setTimeout(closeABTestModal, 1500);
}

async function deleteABTest() {
    if (!_abModalTestId) return;
    if (!confirm('Delete this test? This cannot be undone.')) return;
    const { error } = await db.from('lifecycle_ab_tests').delete().eq('test_id', _abModalTestId);
    if (error) { alert('Error: ' + error.message); return; }
    _abModalTests = _abModalTests.filter(x => x.test_id !== _abModalTestId);
    closeABTestModal();
    loadABTests();
}

async function saveABTest() {
    const name = val('ab-name');
    if (!name) { showAlert('ab-alert', 'Test name is required.', 'error'); return; }

    const { error } = await db.from('lifecycle_ab_tests').insert({
        test_name: name, element_tested: val('ab-element'),
        hypothesis: val('ab-hyp'), test_date: val('ab-date'),
        variant_a_name: val('ab-a-name'), variant_a_content: val('ab-a-content'), variant_a_open_rate: toRate('ab-a-open'), variant_a_click_rate: toRate('ab-a-click'),
        variant_b_name: val('ab-b-name'), variant_b_content: val('ab-b-content'), variant_b_open_rate: toRate('ab-b-open'), variant_b_click_rate: toRate('ab-b-click'),
        winner: val('ab-winner'), winner_notes: val('ab-insight'),
    });

    if (error) { showAlert('ab-alert', 'Error: ' + error.message, 'error'); return; }
    showAlert('ab-alert', 'Test saved!');
    loadABTests();
    showABInner('ab-view', document.querySelector('#tab-abtests .inner-tabs button'));
    document.querySelectorAll('#ab-form input, #ab-form textarea, #ab-form select').forEach(el => el.value = '');
}

// â”€â”€ REPORT GENERATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchReportMode(mode, btn) {
    btn.closest('.inner-tabs').querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('r-mode-period').style.display = mode === 'period' ? '' : 'none';
    document.getElementById('r-mode-single').style.display = mode === 'single' ? '' : 'none';
    document.getElementById('report-out').style.display = 'none';
}

async function loadCampaignsForReport() {
    // Default date range to current month
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();
    document.getElementById('r-from').value = new Date(y, m, 1).toISOString().slice(0, 10);
    document.getElementById('r-to').value   = new Date(y, m + 1, 0).toISOString().slice(0, 10);
    // Populate single campaign dropdown
    const { data } = await db.from('lifecycle_campaigns').select('campaign_id, campaign_name, send_date').is('parent_campaign', null).order('send_date', { ascending: false }).limit(100);
    const sel = document.getElementById('r-campaign');
    if (data && data.length) {
        sel.innerHTML = data.map(c => `<option value="${c.campaign_id}">${c.campaign_name}${c.send_date ? ' â€” ' + c.send_date : ''}</option>`).join('');
    } else {
        sel.innerHTML = '<option value="">No campaigns yet</option>';
    }
}

function fmtDate(d) {
    if (!d) return '';
    return new Date(d + 'T00:00:00').toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
}

function benchArrow(val, avg) {
    if (val == null || avg == null) return '';
    const diff = (val - avg) * 100;
    const cls  = diff >= 0 ? 'bench-up' : 'bench-down';
    return `<span class="${cls}">${diff >= 0 ? 'â†‘' : 'â†“'}${Math.abs(diff).toFixed(1)}pp vs avg</span>`;
}

function avgMetric(arr, field) {
    const vals = arr.filter(r => r[field] != null).map(r => r[field]);
    return vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : null;
}

async function generateReport() {
    const isSingle = document.getElementById('r-mode-single').style.display !== 'none';
    const type     = document.getElementById('r-type').value;
    const btn      = event.target;
    btn.textContent = 'Generating...'; btn.disabled = true;

    let from, to, periodLabel;

    if (isSingle) {
        const id = document.getElementById('r-campaign').value;
        if (!id) { btn.textContent = 'Generate Report'; btn.disabled = false; alert('Please select a campaign.'); return; }
        const { data: single } = await db.from('lifecycle_campaigns').select('*').eq('campaign_id', id).single();
        if (!single) { btn.textContent = 'Generate Report'; btn.disabled = false; return; }
        from = single.send_date || '2000-01-01';
        to   = single.send_date || '2099-01-01';
        periodLabel = `${single.campaign_name}`;
        // For single campaign mode, build a focused single-campaign report
        const { data: allHistory } = await db.from('lifecycle_campaigns').select('open_rate, click_rate, click_to_open_rate, category').not('send_date', 'is', null);
        btn.textContent = 'Generate Report'; btn.disabled = false;
        renderSingleCampaignReport(single, allHistory || [], type);
        return;
    }

    from = val('r-from');
    to   = val('r-to');
    if (!from || !to) { btn.textContent = 'Generate Report'; btn.disabled = false; alert('Please select a date range.'); return; }

    const [{ data: campaigns }, { data: abtests }, { data: allHistory }] = await Promise.all([
        db.from('lifecycle_campaigns').select('*').gte('send_date', from).lte('send_date', to).is('parent_campaign', null).order('send_date', { ascending: true }),
        db.from('lifecycle_ab_tests').select('*').gte('test_date', from).lte('test_date', to).order('test_date', { ascending: true }),
        db.from('lifecycle_campaigns').select('open_rate, click_rate, click_to_open_rate, category').not('send_date', 'is', null),
    ]);

    btn.textContent = 'Generate Report'; btn.disabled = false;

    const camps   = campaigns  || [];
    const tests   = abtests   || [];
    const history = allHistory || [];

    const totalSent      = camps.reduce((a, c) => a + (c.emails_sent || 0), 0);
    const periodAvgOpen  = avgMetric(camps,   'open_rate');
    const periodAvgClick = avgMetric(camps,   'click_rate');
    const periodAvgCTOR  = avgMetric(camps,   'click_to_open_rate');
    const histAvgOpen    = avgMetric(history, 'open_rate');
    const histAvgClick   = avgMetric(history, 'click_rate');
    const histAvgCTOR    = avgMetric(history, 'click_to_open_rate');
    const topCamp        = camps.length ? camps.slice().sort((a, b) => (b.open_rate || 0) - (a.open_rate || 0))[0] : null;
    periodLabel = `${fmtDate(from)} â€“ ${fmtDate(to)}`;
    const typeLabels     = { stakeholder: 'Stakeholder Update', postmortem: 'Post-mortem', exec: 'Executive Summary' };

    // Build data for Claude narrative
    const catKeys = [...new Set(camps.map(c => c.category).filter(Boolean))];
    const categoryBreakdownForClaude = {};
    catKeys.forEach(cat => {
        const cc = camps.filter(c => c.category === cat);
        categoryBreakdownForClaude[cat] = { open: avgMetric(cc, 'open_rate'), click: avgMetric(cc, 'click_rate'), count: cc.length };
    });
    const topCampaignsForClaude = camps.slice()
        .filter(c => c.open_rate != null)
        .sort((a, b) => (b.open_rate || 0) - (a.open_rate || 0))
        .slice(0, 5)
        .map(c => ({ name: c.campaign_name, category: c.category, openRate: c.open_rate, clickRate: c.click_rate }));
    const abTestsForClaude = tests.map(t => ({ name: t.test_name, winner: autoDetectWinner(t).pick }));

    // KPI cards
    const kpiHTML = `<div class="report-kpis">
        <div class="report-kpi"><div class="report-kpi-val">${camps.length}</div><div class="report-kpi-label">Campaigns</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${totalSent ? totalSent.toLocaleString() : 'â€”'}</div><div class="report-kpi-label">Emails Sent</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${periodAvgOpen != null ? (periodAvgOpen*100).toFixed(1)+'%' : 'â€”'}</div><div class="report-kpi-label">Avg Open Rate</div><div class="report-kpi-bench">${benchArrow(periodAvgOpen, histAvgOpen)}</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${periodAvgClick != null ? (periodAvgClick*100).toFixed(1)+'%' : 'â€”'}</div><div class="report-kpi-label">Avg Click Rate</div><div class="report-kpi-bench">${benchArrow(periodAvgClick, histAvgClick)}</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${periodAvgCTOR != null ? (periodAvgCTOR*100).toFixed(1)+'%' : 'â€”'}</div><div class="report-kpi-label">Avg CTOR</div><div class="report-kpi-bench">${benchArrow(periodAvgCTOR, histAvgCTOR)}</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${tests.length}</div><div class="report-kpi-label">A/B Tests</div></div>
    </div>`;

    // Campaign rows
    const campRowsHTML = camps.length ? camps.map(c => {
        const catH        = history.filter(h => h.category === c.category);
        const catAvgOpen  = avgMetric(catH, 'open_rate');
        const catAvgClick = avgMetric(catH, 'click_rate');
        return `<div class="report-row">
            <div>
                <div style="font-weight:600;font-size:13px;margin-bottom:2px;">${c.campaign_name}</div>
                <div style="font-size:12px;color:var(--muted);">${c.category || ''}${c.send_date ? ' Â· ' + fmtDate(c.send_date) : ''}${c.emails_sent ? ' Â· ' + Number(c.emails_sent).toLocaleString() + ' sent' : ''}</div>
                ${c.subject_line ? `<div style="font-size:12px;color:var(--muted);font-style:italic;margin-top:2px;">"${c.subject_line}"</div>` : ''}
                ${c.notes ? `<div style="font-size:12px;color:var(--muted);margin-top:3px;">${c.notes}</div>` : ''}
            </div>
            <div class="report-row-metrics">
                ${c.open_rate  != null ? `<div><div class="report-metric-val">${(c.open_rate*100).toFixed(1)}%</div><div class="report-metric-label">Open ${benchArrow(c.open_rate, catAvgOpen)}</div></div>` : ''}
                ${c.click_rate != null ? `<div><div class="report-metric-val">${(c.click_rate*100).toFixed(1)}%</div><div class="report-metric-label">Click ${benchArrow(c.click_rate, catAvgClick)}</div></div>` : ''}
                ${c.click_to_open_rate != null ? `<div><div class="report-metric-val">${(c.click_to_open_rate*100).toFixed(1)}%</div><div class="report-metric-label">CTOR</div></div>` : ''}
                ${c.unsubscribe_rate != null ? `<div><div class="report-metric-val">${(c.unsubscribe_rate*100).toFixed(2)}%</div><div class="report-metric-label">Unsub</div></div>` : ''}
            </div>
        </div>`;
    }).join('') : '<div class="empty" style="padding:24px;">No campaigns found in this date range.</div>';

    // A/B test rows
    const abRowsHTML = tests.length ? tests.map(t => {
        const aw = autoDetectWinner(t);
        const ss = calcStatSig(t);
        const wColor = aw.pick === 'A' ? 'var(--brand)' : aw.pick === 'B' ? '#86efac' : 'var(--muted)';
        const wLabel = aw.pick === 'A' ? 'Variant A won' : aw.pick === 'B' ? 'Variant B won' : 'No clear winner';
        return `<div class="report-row">
            <div style="flex:1;">
                <div style="font-weight:600;font-size:13px;margin-bottom:3px;">${t.test_name}</div>
                <div style="font-size:12px;color:var(--muted);margin-bottom:5px;">${t.element_tested || 'â€”'}${t.test_date ? ' Â· ' + fmtDate(t.test_date) : ''}</div>
                ${t.variant_a_content || t.variant_a_name ? `<div style="font-size:12px;"><span style="color:var(--brand);font-weight:600;">A:</span> ${t.variant_a_content || t.variant_a_name}</div>` : ''}
                ${t.variant_b_content || t.variant_b_name ? `<div style="font-size:12px;"><span style="color:#86efac;font-weight:600;">B:</span> ${t.variant_b_content || t.variant_b_name}</div>` : ''}
                ${t.winner_notes ? `<div style="font-size:12px;color:var(--muted);font-style:italic;margin-top:4px;">"${t.winner_notes}"</div>` : ''}
            </div>
            <div style="text-align:right;flex-shrink:0;margin-left:16px;">
                <div style="font-weight:700;font-size:13px;color:${wColor};margin-bottom:2px;">${wLabel}</div>
                ${aw.metric && aw.pick !== 'N' ? `<div style="font-size:11px;color:var(--muted);">+${(aw.diff*100).toFixed(2)}pp on ${aw.metric}</div>` : ''}
                ${ss ? `<div style="font-size:11px;color:${ss.significant ? 'var(--success)' : '#fcd34d'};">Stat sig: ${ss.significant ? 'Yes' : 'No'}</div>` : ''}
            </div>
        </div>`;
    }).join('') : '<div style="color:var(--muted);font-size:13px;padding:8px 0;">No A/B tests in this period.</div>';

    // Benchmark rows (by category)
    const benchCats = [...new Set(camps.map(c => c.category).filter(Boolean))];
    const benchRowsHTML = benchCats.length ? benchCats.map(cat => {
        const catH         = history.filter(h => h.category === cat);
        const catAvgOpen   = avgMetric(catH, 'open_rate');
        const catAvgClick  = avgMetric(catH, 'click_rate');
        const catAvgCTOR   = avgMetric(catH, 'click_to_open_rate');
        const catPeriod    = camps.filter(c => c.category === cat);
        const catPeriodOpen  = avgMetric(catPeriod, 'open_rate');
        const catPeriodClick = avgMetric(catPeriod, 'click_rate');
        return `<div class="report-row">
            <div style="font-weight:600;font-size:13px;">${cat} <span style="color:var(--muted);font-weight:400;font-size:12px;">(${catH.length} campaigns all-time)</span></div>
            <div class="report-row-metrics">
                ${catAvgOpen  != null ? `<div><div class="report-metric-val">${(catAvgOpen*100).toFixed(1)}%</div><div class="report-metric-label">Avg Open ${benchArrow(catPeriodOpen, catAvgOpen)}</div></div>` : ''}
                ${catAvgClick != null ? `<div><div class="report-metric-val">${(catAvgClick*100).toFixed(1)}%</div><div class="report-metric-label">Avg Click ${benchArrow(catPeriodClick, catAvgClick)}</div></div>` : ''}
                ${catAvgCTOR  != null ? `<div><div class="report-metric-val">${(catAvgCTOR*100).toFixed(1)}%</div><div class="report-metric-label">Avg CTOR</div></div>` : ''}
            </div>
        </div>`;
    }).join('') : '<div style="color:var(--muted);font-size:13px;padding:8px 0;">Not enough historical data yet.</div>';

    // Slack snippet
    const pctTxt = v => v != null ? (v*100).toFixed(1)+'%' : 'â€”';
    const diffTxt = (a, b) => a != null && b != null ? ` (${a >= b ? 'â†‘' : 'â†“'}${Math.abs((a-b)*100).toFixed(1)}pp vs avg)` : '';
    const slackLines = [
        `ðŸ“Š *Lifecycle Email Update â€” ${periodLabel}*`,
        '',
        `*${camps.length} campaign${camps.length !== 1 ? 's' : ''}* Â· *${totalSent ? totalSent.toLocaleString() : 'â€”'} emails sent*`,
        `Avg open rate: *${pctTxt(periodAvgOpen)}*${diffTxt(periodAvgOpen, histAvgOpen)}`,
        `Avg click rate: *${pctTxt(periodAvgClick)}*${diffTxt(periodAvgClick, histAvgClick)}`,
        topCamp ? `\nðŸ† *Top performer:* ${topCamp.campaign_name} â€” ${pctTxt(topCamp.open_rate)} open, ${pctTxt(topCamp.click_rate)} click` : null,
        tests.length ? `\nðŸ§ª *${tests.length} A/B test${tests.length !== 1 ? 's' : ''} completed*` : null,
        ...tests.filter(t => autoDetectWinner(t).pick !== 'N').map(t => {
            const aw = autoDetectWinner(t);
            return `â€¢ ${t.test_name}: Variant ${aw.pick} won (+${(aw.diff*100).toFixed(1)}pp on ${aw.metric})`;
        }),
    ].filter(l => l != null).join('\n');

    // Plain text report for copy
    window._reportSlackText = slackLines;
    window._reportFullText  = buildTextReport(camps, tests, history, periodLabel, totalSent, periodAvgOpen, periodAvgClick, periodAvgCTOR, histAvgOpen, histAvgClick, histAvgCTOR);

    document.getElementById('report-out').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
            <div>
                <div style="font-size:20px;font-weight:700;margin-bottom:3px;">Lifecycle Marketing Report</div>
                <div style="font-size:13px;color:var(--muted);">${periodLabel} Â· ${typeLabels[type] || type}</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn-sm" onclick="copyReportText()">Copy full report</button>
                <button class="btn-sm" onclick="copySlackSnippet()">Copy Slack snippet</button>
            </div>
        </div>
        <div class="report-section" id="report-narrative-section">
            <h3>Executive Narrative</h3>
            <div id="report-narrative">
                <textarea id="r-product-insights" rows="3" style="resize:vertical;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:8px 10px;font-family:inherit;margin-bottom:10px;" placeholder="Optional: paste product &amp; usage insights to include â€” e.g. 'Feature X adoption +12% for this cohort, DAU up 8% WoW, 90-day retention improved 5pp.'"></textarea>
                <button id="narrative-gen-btn" class="btn btn-primary" style="font-size:13px;" onclick="generateNarrative()">âœ¨ Generate AI Narrative</button>
            </div>
        </div>
        ${kpiHTML}
        <div class="report-section"><h3>Campaigns this period</h3>${campRowsHTML}</div>
        <div class="report-section"><h3>A/B Tests this period</h3>${abRowsHTML}</div>
        <div class="report-section"><h3>Category benchmarks (all-time)</h3>${benchRowsHTML}</div>
        <div class="report-section"><h3>Slack snippet</h3><div class="slack-box">${slackLines.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>').replace(/\*(.*?)\*/g,'<strong>$1</strong>')}</div></div>
    `;
    document.getElementById('report-out').style.display = 'block';
    document.getElementById('report-out').scrollIntoView({ behavior: 'smooth' });

    // Store data for on-demand narrative generation
    window._narrativeData = {
        period: periodLabel,
        campaignCount: camps.length,
        totalSent,
        avgOpen:      periodAvgOpen,
        avgClick:     periodAvgClick,
        avgCTOR:      periodAvgCTOR,
        allTimeOpen:  histAvgOpen,
        allTimeClick: histAvgClick,
        allTimeCTOR:  histAvgCTOR,
        topCampaigns: topCampaignsForClaude,
        abTests:      abTestsForClaude,
        categoryBreakdown: categoryBreakdownForClaude,
    };
}

function renderSingleCampaignReport(c, history, type) {
    const catH        = history.filter(h => h.category === c.category);
    const catAvgOpen  = avgMetric(catH, 'open_rate');
    const catAvgClick = avgMetric(catH, 'click_rate');
    const catAvgCTOR  = avgMetric(catH, 'click_to_open_rate');
    const histAvgOpen  = avgMetric(history, 'open_rate');
    const histAvgClick = avgMetric(history, 'click_rate');
    const histAvgCTOR  = avgMetric(history, 'click_to_open_rate');
    const typeLabels   = { stakeholder: 'Stakeholder Update', postmortem: 'Post-mortem', exec: 'Executive Summary' };
    const p = v => v != null ? (v*100).toFixed(1)+'%' : 'â€”';

    // Store data for on-demand narrative generation
    window._narrativeData = {
        isSingleCampaign: true,
        campaignName: c.campaign_name,
        category:     c.category,
        sendDate:     c.send_date,
        emailsSent:   c.emails_sent,
        openRate:     c.open_rate,
        clickRate:    c.click_rate,
        ctor:         c.click_to_open_rate,
        unsubRate:    c.unsubscribe_rate,
        subjectLine:  c.subject_line,
        audience:     c.audience_segment,
        notes:        c.notes,
        catAvgOpen, catAvgClick, catAvgCTOR,
        histAvgOpen, histAvgClick, histAvgCTOR,
    };

    const kpiHTML = `<div class="report-kpis">
        <div class="report-kpi"><div class="report-kpi-val">${c.emails_sent ? Number(c.emails_sent).toLocaleString() : 'â€”'}</div><div class="report-kpi-label">Emails Sent</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${p(c.open_rate)}</div><div class="report-kpi-label">Open Rate</div><div class="report-kpi-bench">${benchArrow(c.open_rate, catAvgOpen)}</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${p(c.click_rate)}</div><div class="report-kpi-label">Click Rate</div><div class="report-kpi-bench">${benchArrow(c.click_rate, catAvgClick)}</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${p(c.click_to_open_rate)}</div><div class="report-kpi-label">CTOR</div><div class="report-kpi-bench">${benchArrow(c.click_to_open_rate, catAvgCTOR)}</div></div>
        <div class="report-kpi"><div class="report-kpi-val">${p(c.unsubscribe_rate)}</div><div class="report-kpi-label">Unsub Rate</div></div>
        ${c.revenue ? `<div class="report-kpi"><div class="report-kpi-val">$${Number(c.revenue).toLocaleString()}</div><div class="report-kpi-label">Revenue</div></div>` : ''}
    </div>`;

    const detailsHTML = `<div class="report-section"><h3>Campaign details</h3>
        ${[
            ['Campaign', c.campaign_name],
            ['Category', c.category],
            ['Send Date', c.send_date ? fmtDate(c.send_date) : null],
            ['Audience', c.audience_segment],
            ['Subject Line', c.subject_line ? `"${c.subject_line}"` : null],
            ['Created by', c.created_by],
        ].filter(([,v]) => v).map(([l, v]) => `
        <div class="report-row">
            <div style="font-size:12px;color:var(--muted);width:130px;flex-shrink:0;">${l}</div>
            <div style="font-size:13px;">${v}</div>
        </div>`).join('')}
        ${c.notes ? `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:13px;color:var(--muted);">${c.notes}</div>` : ''}
    </div>`;

    const benchHTML = `<div class="report-section"><h3>vs. ${c.category || 'overall'} benchmarks (${catH.length} campaigns)</h3>
        <div class="report-row">
            <div style="font-size:12px;color:var(--muted);">Metric</div>
            <div class="report-row-metrics" style="gap:32px;">
                <div><div style="font-size:11px;color:var(--muted);">This campaign</div></div>
                <div><div style="font-size:11px;color:var(--muted);">Category avg</div></div>
                <div><div style="font-size:11px;color:var(--muted);">Overall avg</div></div>
            </div>
        </div>
        ${[
            ['Open Rate', c.open_rate, catAvgOpen, histAvgOpen],
            ['Click Rate', c.click_rate, catAvgClick, histAvgClick],
            ['CTOR', c.click_to_open_rate, catAvgCTOR, avgMetric(history, 'click_to_open_rate')],
        ].map(([label, val, catAvg, allAvg]) => `
        <div class="report-row">
            <div style="font-weight:600;font-size:13px;">${label}</div>
            <div class="report-row-metrics" style="gap:32px;">
                <div><div class="report-metric-val">${p(val)}</div></div>
                <div><div class="report-metric-val">${p(catAvg)} ${benchArrow(val, catAvg)}</div></div>
                <div><div class="report-metric-val">${p(allAvg)} ${benchArrow(val, allAvg)}</div></div>
            </div>
        </div>`).join('')}
    </div>`;

    // Slack snippet
    const slackLines = [
        `ðŸ“Š *Campaign Report: ${c.campaign_name}*`,
        c.send_date ? `_Sent ${fmtDate(c.send_date)}_` : null,
        '',
        c.emails_sent ? `*${Number(c.emails_sent).toLocaleString()} emails sent*` : null,
        `Open rate: *${p(c.open_rate)}*${catAvgOpen != null ? ` (${c.open_rate >= catAvgOpen ? 'â†‘' : 'â†“'}${Math.abs((c.open_rate - catAvgOpen)*100).toFixed(1)}pp vs ${c.category} avg of ${p(catAvgOpen)})` : ''}`,
        `Click rate: *${p(c.click_rate)}*${catAvgClick != null ? ` (${c.click_rate >= catAvgClick ? 'â†‘' : 'â†“'}${Math.abs((c.click_rate - catAvgClick)*100).toFixed(1)}pp vs avg of ${p(catAvgClick)})` : ''}`,
        c.notes ? `\n_${c.notes}_` : null,
    ].filter(l => l != null).join('\n');

    const txtReport = [
        `CAMPAIGN REPORT: ${c.campaign_name.toUpperCase()}`,
        `${'â”€'.repeat(50)}`,
        `Category:     ${c.category || 'â€”'}`,
        `Send Date:    ${c.send_date ? fmtDate(c.send_date) : 'â€”'}`,
        `Audience:     ${c.audience_segment || 'â€”'}`,
        `Subject:      ${c.subject_line || 'â€”'}`,
        '',
        `RESULTS`,
        `${'â”€'.repeat(30)}`,
        `Emails sent:  ${c.emails_sent ? Number(c.emails_sent).toLocaleString() : 'â€”'}`,
        `Open rate:    ${p(c.open_rate)}  (${c.category} avg: ${p(catAvgOpen)})`,
        `Click rate:   ${p(c.click_rate)}  (avg: ${p(catAvgClick)})`,
        `CTOR:         ${p(c.click_to_open_rate)}  (avg: ${p(catAvgCTOR)})`,
        `Unsub rate:   ${p(c.unsubscribe_rate)}`,
        c.revenue ? `Revenue:      $${Number(c.revenue).toLocaleString()}` : null,
        '',
        c.notes ? `NOTES\n${'â”€'.repeat(30)}\n${c.notes}` : null,
    ].filter(l => l != null).join('\n');

    window._reportSlackText = slackLines;
    window._reportFullText  = txtReport;

    document.getElementById('report-out').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
            <div>
                <div style="font-size:20px;font-weight:700;margin-bottom:3px;">${c.campaign_name}</div>
                <div style="font-size:13px;color:var(--muted);">${c.category || ''}${c.send_date ? ' Â· ' + fmtDate(c.send_date) : ''} Â· ${typeLabels[type] || type}</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn-sm" onclick="copyReportText()">Copy full report</button>
                <button class="btn-sm" onclick="copySlackSnippet()">Copy Slack snippet</button>
            </div>
        </div>
        <div class="report-section" id="report-narrative-section">
            <h3>Executive Narrative</h3>
            <div id="report-narrative">
                <textarea id="r-product-insights" rows="3" style="resize:vertical;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;padding:8px 10px;font-family:inherit;margin-bottom:10px;" placeholder="Optional: paste product &amp; usage insights to include â€” e.g. 'Feature X adoption +12% for this cohort, DAU up 8% WoW, 90-day retention improved 5pp.'"></textarea>
                <button id="narrative-gen-btn" class="btn btn-primary" style="font-size:13px;" onclick="generateNarrative()">âœ¨ Generate AI Narrative</button>
            </div>
        </div>
        ${kpiHTML}
        ${detailsHTML}
        ${benchHTML}
        <div class="report-section"><h3>Slack snippet</h3><div class="slack-box">${slackLines.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>').replace(/\*(.*?)\*/g,'<strong>$1</strong>').replace(/_(.*?)_/g,'<em>$1</em>')}</div></div>
    `;
    document.getElementById('report-out').style.display = 'block';
    document.getElementById('report-out').scrollIntoView({ behavior: 'smooth' });
}

async function generateNarrative() {
    const btn = document.getElementById('narrative-gen-btn');
    const el  = document.getElementById('report-narrative');
    if (btn) { btn.textContent = 'Writingâ€¦'; btn.disabled = true; }

    const productInsights = (document.getElementById('r-product-insights')?.value || '').trim();
    const payload = { ...window._narrativeData, productInsights };

    try {
        const r = await fetch('/api/claude-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const { narrative, error } = await r.json();
        if (!narrative) throw new Error(error || 'Empty response');
        if (el) {
            el.innerHTML = narrative.split('\n\n').map(p => `<p style="margin-bottom:12px;font-size:13px;line-height:1.75;">${p}</p>`).join('');
        }
        if (window._reportFullText) {
            window._reportFullText = 'EXECUTIVE NARRATIVE\n' + 'â”€'.repeat(40) + '\n' + narrative + '\n\n' + window._reportFullText;
        }
    } catch (e) {
        if (el) el.innerHTML = `<span style="color:var(--muted);font-size:13px;">Could not generate narrative: ${e.message}</span>`;
        if (btn) { btn.textContent = 'âœ¨ Generate AI Narrative'; btn.disabled = false; }
    }
}

function buildTextReport(camps, tests, history, periodLabel, totalSent, periodAvgOpen, periodAvgClick, periodAvgCTOR, histAvgOpen, histAvgClick, histAvgCTOR) {
    const p  = v => v != null ? (v*100).toFixed(1)+'%' : 'â€”';
    const d  = (a, b) => a != null && b != null ? ` (${a >= b ? '+' : ''}${((a-b)*100).toFixed(1)}pp vs avg)` : '';
    const hr = (n=40) => 'â”€'.repeat(n);
    let txt  = `LIFECYCLE MARKETING REPORT\nPeriod: ${periodLabel}\n${hr(50)}\n\n`;
    txt += `OVERVIEW\n${hr(30)}\n`;
    txt += `Campaigns:      ${camps.length}\nEmails sent:    ${totalSent ? totalSent.toLocaleString() : 'â€”'}\n`;
    txt += `Avg open rate:  ${p(periodAvgOpen)}${d(periodAvgOpen, histAvgOpen)}\n`;
    txt += `Avg click rate: ${p(periodAvgClick)}${d(periodAvgClick, histAvgClick)}\n`;
    txt += `Avg CTOR:       ${p(periodAvgCTOR)}${d(periodAvgCTOR, histAvgCTOR)}\n`;
    txt += `A/B tests:      ${tests.length}\n\n`;
    txt += `CAMPAIGNS\n${hr(30)}\n`;
    camps.forEach((c, i) => {
        const catH = history.filter(h => h.category === c.category);
        const catOpen = avgMetric(catH, 'open_rate');
        txt += `${i+1}. ${c.campaign_name}\n`;
        txt += `   ${c.category||''}${c.send_date ? ' Â· ' + c.send_date : ''}${c.emails_sent ? ' Â· ' + Number(c.emails_sent).toLocaleString() + ' sent' : ''}\n`;
        txt += `   Open: ${p(c.open_rate)}${d(c.open_rate, catOpen)} | Click: ${p(c.click_rate)} | CTOR: ${p(c.click_to_open_rate)}\n`;
        if (c.subject_line) txt += `   Subject: "${c.subject_line}"\n`;
        if (c.notes) txt += `   Notes: ${c.notes}\n`;
        txt += '\n';
    });
    if (tests.length) {
        txt += `A/B TESTS\n${hr(30)}\n`;
        tests.forEach(t => {
            const aw = autoDetectWinner(t);
            const ss = calcStatSig(t);
            txt += `â€¢ ${t.test_name} (${t.element_tested||'â€”'})\n`;
            if (t.variant_a_content || t.variant_a_name) txt += `  A: ${t.variant_a_content || t.variant_a_name}\n`;
            if (t.variant_b_content || t.variant_b_name) txt += `  B: ${t.variant_b_content || t.variant_b_name}\n`;
            txt += `  Result: ${aw.pick === 'A' ? 'Variant A' : aw.pick === 'B' ? 'Variant B' : 'No clear winner'}`;
            if (aw.metric && aw.pick !== 'N') txt += ` (+${(aw.diff*100).toFixed(2)}pp on ${aw.metric})`;
            if (ss) txt += ` | Stat sig: ${ss.significant ? 'Yes' : 'No'}`;
            txt += '\n';
            if (t.winner_notes) txt += `  Learning: ${t.winner_notes}\n`;
            txt += '\n';
        });
    }
    return txt;
}

function copyReportText() {
    navigator.clipboard.writeText(window._reportFullText || '');
    const btn = event.target; btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy full report', 2000);
}

function copySlackSnippet() {
    navigator.clipboard.writeText(window._reportSlackText || '');
    const btn = event.target; btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Slack snippet', 2000);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadDashboard();

// â”€â”€ PRODUCT UPDATES (Coda) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _puAllRows = [];

async function loadProductUpdates() {
    const btn  = document.getElementById('pu-refresh-btn');
    const meta = document.getElementById('pu-meta');
    const body = document.getElementById('pu-body');
    btn.textContent = 'â†» Loadingâ€¦';
    btn.disabled = true;
    body.innerHTML = `<tr><td colspan="8" class="empty">Fetching from Codaâ€¦</td></tr>`;

    try {
        let rows = [], pageToken = null;
        do {
            const url = `https://coda.io/apis/v1/docs/${PU_CODA_DOC}/tables/${PU_CODA_TABLE}/rows?valueFormat=simpleWithArrays&limit=100`
                + (pageToken ? `&pageToken=${encodeURIComponent(pageToken)}` : '');
            const res  = await fetch(url, { headers: { Authorization: `Bearer ${PU_CODA_KEY}` } });
            if (!res.ok) throw new Error(`Coda API error ${res.status}`);
            const json = await res.json();
            rows       = rows.concat(json.items || []);
            pageToken  = json.nextPageToken || null;
        } while (pageToken);

        // Sort by "Submitted on" date descending (newest first)
        _puAllRows = rows.sort((a, b) => {
            const da = new Date(a.values['c-koliBeyLKS'] || 0).getTime();
            const db = new Date(b.values['c-koliBeyLKS'] || 0).getTime();
            return db - da;
        });
        meta.textContent = `${_puAllRows.length} submissions Â· updated ${new Date().toLocaleTimeString()}`;
        renderProductUpdates();
    } catch (err) {
        body.innerHTML = `<tr><td colspan="8" class="empty" style="color:#fca5a5;">Error: ${err.message}</td></tr>`;
    } finally {
        btn.textContent = 'â†» Refresh';
        btn.disabled = false;
    }
}

function puTypeBadge(type) {
    if (!type) return '<span class="pu-type pu-type-other">â€”</span>';
    const t = type.toLowerCase();
    if (t.includes('new feature'))          return `<span class="pu-type pu-type-new">New Feature</span>`;
    if (t.includes('existing') || t.includes('improvement')) return `<span class="pu-type pu-type-existing">Improvement</span>`;
    if (t.includes('pricing'))              return `<span class="pu-type pu-type-pricing">Pricing</span>`;
    if (t.includes('billing'))              return `<span class="pu-type pu-type-billing">Billing</span>`;
    return `<span class="pu-type pu-type-other">${type}</span>`;
}

function puStageBadge(stage) {
    if (!stage) return '<span class="pu-stage pu-stage-other">â€”</span>';
    const s = stage.toLowerCase();
    if (s.includes('general availability') || s === 'ga') return `<span class="pu-stage pu-stage-ga">GA</span>`;
    if (s.includes('closed beta') || s.includes('beta')) return `<span class="pu-stage pu-stage-beta">Beta</span>`;
    if (s.includes('build'))                              return `<span class="pu-stage pu-stage-build">In Build</span>`;
    if (s.includes('early'))                              return `<span class="pu-stage pu-stage-early">Early Access</span>`;
    return `<span class="pu-stage pu-stage-other">${stage}</span>`;
}

function puUIBadge(val) {
    if (!val) return '<span class="pu-ui-none">â€”</span>';
    const v = val.toLowerCase();
    if (v.includes('full'))    return `<span class="pu-ui-full">Full</span>`;
    if (v.includes('partial')) return `<span class="pu-ui-partial">Partial</span>`;
    if (v.includes('no'))      return `<span class="pu-ui-none">None</span>`;
    return `<span class="pu-ui-none">${val}</span>`;
}

function puFmtDate(iso) {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    return isNaN(d) ? iso : d.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
}

function renderRecentUpdates() {
    const recent = _puAllRows.slice(0, 10);
    const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    document.getElementById('pu-recent').innerHTML = recent.map((row, i) => {
        const v        = row.values;
        const name     = v['c-6jbOLJ-JMT'] || 'â€”';
        const type     = v['c-Oy8GigRO4V'] || '';
        const stage    = v['c-m_L22ZVzvr'] || '';
        const team     = v['c-D0GNHZ5BX3'] || 'â€”';
        const betaDate = v['c-NVAGx6DJ8x'] || '';
        const gaDate   = v['c-CrBT48ejwj'] || '';
        const uiChange = v['c-l6B-npdt4I'] || '';
        const subDate  = v['c-koliBeyLKS'] || '';
        const isNew    = subDate && new Date(subDate).getTime() > sevenDaysAgo;
        return `<div class="pu-recent-card${isNew ? ' is-new' : ''}" onclick="openPUModal(${i}, true)">
            <span>${isNew ? '<span class="pu-new-pill">Â·</span>' : ''}</span>
            <span class="pu-recent-name">${name}</span>
            <span>${puTypeBadge(type)}</span>
            <span>${puStageBadge(stage)}</span>
            <span class="pu-recent-meta" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${team}</span>
            <span class="pu-recent-meta">${puFmtDate(betaDate)}</span>
            <span class="pu-recent-meta">${puFmtDate(gaDate)}</span>
            <span>${puUIBadge(uiChange)}</span>
            <span class="pu-recent-meta">${puFmtDate(subDate)}</span>
        </div>`;
    }).join('');
}

function renderProductUpdates() {
    renderRecentUpdates();
    const typeFilter  = document.getElementById('pu-filter-type').value.toLowerCase();
    const stageFilter = document.getElementById('pu-filter-stage').value.toLowerCase();

    const filtered = _puAllRows.filter(r => {
        const v = r.values;
        const type  = (v['c-Oy8GigRO4V'] || '').toLowerCase();
        const stage = (v['c-m_L22ZVzvr'] || '').toLowerCase();
        if (typeFilter  && !type.includes(typeFilter.replace('existing feature improvement','existing').replace('new feature','new')))  return false;
        if (stageFilter && !stage.includes(stageFilter.replace('general availability','general'))) return false;
        return true;
    });

    if (!filtered.length) {
        document.getElementById('pu-body').innerHTML = `<tr><td colspan="8" class="empty">No results</td></tr>`;
        return;
    }

    document.getElementById('pu-body').innerHTML = filtered.map((row, i) => {
        const v       = row.values;
        const name    = v['c-6jbOLJ-JMT']  || 'â€”';
        const type    = v['c-Oy8GigRO4V']  || '';
        const stage   = v['c-m_L22ZVzvr']  || '';
        const team    = v['c-D0GNHZ5BX3']  || 'â€”';
        const betaDate= v['c-NVAGx6DJ8x']  || '';
        const gaDate  = v['c-CrBT48ejwj']  || '';
        const uiChange= v['c-l6B-npdt4I']  || '';
        const subDate = v['c-koliBeyLKS']  || '';
        return `<tr class="clickable" onclick="openPUModal(${i})">
            <td><strong>${name}</strong></td>
            <td>${puTypeBadge(type)}</td>
            <td>${puStageBadge(stage)}</td>
            <td style="color:var(--muted);font-size:12px;">${team}</td>
            <td>${puFmtDate(betaDate)}</td>
            <td>${puFmtDate(gaDate)}</td>
            <td>${puUIBadge(uiChange)}</td>
            <td style="color:var(--muted);font-size:12px;">${puFmtDate(subDate)}</td>
        </tr>`;
    }).join('');

    // Store filtered for modal navigation
    window._puFiltered = filtered;
}

function openPUModal(idx, fromAll) {
    const row = fromAll ? _puAllRows[idx] : (window._puFiltered || _puAllRows)[idx];
    if (!row) return;
    const v = row.values;

    document.getElementById('pu-modal-title').textContent = v['c-6jbOLJ-JMT'] || 'Product Update';

    const detail = (label, value) => value ? `
        <div class="pu-detail-item"><div class="label">${label}</div><div class="value">${value}</div></div>` : '';

    document.getElementById('pu-modal-body').innerHTML = `
        ${v['c-PtGFw8EBih'] ? `<div class="pu-description">${v['c-PtGFw8EBih']}</div>` : ''}
        <div class="pu-detail-row">
            ${detail('Update Type',    v['c-Oy8GigRO4V'])}
            ${detail('Current Stage',  v['c-m_L22ZVzvr'])}
            ${detail('Launch Tier',    v['c-julXfvb5P6'])}
            ${detail('Product Area',   v['c--J4n89CCMn'])}
        </div>
        <div class="pu-detail-row">
            ${detail('Team / Workstream', v['c-D0GNHZ5BX3'])}
            ${detail('R&D POC',           v['c-bvZsuK6Cax'])}
            ${detail('Submitted by',      v['c-c_fjUh1xZ-'])}
            ${detail('Migration Required?', v['c-q9apW2mDJd'])}
        </div>
        <div class="pu-detail-row">
            ${detail('Beta Start Date', puFmtDate(v['c-NVAGx6DJ8x']))}
            ${detail('MA Date',         puFmtDate(v['c-YI2-0SCRfE']))}
            ${detail('GA Date',         puFmtDate(v['c-CrBT48ejwj']))}
            ${detail('UI Change',       v['c-l6B-npdt4I'])}
        </div>
        ${v['c-1rAAFxdGhS'] ? `<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:6px;">Additional Notes</div><div class="pu-description">${v['c-1rAAFxdGhS']}</div></div>` : ''}
        <div style="text-align:right;margin-top:4px;">
            <a href="${row.browserLink}" target="_blank" style="font-size:12px;color:var(--brand);">Open in Coda â†—</a>
        </div>
    `;

    document.getElementById('pu-modal-overlay').style.display = 'block';
    document.getElementById('pu-modal').style.display = 'block';
}

function closePUModal() {
    document.getElementById('pu-modal-overlay').style.display = 'none';
    document.getElementById('pu-modal').style.display = 'none';
}

// â”€â”€ SERIES REPLIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _srSources = [];      // search results (unique source messages)
let _srReplies = [];      // replies for selected source
let _srSourceCtx = '';    // selected source context string

async function searchSeries() {
    const query = document.getElementById('sr-query').value.trim();
    if (!query || query.length < 2) {
        document.getElementById('sr-search-status').textContent = 'Please enter at least 2 characters.';
        return;
    }

    const days = parseInt(document.getElementById('sr-recency').value, 10) || 0;
    const since = days ? Math.floor(Date.now() / 1000) - days * 86400 : null;

    const btn = document.getElementById('sr-search-btn');
    btn.disabled = true;
    btn.textContent = 'Searchingâ€¦';
    document.getElementById('sr-search-status').textContent = '';
    document.getElementById('sr-sources').style.display = 'none';
    document.getElementById('sr-replies-panel').style.display = 'none';

    try {
        const res = await fetch('/api/intercom-series', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'search', query, since }),
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Search failed');

        _srSources = data.sources || [];
        document.getElementById('sr-search-status').textContent =
            `Found ${_srSources.length} unique message${_srSources.length !== 1 ? 's' : ''} (from ${(data.totalConversations || 0).toLocaleString()} conversations).`;
        renderSRSources();
    } catch (err) {
        document.getElementById('sr-search-status').textContent = 'Error: ' + err.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Search';
    }
}

function renderSRSources() {
    const list = document.getElementById('sr-sources-list');
    if (!_srSources.length) {
        list.innerHTML = '<div class="card" style="padding:14px;color:var(--muted);font-size:13px;">No messages found. Try a different keyword.</div>';
        document.getElementById('sr-sources').style.display = 'block';
        return;
    }

    list.innerHTML = _srSources.map((s, i) => {
        const subj = s.subject || s.bodySnippet || '(no subject)';
        const display = subj.length > 120 ? subj.slice(0, 120) + 'â€¦' : subj;
        return `<div class="card" style="padding:14px;cursor:pointer;margin-bottom:8px;transition:border-color 0.15s;" onmouseenter="this.style.borderColor='var(--brand)'" onmouseleave="this.style.borderColor='var(--border)'" onclick="loadSRReplies(${i})">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
                <div style="flex:1;min-width:0;">
                    <div style="font-size:13px;font-weight:600;margin-bottom:3px;">${escHtml(display)}</div>
                    <div style="font-size:12px;color:var(--muted);">From: ${escHtml(s.senderName)} &bull; ID: ${s.sourceId}</div>
                </div>
                <div style="flex-shrink:0;text-align:right;">
                    <div style="font-size:18px;font-weight:700;color:var(--brand);">${s.replyCount}</div>
                    <div style="font-size:11px;color:var(--muted);">repl${s.replyCount !== 1 ? 'ies' : 'y'}</div>
                </div>
            </div>
        </div>`;
    }).join('');
    document.getElementById('sr-sources').style.display = 'block';
}

async function loadSRReplies(idx) {
    const src = _srSources[idx];
    if (!src) return;

    document.getElementById('sr-sources').style.display = 'none';
    document.getElementById('sr-replies-panel').style.display = 'block';

    const subj = src.subject || src.bodySnippet || '(no subject)';
    document.getElementById('sr-selected-subject').textContent = subj.length > 100 ? subj.slice(0, 100) + 'â€¦' : subj;
    document.getElementById('sr-selected-meta').textContent = `From: ${src.senderName} Â· Loading repliesâ€¦`;

    const tbody = document.getElementById('sr-replies-body');
    tbody.innerHTML = '<tr><td colspan="3" style="padding:20px;text-align:center;color:var(--muted);">Fetching repliesâ€¦</td></tr>';
    document.getElementById('sr-analysis-out').style.display = 'none';
    document.getElementById('sr-question').value = '';

    _srSourceCtx = src.subject ? `Subject: "${src.subject}" Â· Sender: ${src.senderName}` : `Sender: ${src.senderName} Â· Message: ${src.bodySnippet}`;

    try {
        const res = await fetch('/api/intercom-series', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'replies', sourceId: src.sourceId }),
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Failed to load replies');

        _srReplies = data.replies || [];
        document.getElementById('sr-selected-meta').textContent =
            `From: ${src.senderName} Â· ${_srReplies.length} repl${_srReplies.length !== 1 ? 'ies' : 'y'} (${data.total} total conversations)`;

        if (!_srReplies.length) {
            tbody.innerHTML = '<tr><td colspan="3" style="padding:20px;text-align:center;color:var(--muted);">No customer replies found for this message.</td></tr>';
            return;
        }

        tbody.innerHTML = _srReplies.map(r => {
            const date = r.replyDate ? new Date(r.replyDate * 1000).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'â€”';
            const isTruncated = r.replyText.length > 280;
            const text = isTruncated ? r.replyText.slice(0, 280) + 'â€¦' : r.replyText;
            const hoverAttrs = isTruncated
                ? `onmouseenter="srShowTooltip(this,event)" onmouseleave="srHideTooltip()" data-full="${escHtml(r.replyText)}" style="font-size:13px;color:var(--text);cursor:help;"`
                : `style="font-size:13px;color:var(--text);"`;
            return `<tr>
                <td style="white-space:nowrap;vertical-align:top;">
                    <div style="font-weight:600;font-size:13px;">${escHtml(r.contactName)}</div>
                    ${r.contactEmail ? `<div style="font-size:11px;color:var(--muted);">${escHtml(r.contactEmail)}</div>` : ''}
                </td>
                <td ${hoverAttrs}>${escHtml(text)}</td>
                <td style="white-space:nowrap;font-size:12px;color:var(--muted);">${date}</td>
            </tr>`;
        }).join('');
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="3" style="padding:14px;color:#fca5a5;">Error: ${escHtml(err.message)}</td></tr>`;
    }
}

function closeSRPanel() {
    document.getElementById('sr-replies-panel').style.display = 'none';
    document.getElementById('sr-sources').style.display = _srSources.length ? 'block' : 'none';
    _srReplies = [];
}

async function analyseSeriesReplies() {
    const question = document.getElementById('sr-question').value.trim();
    if (!question) {
        alert('Please enter a question first.');
        return;
    }
    if (!_srReplies.length) {
        alert('No replies loaded to analyse.');
        return;
    }

    const btn = document.getElementById('sr-analyse-btn');
    btn.disabled = true;
    btn.textContent = 'Analysingâ€¦';

    const outEl = document.getElementById('sr-analysis-out');
    outEl.style.display = 'block';
    outEl.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:8px 0;">Claude is reading the repliesâ€¦</div>';

    try {
        const res = await fetch('/api/claude-series-analysis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                replies: _srReplies,
                question,
                sourceContext: _srSourceCtx,
            }),
        });
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || 'Analysis failed');

        outEl.innerHTML = `<div style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:14px 16px;">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--brand);margin-bottom:8px;">Claude's Analysis</div>
            <div style="font-size:13px;line-height:1.7;white-space:pre-wrap;">${escHtml(data.analysis)}</div>
        </div>`;
    } catch (err) {
        outEl.innerHTML = `<div class="alert alert-error">${escHtml(err.message)}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Analyse Replies';
    }
}

function escHtml(str) {
    return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

let _srTooltipTimer = null;

function srShowTooltip(el, event) {
    clearTimeout(_srTooltipTimer);
    const x = event.clientX;
    const y = event.clientY;
    _srTooltipTimer = setTimeout(() => {
        const full = el.getAttribute('data-full')
            .replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
        const tip = document.getElementById('sr-tooltip');
        tip.textContent = full;
        tip.style.display = 'block';
        const tipW = 420;
        tip.style.left = Math.min(x + 14, window.innerWidth - tipW - 16) + 'px';
        tip.style.top = (y + 18) + 'px';
    }, 2000);
}

function srHideTooltip() {
    clearTimeout(_srTooltipTimer);
    document.getElementById('sr-tooltip').style.display = 'none';
}
</script>
</body>
</html>
